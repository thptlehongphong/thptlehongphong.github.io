<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=1100"><title>Admin 3 - Xử Lý Vi Phạm</title><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet"><script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script><style>:root{--primary:#6366f1;--danger:#ef4444;--glass:rgba(255, 255, 255, 0.05);--glass-border:rgba(255, 255, 255, 0.1)}*{margin:0;padding:0;box-sizing:border-box;font-family:Outfit,sans-serif}body{background:#0f172a;color:#fff;min-height:100vh;padding:20px 5%}.container{max-width:600px;margin:0 auto}.card{background:var(--glass);border:1px solid var(--glass-border);border-radius:24px;padding:25px;margin-bottom:20px}.search-box{display:flex;gap:10px;margin-bottom:20px}input[type=text]{flex:1;padding:14px;border-radius:12px;border:1px solid var(--glass-border);background:rgba(255,255,255,.03);color:#fff;outline:0}.btn{padding:12px 20px;border-radius:12px;border:none;font-weight:600;cursor:pointer;transition:.3s}.btn-primary{background:var(--primary);color:#fff}.btn-danger{background:var(--danger);color:#fff;width:100%;margin-top:15px}.student-result{display:none;animation:fadeIn .5s}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.student-profile{display:flex;align-items:center;gap:20px;margin-bottom:25px}.profile-img{width:100px;height:100px;border-radius:15px;object-fit:cover;border:2px solid var(--primary)}.violation-options{display:grid;grid-template-columns:1fr 1fr;gap:12px}.v-item{background:rgba(255,255,255,.03);border:1px solid var(--glass-border);padding:12px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:.2s;user-select:none}.v-item.active{border-color:#6366f1;background:#fff;color:#0f172a;font-weight:700}.v-item input{pointer-events:none}textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--glass-border);background:rgba(255,255,255,.03);color:#fff;outline:0;margin-top:15px;min-height:80px}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal-content{max-width:90%;max-height:90%;border-radius:20px;border:2px solid var(--primary)}</style></head><body><div class="container"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3>Admin 3 - Ghi Nhận Vi Phạm</h3><button style="background:0 0;border:none;color:#fff;cursor:pointer" onclick="logout()">Thoát</button></div><div class="card"><div class="search-box"><input type="text" id="searchId" placeholder="Nhập MSHS để tìm kiếm..."> <button class="btn btn-primary" onclick="searchStudent()">Tìm</button></div><div id="studentResult" class="student-result"><div class="student-profile"><img id="resImg" class="profile-img" src="" alt="" onclick="showImg(this.src)" style="cursor:zoom-in"><div><h2 id="resName"></h2><p id="resInfo" style="color:#94a3b8;font-size:.9rem"></p></div></div><div style="border-top:1px solid var(--glass-border);padding-top:20px"><p style="margin-bottom:15px;font-weight:600">Chọn các lỗi vi phạm:</p><div class="violation-options" id="violationOptionsContainer"></div><textarea id="violationNote" placeholder="Ghi chú chi tiết thêm (nếu có)..." style="margin-top:15px;min-height:80px"></textarea> <button class="btn btn-danger" onclick="submitViolation()">Xác Nhận Vi Phạm</button></div></div><div id="noMatch" style="display:none;text-align:center;color:var(--danger);padding:20px">Không tìm thấy học sinh với mã số này!</div></div></div><div id="imageModal" class="modal" onclick="closeImg()"><img class="modal-content" id="imgFull"></div><script src="firebase.config.js"></script><script>let currentRole=sessionStorage.getItem("kyluat_role"),violationTypesConf=("admin3"!==currentRole&&"admin0"!==currentRole&&(window.location.href="../index.html"),{});function renderViolationOptions(){let n=document.getElementById("violationOptionsContainer");n.innerHTML="",0===Object.keys(violationTypesConf).length?n.innerHTML='<p style="color:#94a3b8; grid-column:span 2;">Chưa có danh mục lỗi nào được cấu hình.</p>':Object.entries(violationTypesConf).forEach(([,t])=>{var e=document.createElement("div");e.className="v-item",e.onclick=function(){toggleV(this)},e.dataset.points=t.points,e.innerHTML=`
                    <input type="checkbox" value="${t.name}">
                    <span>${t.name} <small style="color:#f87171">(-${t.points})</small></span>
                `,n.appendChild(e)})}function showImg(t){var e;t&&(e=document.getElementById("imageModal"),document.getElementById("imgFull").src=t,e.style.display="flex")}function closeImg(){document.getElementById("imageModal").style.display="none"}rootRef.child("Settings").on("value",t=>{var e=t.val()&&t.val().Config||{status:"active"},n=(new Date).toISOString().split("T")[0],n=e.expiryDate&&n>e.expiryDate,o="locked"===e.status;(n||o)&&"admin0"!==currentRole&&(alert(e.message||"Hệ thống đã bị khóa hoặc hết hạn!"),window.location.href="../index.html"),violationTypesConf=t.val()&&t.val().ViolationTypes||{},renderViolationOptions()});let currentStudent=null;async function searchStudent(){var t,e=document.getElementById("searchId").value.trim().toUpperCase();e&&((t=await rootRef.child("Students").child(e).once("value")).exists()?(currentStudent={studentId:e,...t.val()},document.getElementById("resImg").src=currentStudent.photo,document.getElementById("resName").textContent=currentStudent.name,document.getElementById("resInfo").textContent=`Lớp: ${currentStudent.class} | Ngày sinh: `+formatDate(currentStudent.dob),document.getElementById("studentResult").style.display="block",document.getElementById("noMatch").style.display="none"):(currentStudent=null,document.getElementById("studentResult").style.display="none",document.getElementById("noMatch").style.display="block"))}function toggleV(t){var e=t.querySelector("input");e.checked=!e.checked,t.classList.toggle("active",e.checked)}async function submitViolation(){if(currentStudent){var e=document.querySelectorAll(".v-item.active");let n=[],o=0;if(e.forEach(t=>{var e=t.querySelector("input");n.push(e.value),o+=parseInt(t.dataset.points)||1}),0===n.length)alert("Vui lòng chọn ít nhất 1 lỗi vi phạm!");else{e=document.getElementById("violationNote").value.trim();let t=n.join(", ");e&&(t+=` (Chi tiết: ${e})`);e={studentId:currentStudent.studentId,studentName:currentStudent.name,studentClass:currentStudent.class,studentPhoto:currentStudent.photo,violationType:t,totalPoints:o,timestamp:Date.now(),recordedBy:sessionStorage.getItem("kyluat_id")};await rootRef.child("Violations").push(e),await rootRef.child("Students").child(currentStudent.studentId).transaction(t=>(t&&(t.stars=(t.stars||0)-o),t)),alert(`Đã ghi nhận vi phạm và trừ ${o} sao!`),location.reload()}}}function formatDate(t){t=new Date(t);return`${t.getDate()}/${t.getMonth()+1}/`+t.getFullYear()}function logout(){sessionStorage.clear(),window.location.href="../index.html"}</script></body></html>