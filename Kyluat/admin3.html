<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=1100"><title>Admin 3 - Xử Lý Vi Phạm</title><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet"><script src="https://unpkg.com/html5-qrcode"></script><script src="../student_data.js"></script><script type="module" src="../firebase-backend.js"></script><style>:root{--primary:#6366f1;--danger:#ef4444;--glass:rgba(255, 255, 255, 0.05);--glass-border:rgba(255, 255, 255, 0.1)}*{margin:0;padding:0;box-sizing:border-box;font-family:Outfit,sans-serif}body{background:#0f172a;color:#fff;min-height:100vh;padding:20px 5%}.container{max-width:600px;margin:0 auto}.card{background:var(--glass);border:1px solid var(--glass-border);border-radius:24px;padding:25px;margin-bottom:20px}.search-box{display:flex;gap:10px;margin-bottom:20px}input[type=text]{flex:1;padding:14px;border-radius:12px;border:1px solid var(--glass-border);background:rgba(255,255,255,.03);color:#fff;outline:0}.btn{padding:12px 20px;border-radius:12px;border:none;font-weight:600;cursor:pointer;transition:.3s}.btn-primary{background:var(--primary);color:#fff}.btn-danger{background:var(--danger);color:#fff;width:100%;margin-top:15px}.student-result{display:none;animation:fadeIn .5s}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.student-profile{display:flex;align-items:center;gap:20px;margin-bottom:25px}.profile-img{width:100px;height:100px;border-radius:15px;object-fit:cover;border:2px solid var(--primary)}.violation-options{display:grid;grid-template-columns:1fr 1fr;gap:12px}.v-item{background:rgba(255,255,255,.03);border:1px solid var(--glass-border);padding:12px;border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:.2s;user-select:none}.v-item.active{border-color:#6366f1;background:#fff;color:#0f172a;font-weight:700}.v-item input{pointer-events:none}textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--glass-border);background:rgba(255,255,255,.03);color:#fff;outline:0;margin-top:15px;min-height:80px}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal-content{max-width:90%;max-height:90%;border-radius:20px;border:2px solid var(--primary)}.notify-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,.9);z-index:10000;justify-content:center;align-items:center;backdrop-filter:blur(8px)}.notify-content{background:#1e293b;border:1px solid var(--glass-border);padding:30px;border-radius:24px;max-width:400px;width:90%;text-align:center;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);animation:modalPop .2s ease-out}@keyframes modalPop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}.notify-icon{font-size:40px;margin-bottom:15px;display:block}.notify-title{font-size:1.25rem;font-weight:700;margin-bottom:10px}.notify-msg{color:#cbd5e1;line-height:1.5;margin-bottom:25px;font-size:.95rem}.notify-error .notify-title{color:#ef4444}.notify-success .notify-title{color:#10b981}</style></head><body><div class="container"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3>Admin 3 - Ghi Nhận Vi Phạm</h3><button style="background:0 0;border:none;color:#fff;cursor:pointer" onclick="logout()">Thoát</button></div><div class="card"><div class="search-box"><input type="text" id="searchId" placeholder="Nhập MSHS để tìm kiếm..."> <button class="btn btn-primary" onclick="searchStudent()">Tìm</button> <button class="btn" style="background:#818cf8;color:#fff;display:inline-flex;align-items:center;gap:5px" onclick="toggleScanner()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg> Quét QR</button></div><div id="reader" style="width:100%;margin-bottom:20px;border-radius:12px;overflow:hidden;display:none"></div><div id="studentResult" class="student-result"><div class="student-profile"><img id="resImg" class="profile-img" src="" alt="" onclick="showImg(this.src)" style="cursor:zoom-in"><div><h2 id="resName"></h2><p id="resInfo" style="color:#94a3b8;font-size:.9rem"></p></div></div><div style="border-top:1px solid var(--glass-border);padding-top:20px"><p style="margin-bottom:15px;font-weight:600">Chọn các lỗi vi phạm:</p><div class="violation-options" id="violationOptionsContainer"></div><textarea id="violationNote" placeholder="Ghi chú chi tiết thêm (nếu có)..." style="margin-top:15px;min-height:80px"></textarea> <button class="btn btn-danger" onclick="submitViolation()">Xác Nhận Vi Phạm</button></div></div><div id="noMatch" style="display:none;text-align:center;color:var(--danger);padding:20px">Không tìm thấy học sinh với mã số này!</div></div></div><div id="imageModal" class="modal" onclick="closeImg()"><img class="modal-content" id="imgFull"></div><div id="notifyModal" class="notify-modal"><div class="notify-content" id="notifyContent"><span id="notifyIcon" class="notify-icon"></span><h3 id="notifyTitle" class="notify-title"></h3><p id="notifyMsg" class="notify-msg"></p><button type="button" class="btn btn-primary" onclick="closeNotify()">Đồng ý</button></div></div><script>let API_BASE="",currentRole=sessionStorage.getItem("kyluat_role"),violationTypesConf=("admin3"!==currentRole&&"admin0"!==currentRole&&(window.location.href="../index.html"),{});async function checkSystemStatus(){try{var t=await(await fetch(API_BASE+"/api/settings")).json(),e=(new Date).toISOString().split("T")[0],n=t.expiry_date&&e>t.expiry_date,o=!1===JSON.parse(t.permissions||'{"admin1":true,"admin2":true,"admin3":true,"admin4":true}')[currentRole];(n||o)&&"admin0"!==currentRole&&(showNotify("Thông báo hệ thống",o?"Quyền truy cập của bạn đã bị tạm khóa!":"Hệ thống đã hết thời hạn sử dụng!",!0),setTimeout(()=>window.location.href="../index.html",3e3)),violationTypesConf=JSON.parse(t.violationtypes||"{}"),renderViolationOptions()}catch(t){console.error(t)}}function startApp(){checkSystemStatus(),setInterval(checkSystemStatus,3e4)}function renderViolationOptions(){let n=document.getElementById("violationOptionsContainer");n.innerHTML="",0===Object.keys(violationTypesConf).length?n.innerHTML='<p style="color:#94a3b8; grid-column:span 2;">Chưa có danh mục lỗi nào.</p>':Object.entries(violationTypesConf).forEach(([,t])=>{var e=document.createElement("div");e.className="v-item",e.onclick=function(){toggleV(this)},e.dataset.points=t.points,e.innerHTML=`
                    <input type="checkbox" value="${t.name}">
                    <span>${t.name} <small style="color:#f87171">(-${Math.abs(t.points)})</small></span>
                `,n.appendChild(e)})}function showImg(t){t&&(document.getElementById("imgFull").src=t,document.getElementById("imageModal").style.display="flex")}function closeImg(){document.getElementById("imageModal").style.display="none"}function showNotify(t,e,n=!1){var o=document.getElementById("notifyModal"),i=document.getElementById("notifyContent"),a=document.getElementById("notifyIcon"),s=document.getElementById("notifyTitle"),l=document.getElementById("notifyMsg");i.className="notify-content "+(n?"notify-error":"notify-success"),a.innerText=n?"⚠️":"✅",s.innerText=t,l.innerText=e,o.style.display="flex"}function closeNotify(){document.getElementById("notifyModal").style.display="none"}window.firebaseBackendReady?startApp():window.addEventListener("firebaseBackendReady",startApp);let currentStudent=null,html5QrCode=null;function toggleScanner(){var t=document.getElementById("reader");"none"===t.style.display?(t.style.display="block",startScanner()):(stopScanner(),t.style.display="none")}async function startScanner(){html5QrCode=new Html5Qrcode("reader");try{await html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},async t=>{document.getElementById("searchId").value=t.trim().toUpperCase(),await searchStudent(),showNotify("QR Code","Đã nhận diện mã: "+t),toggleScanner()})}catch(t){showNotify("Lỗi Camera","Không thể truy cập camera!",!0),document.getElementById("reader").style.display="none"}}async function stopScanner(){if(html5QrCode)try{await html5QrCode.stop(),html5QrCode=null}catch(t){}}function renderStudentDataAdmin3(t){currentStudent=t,document.getElementById("resImg").src=`/api/students/${t.id}/photo`,document.getElementById("resImg").onerror=function(){this.src="/logo.png"},document.getElementById("resName").textContent=t.name,document.getElementById("resInfo").textContent=`Lớp: ${t.class_name||t.class} | ID: `+t.id,document.getElementById("studentResult").style.display="block",document.getElementById("noMatch").style.display="none"}async function searchStudent(){let e=document.getElementById("searchId").value.trim().toUpperCase();if(e)try{var t=localStorage.getItem("fb_mock_students_data");if(t)try{var n=JSON.parse(t).find(t=>t.id===e);n&&renderStudentDataAdmin3(n)}catch(t){}var o,i,a=await fetch(API_BASE+"/api/students/"+e);a.ok?((o=await a.json()).photo||"undefined"==typeof STATIC_STUDENTS||(i=STATIC_STUDENTS.find(t=>t.id===e))&&(o.photo=i.photo),renderStudentDataAdmin3(o)):(currentStudent=null,document.getElementById("studentResult").style.display="none",document.getElementById("noMatch").style.display="block")}catch(t){showNotify("Lỗi","Lỗi tìm kiếm học sinh!",!0)}}function toggleV(t){var e=t.querySelector("input");e.checked=!e.checked,t.classList.toggle("active",e.checked)}async function submitViolation(){if(currentStudent){var t=document.querySelectorAll(".v-item.active");let n=[],o=0;if(t.forEach(t=>{var e=t.querySelector("input");n.push(e.value),o+=Math.abs(parseInt(t.dataset.points))||1}),0===n.length)return showNotify("Thiếu thông tin","Vui lòng chọn ít nhất 1 lỗi vi phạm!",!0);t=document.getElementById("violationNote").value.trim(),t=n.join(", ")+(t?` (Chi tiết: ${t})`:""),t={student_id:currentStudent.id,type_name:t,points_change:-o,is_merit:!1,created_by:sessionStorage.getItem("kyluat_id")};try{(await fetch(API_BASE+"/api/history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok?(showNotify("Thành công",`Đã ghi nhận vi phạm và trừ ${o} sao!`),setTimeout(()=>location.reload(),2e3)):showNotify("Lỗi","Lỗi khi lưu vi phạm lên hệ thống bài!",!0)}catch(t){showNotify("Lỗi kết nối","Lỗi kết nối máy chủ!",!0)}}}function logout(){sessionStorage.clear(),window.location.href="../index.html"}</script></body></html>