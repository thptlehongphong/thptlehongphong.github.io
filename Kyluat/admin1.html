<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Admin 1 - Quáº£n LÃ½ Há»‡ Thá»‘ng</title><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet"><script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script><script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><style>:root{--primary:#6366f1;--glass:rgba(255, 255, 255, 0.05);--glass-border:rgba(255, 255, 255, 0.1);--danger:#ef4444}*{margin:0;padding:0;box-sizing:border-box;font-family:Outfit,sans-serif}body{background:#0f172a;color:#fff;min-height:100vh;padding:40px 5%}.container{max-width:800px;margin:0 auto}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:40px}.card{background:var(--glass);border:1px solid var(--glass-border);border-radius:20px;padding:30px;margin-bottom:30px}.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}@media (max-width:600px){.form-grid{grid-template-columns:1fr}}input,select{width:100%;padding:12px;border-radius:10px;border:1px solid var(--glass-border);background:#1e293b;color:#fff;outline:0}select option{background-color:#0f172a;color:#fff}.btn{padding:12px 24px;border-radius:10px;border:none;font-weight:600;cursor:pointer;transition:.3s}.btn-primary{background:var(--primary);color:#fff;width:100%}.btn-danger{background:rgba(239,68,68,.1);color:var(--danger);border:1px solid rgba(239,68,68,.2);font-size:.75rem;padding:6px 10px;border-radius:6px}.btn-success{background:#10b981;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:.8rem;cursor:pointer}table{width:100%;border-collapse:collapse;margin-top:10px}th{text-align:left;padding:12px 15px;color:#94a3b8;border-bottom:1px solid var(--glass-border);font-size:.75rem;text-transform:uppercase;letter-spacing:.05em}td{padding:12px 15px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}.student-info{display:flex;align-items:center;gap:12px}.student-img{width:38px;height:38px;border-radius:10px;object-fit:cover;border:1px solid var(--glass-border);cursor:zoom-in;box-shadow:0 4px 6px -1px rgba(0,0,0,.1)}.violation-tag{padding:4px 10px;border-radius:6px;font-size:.75rem;background:rgba(239,68,68,.1);color:var(--danger);border:1px solid rgba(239,68,68,.15);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;vertical-align:middle;font-weight:500}.btn-more{color:var(--primary);font-size:.7rem;cursor:pointer;text-decoration:none;margin-left:6px;font-weight:700;opacity:.8}.btn-more:hover{opacity:1;text-decoration:underline}.edit-input{background:#1e293b;border:1px solid var(--primary);color:#fff;padding:8px;border-radius:8px;width:100%;font-size:.8rem;outline:0}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,.85);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(10px)}.modal-content-text{background:linear-gradient(135deg,#1e293b 0,#0f172a 100%);padding:32px;border-radius:28px;max-width:480px;width:90%;max-height:70vh;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,.1);box-shadow:0 25px 50px -12px rgba(0,0,0,.7);animation:modalSlideUp .4s cubic-bezier(.4,0,.2,1)}@keyframes modalSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.modal-content-text h3{font-size:1.25rem;font-weight:700;color:#6366f1;margin-bottom:20px;display:flex;align-items:center;gap:10px}#fullDetailText{line-height:1.7;color:#cbd5e1;font-size:1.05rem;text-align:left;overflow-y:auto;padding-right:8px;margin-bottom:24px;white-space:pre-wrap;word-break:break-word}.btn-close-modal{background:var(--primary);color:#fff;border:none;padding:12px 0;border-radius:14px;font-weight:600;cursor:pointer;width:100%;transition:.3s}#fullDetailText::-webkit-scrollbar{width:4px}#fullDetailText::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:10px}.modal-img-content{max-width:90%;max-height:90%;border-radius:20px;border:2px solid var(--primary)}</style></head><body><div class="container" style="max-width:1200px"><div class="header"><div><h1 style="font-size:2.5rem;letter-spacing:-1px">Admin 1 <span style="color:var(--primary);font-size:1.2rem;font-weight:400">/ Quáº£n trá»‹ há»‡ thá»‘ng</span></h1><p style="color:#94a3b8;margin-top:5px">Quáº£n lÃ½ tÃ i khoáº£n, há»c sinh vÃ  lá»‹ch sá»­ vi pháº¡m</p></div><button class="btn" style="background:rgba(255,255,255,.05);border:1px solid var(--glass-border);color:#fff" onclick="logout()">ÄÄƒng xuáº¥t</button></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:40px"><div class="card" style="margin-bottom:0"><h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px"><span>ğŸ‘¤</span> Táº¡o TÃ i Khoáº£n</h3><form id="createAdminForm"><div class="form-grid" style="grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px"><div><label style="font-size:.75rem;color:#94a3b8">ID</label> <input type="text" id="adminId" placeholder="ID" required></div><div><label style="font-size:.75rem;color:#94a3b8">Máº­t kháº©u</label> <input type="password" id="adminPass" placeholder="â€¢â€¢â€¢â€¢" required></div></div><div class="form-grid" style="grid-template-columns:1fr auto;gap:12px;margin-bottom:0"><div><select id="adminRole"><option value="admin2">Admin 2 (Nháº­p liá»‡u)</option><option value="admin3">Admin 3 (Cá» Ä‘á»)</option><option value="admin4">Admin 4 (Khen thÆ°á»Ÿng)</option></select></div><button type="submit" class="btn btn-primary" style="padding:0 20px">Táº¡o</button></div></form><div style="max-height:120px;overflow-y:auto;margin-top:15px;border-top:1px solid var(--glass-border);padding-top:10px"><table style="margin-top:0;width:100%;border-collapse:collapse"><thead><tr style="text-align:left;font-size:.7rem;color:#94a3b8;border-bottom:1px solid var(--glass-border)"><th style="padding:5px">ID</th><th style="padding:5px">Máº­t kháº©u</th><th style="padding:5px">Chá»©c nÄƒng</th><th style="padding:5px;text-align:right">XÃ³a</th></tr></thead><tbody id="adminTableBody"></tbody></table></div></div><div class="card" style="margin-bottom:0"><h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px"><span>ğŸ«</span> Quáº£n LÃ½ Lá»›p Há»c</h3><form id="createClassForm" style="display:flex;gap:10px;margin-bottom:15px"><input type="text" id="className" placeholder="TÃªn lá»›p (VD: 10A1)" required> <button type="submit" class="btn btn-primary" style="width:auto;padding:0 20px">ThÃªm</button></form><div style="max-height:150px;overflow-y:auto;background:rgba(0,0,0,.1);border-radius:12px;padding:10px"><div id="classListArea" style="display:flex;flex-wrap:wrap;gap:8px"></div></div></div></div><div class="card" style="margin-bottom:30px"><h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px"><span>âš™ï¸</span> Cáº¥u HÃ¬nh Há»‡ Thá»‘ng</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:40px"><div><h4 style="margin-bottom:10px;color:var(--primary)">â­ Äiá»ƒm Ban Äáº§u</h4><p style="font-size:.8rem;color:#94a3b8;margin-bottom:10px">Thiáº¿t láº­p sá»‘ sao máº·c Ä‘á»‹nh cho há»c sinh.</p><div style="display:flex;gap:10px"><input type="number" id="defaultStarInput" placeholder="VD: 10" style="width:100px"> <button class="btn btn-primary" style="width:auto" onclick="saveDefaultStars()">LÆ°u máº·c Ä‘á»‹nh</button></div><div style="display:flex;flex-direction:column;gap:8px;margin-top:10px"><button class="btn" style="background:rgba(245,158,11,.1);color:#f59e0b;border:1px solid rgba(245,158,11,.2);font-size:.8rem;width:100%;text-align:left" onclick="applyDefaultToAll()">âš ï¸ Reset toÃ n bá»™ há»c sinh vá» Ä‘iá»ƒm nÃ y</button> <button class="btn" style="background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.2);font-size:.8rem;width:100%;text-align:left" onclick="deleteAllViolations()">ğŸ—‘ï¸ XÃ³a sáº¡ch toÃ n bá»™ lá»‹ch sá»­ vi pháº¡m</button></div></div><div><div style="margin-bottom:20px"><h4 style="margin-bottom:10px;color:var(--danger)">ğŸ›‘ Danh má»¥c Vi pháº¡m (Trá»« Ä‘iá»ƒm)</h4><div style="display:flex;gap:10px;margin-bottom:10px"><input type="text" id="newVType" placeholder="TÃªn lá»—i (VD: Äi muá»™n)" style="flex:2"> <input type="number" id="newVPoint" placeholder="Äiá»ƒm trá»«" style="flex:1"> <button class="btn btn-danger" style="width:auto;margin-top:0" onclick='addConfigType("ViolationTypes")'>ThÃªm</button></div><div id="violationTypeList" style="max-height:150px;overflow-y:auto;background:rgba(0,0,0,.2);border-radius:12px;padding:10px"></div></div><div><h4 style="margin-bottom:10px;color:#10b981">âœ¨ Danh má»¥c Khen thÆ°á»Ÿng (Cá»™ng Ä‘iá»ƒm)</h4><div style="display:flex;gap:10px;margin-bottom:10px"><input type="text" id="newRType" placeholder="TÃªn hÄ‘ (VD: Nháº·t cá»§a rÆ¡i)" style="flex:2"> <input type="number" id="newRPoint" placeholder="Äiá»ƒm cá»™ng" style="flex:1"> <button class="btn btn-success" style="width:auto;margin-top:0" onclick='addConfigType("RewardTypes")'>ThÃªm</button></div><div id="rewardTypeList" style="max-height:150px;overflow-y:auto;background:rgba(0,0,0,.2);border-radius:12px;padding:10px"></div></div></div></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:30px"><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--glass-border)"><h3 style="font-size:1.1rem">ğŸ“‘ Quáº£n LÃ½ Vi Pháº¡m</h3><div style="display:flex;gap:10px"><button class="btn" style="background:#0ea5e9;color:#fff;padding:8px 12px;font-size:.75rem;width:auto;border-radius:10px" onclick="exportViolationsExcel()">ğŸ“¥ Xuáº¥t Excel</button> <input type="text" id="searchViolation" placeholder="TÃ¬m tÃªn..." style="width:150px;padding:8px 12px;font-size:.8rem;border-radius:12px" oninput="filterViolations()"></div></div><div style="max-height:500px;overflow-y:auto"><table style="margin-top:0"><tbody id="violationManageBody"></tbody></table></div><div class="pagination" id="violationPagination" style="display:flex;justify-content:center;gap:8px;margin-top:15px"></div></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid var(--glass-border)"><h3 style="font-size:1.1rem">ğŸ“ Há»c Sinh</h3><div style="display:flex;gap:10px"><button class="btn" style="background:#0ea5e9;color:#fff;padding:8px 12px;font-size:.75rem;width:auto;border-radius:10px" onclick="exportStudentsExcel()">ğŸ“¥ Xuáº¥t Excel</button> <button class="btn" style="background:#4338ca;color:#fff;padding:8px 12px;font-size:.75rem;width:auto;border-radius:10px" onclick="recalculateAllStars()">ğŸ”„ TÃ­nh láº¡i</button> <input type="text" id="searchStudent" placeholder="TÃªn/Lá»›p..." style="width:120px;padding:8px 12px;font-size:.8rem;border-radius:12px" oninput="filterStudents()"></div></div><div style="max-height:500px;overflow-y:auto"><table style="margin-top:0"><thead><tr><th>ThÃ´ng tin</th><th>Lá»›p</th><th style="text-align:right">Sá»­a</th></tr></thead><tbody id="studentManageBody"></tbody></table></div><div class="pagination" id="studentPagination" style="display:flex;justify-content:center;gap:8px;margin-top:15px"></div></div></div></div><div class="card" style="margin-top:30px"><div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleGuide()"><h3 style="margin:0;display:flex;align-items:center;gap:10px"><span>ğŸ“š</span> HÆ°á»›ng Dáº«n Sá»­ Dá»¥ng Chi Tiáº¿t (Admin 1)</h3><span id="guideIcon" style="font-weight:700">â–¼</span></div><div id="guideContent" style="display:none;margin-top:20px;border-top:1px solid var(--glass-border);padding-top:20px;line-height:1.6;color:#cbd5e1"><div style="margin-bottom:25px"><h4 style="color:var(--primary);margin-bottom:10px;font-size:1.1rem;border-left:3px solid var(--primary);padding-left:10px">1. PhÃ¢n Quyá»n & Chá»©c NÄƒng Há»‡ Thá»‘ng</h4><div style="background:rgba(255,255,255,.03);padding:15px;border-radius:12px;margin-bottom:10px"><strong style="color:#fbbf24">ğŸ‘‘ Admin 1 - Quáº£n Trá»‹ ViÃªn (Báº¡n)</strong><p style="margin-top:5px;font-size:.9rem">- <b>Quyá»n háº¡n:</b> Kiá»ƒm soÃ¡t toÃ n bá»™ há»‡ thá»‘ng (Full Access).<br>- <b>Nhiá»‡m vá»¥:</b> Táº¡o tÃ i khoáº£n cho cÃ¡c Admin con, Cáº¥u hÃ¬nh danh má»¥c lá»—i/thÆ°á»Ÿng, Quáº£n lÃ½ lá»›p há»c, Sá»­a/XÃ³a dá»¯ liá»‡u sai, Xuáº¥t bÃ¡o cÃ¡o Excel.</p></div><div style="background:rgba(255,255,255,.03);padding:15px;border-radius:12px;margin-bottom:10px"><strong style="color:#818cf8">ğŸ‘¤ Admin 2 - NhÃ¢n Sá»± (Nháº­p Liá»‡u)</strong><p style="margin-top:5px;font-size:.9rem">- <b>Quyá»n háº¡n:</b> ThÃªm há»c sinh má»›i vÃ o há»‡ thá»‘ng.<br>- <b>Nhiá»‡m vá»¥:</b> Äáº§u nÄƒm há»c hoáº·c khi cÃ³ há»c sinh chuyá»ƒn Ä‘áº¿n, Admin 2 sáº½ nháº­p thÃ´ng tin (TÃªn, Lá»›p, áº¢nh) Ä‘á»ƒ táº¡o dá»¯ liá»‡u ná»n.</p></div><div style="background:rgba(255,255,255,.03);padding:15px;border-radius:12px;margin-bottom:10px"><strong style="color:#ef4444">ğŸš© Admin 3 - Cá» Äá» (Ká»· Luáº­t)</strong><p style="margin-top:5px;font-size:.9rem">- <b>Quyá»n háº¡n:</b> TÃ¬m kiáº¿m há»c sinh vÃ  Ghi nháº­n lá»—i vi pháº¡m.<br>- <b>Nhiá»‡m vá»¥:</b> HÃ ng ngÃ y Ä‘i kiá»ƒm tra, náº¿u phÃ¡t hiá»‡n há»c sinh vi pháº¡m thÃ¬ ghi vÃ o há»‡ thá»‘ng Ä‘á»ƒ trá»« Ä‘iá»ƒm thi Ä‘ua.</p></div><div style="background:rgba(255,255,255,.03);padding:15px;border-radius:12px"><strong style="color:#10b981">âœ¨ Admin 4 - Thi Äua (Khen ThÆ°á»Ÿng)</strong><p style="margin-top:5px;font-size:.9rem">- <b>Quyá»n háº¡n:</b> TÃ¬m kiáº¿m há»c sinh vÃ  Ghi nháº­n thÃ nh tÃ­ch.<br>- <b>Nhiá»‡m vá»¥:</b> Ghi láº¡i cÃ¡c viá»‡c lÃ m tá»‘t, Ä‘iá»ƒm tá»‘t Ä‘á»ƒ cá»™ng Ä‘iá»ƒm thi Ä‘ua cho há»c sinh.</p></div></div><div style="margin-bottom:25px"><h4 style="color:var(--danger);margin-bottom:10px;font-size:1.1rem;border-left:3px solid var(--danger);padding-left:10px">2. CÃ¡c LÆ°u Ã Quan Trá»ng (Cáº§n Äá»c Ká»¹)</h4><div style="margin-bottom:15px"><b style="color:#e2e8f0">âš™ï¸ Vá» Cáº¥u HÃ¬nh Äiá»ƒm:</b><p style="font-size:.9rem;margin-top:5px;color:#94a3b8">- <b>Äiá»ƒm Ban Äáº§u:</b> LÃ  sá»‘ Ä‘iá»ƒm "vá»‘n" mÃ  má»—i há»c sinh cÃ³ khi báº¯t Ä‘áº§u (VD: 100 Ä‘iá»ƒm). Náº¿u báº¡n sá»­a sá»‘ nÃ y á»Ÿ pháº§n Cáº¥u hÃ¬nh, toÃ n bá»™ há»c sinh sáº½ bá»‹ tÃ­nh láº¡i Ä‘iá»ƒm.<br>- <b>Danh má»¥c Lá»—i/ThÆ°á»Ÿng:</b> Admin 3 vÃ  4 chá»‰ chá»n Ä‘Æ°á»£c cÃ¡c lá»—i/thÆ°á»Ÿng mÃ  báº¡n Ä‘Ã£ táº¡o á»Ÿ Admin 1. HÃ£y cáº¥u hÃ¬nh Ä‘áº§y Ä‘á»§ trÆ°á»›c khi giao quyá»n cho há».</p></div><div style="margin-bottom:15px"><b style="color:#e2e8f0">âš ï¸ Vá» Chá»©c NÄƒng Reset/XÃ³a:</b><p style="font-size:.9rem;margin-top:5px;color:#94a3b8">- NÃºt <span style="color:#ef4444;border:1px solid #ef4444;padding:0 4px;border-radius:4px;font-size:.7rem">ğŸ—‘ï¸ XÃ³a sáº¡ch toÃ n bá»™</span> cá»±c ká»³ nguy hiá»ƒm. NÃ³ sáº½ xÃ³a tráº¯ng lá»‹ch sá»­ vi pháº¡m cá»§a cáº£ trÆ°á»ng. <b>Chá»‰ dÃ¹ng khi báº¯t Ä‘áº§u nÄƒm há»c má»›i.</b><br>- NÃºt <span style="color:#f59e0b;border:1px solid #f59e0b;padding:0 4px;border-radius:4px;font-size:.7rem">âš ï¸ Reset toÃ n bá»™</span> sáº½ xÃ³a sáº¡ch cÃ¡c loáº¡i Ä‘iá»ƒm cá»™ng/trá»« vÃ  Ä‘Æ°a táº¥t cáº£ vá» má»©c Ä‘iá»ƒm ban Ä‘áº§u.</p></div><div><b style="color:#e2e8f0">ğŸ”„ Vá» HoÃ n TÃ¡c & TÃ­nh Láº¡i:</b><p style="font-size:.9rem;margin-top:5px;color:#94a3b8">- <b>HoÃ n tÃ¡c (Undo):</b> Khi báº¡n xÃ³a má»™t dÃ²ng trong "Lá»‹ch sá»­ Vi pháº¡m", há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng bÃ¹ láº¡i Ä‘iá»ƒm cho há»c sinh Ä‘Ã³ (VÃ­ dá»¥: XÃ³a lá»—i Ä‘i muá»™n -2 Ä‘iá»ƒm -> Há»c sinh Ä‘Æ°á»£c cá»™ng láº¡i 2 Ä‘iá»ƒm).<br>- <b>TÃ­nh Láº¡i (Recalculate):</b> Náº¿u báº¡n cáº£m tháº¥y Ä‘iá»ƒm sá»‘ hiá»ƒn thá»‹ khÃ´ng khá»›p (do lá»—i máº¡ng hoáº·c lá»—i há»‡ thá»‘ng), hÃ£y nháº¥n nÃºt <span style="background:#4338ca;color:#fff;padding:2px 6px;border-radius:4px;font-size:.7rem">ğŸ”„ TÃ­nh láº¡i</span>. Há»‡ thá»‘ng sáº½ cá»™ng trá»« láº¡i tá»« Ä‘áº§u dá»±a trÃªn lá»‹ch sá»­ Ä‘á»ƒ ra sá»‘ Ä‘iá»ƒm chÃ­nh xÃ¡c nháº¥t.</p></div></div><div style="text-align:center;margin-top:30px;font-size:.8rem;color:#64748b;font-style:italic">Há»‡ thá»‘ng Ká»· luáº­t trÃ¢n trá»ng cáº£m Æ¡n báº¡n Ä‘Ã£ váº­n hÃ nh!<br>Má»i tháº¯c máº¯c ká»¹ thuáº­t vui lÃ²ng liÃªn há»‡ Ä‘á»™i ngÅ© phÃ¡t triá»ƒn.</div></div></div><div id="imageModal" class="modal" onclick="closeImg()"><img class="modal-img-content" id="imgFull"></div><div id="detailModal" class="modal" onclick="closeDetail()"><div class="modal-content-text" onclick="event.stopPropagation()"><h3><span>ğŸ“‘</span> Ná»™i Dung Chi Tiáº¿t</h3><p id="fullDetailText"></p><button class="btn-close-modal" onclick="closeDetail()">ÄÃ³ng cá»­a sá»•</button></div></div><div id="editStudentModal" class="modal"><div class="modal-content-text" style="background:#1e293b;max-width:400px;padding:25px"><h3 style="margin-bottom:20px">Sá»­a ThÃ´ng Tin Há»c Sinh</h3><form id="editStudentForm"><input type="hidden" id="editSid"><div style="margin-bottom:15px"><label style="font-size:.8rem;color:#94a3b8">Há» vÃ  tÃªn</label> <input type="text" id="editName" required></div><div style="margin-bottom:15px"><label style="font-size:.8rem;color:#94a3b8">Lá»›p</label> <select id="editClass" required><option value="">-- Chá»n lá»›p --</option></select></div><div style="margin-bottom:25px"><label style="font-size:.8rem;color:#94a3b8">MÃ£ sá»‘ há»c sinh (MSHS) - <span style="color:#ef4444;font-style:italic">Cáº©n trá»ng khi sá»­a</span></label> <input type="text" id="editIdVal"></div><div style="display:flex;gap:10px"><button type="submit" class="btn btn-primary">LÆ°u</button> <button type="button" class="btn" style="background:#475569;color:#fff" onclick="closeEditModal()">Há»§y</button></div></form></div></div><script src="firebase.config.js"></script><script>let currentRole=sessionStorage.getItem("kyluat_role"),createForm=("admin1"!==currentRole&&"admin0"!==currentRole&&(window.location.href="../index.html"),rootRef.child("Settings/Config").on("value",e=>{var e=e.val()||{status:"active"},t=(new Date).toISOString().split("T")[0],t=e.expiryDate&&t>e.expiryDate,n="locked"===e.status;(t||n)&&"admin0"!==currentRole&&(alert(e.message||"Há»‡ thá»‘ng Ä‘Ã£ bá»‹ khÃ³a hoáº·c háº¿t háº¡n!"),window.location.href="../index.html")}),document.getElementById("createAdminForm")),adminTableBody=document.getElementById("adminTableBody"),violationManageBody=document.getElementById("violationManageBody"),studentManageBody=document.getElementById("studentManageBody"),editForm=document.getElementById("editStudentForm"),createClassForm=document.getElementById("createClassForm"),classListArea=document.getElementById("classListArea"),editClassSelect=document.getElementById("editClass"),configData=(createForm.addEventListener("submit",async e=>{e.preventDefault();var e=document.getElementById("adminId").value.trim().toUpperCase(),t=document.getElementById("adminPass").value.trim(),n=document.getElementById("adminRole").value;if(!e||!t)return alert("Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin!");await rootRef.child("Admins").child(e).set({pass:t,role:n,createdAt:Date.now()}),createForm.reset(),alert("ÄÃ£ táº¡o tÃ i khoáº£n thÃ nh cÃ´ng!")}),rootRef.child("Admins").on("value",e=>{adminTableBody.innerHTML="",e.forEach(e=>{var t=e.val();let n="";n="admin2"===t.role?"Nháº­p liá»‡u":"admin3"===t.role?"Ghi lá»—i (Cá» Ä‘á»)":"admin4"===t.role?"Khen thÆ°á»Ÿng":t.role;var a=document.createElement("tr");a.style.fontSize="0.8rem",a.innerHTML=`
                    <td style="padding: 5px; font-weight: 600;">${e.key}</td>
                    <td style="padding: 5px; color: #94a3b8;">${t.pass}</td>
                    <td style="padding: 5px;"><span style="color: #818cf8; font-weight: 600;">${n}</span></td>
                    <td style="padding: 5px; text-align:right">
                        <button class="btn-danger" style="font-size: 0.65rem; padding: 4px 8px;" onclick="deleteAdmin('${e.key}')">XÃ³a</button>
                    </td>
                `,adminTableBody.appendChild(a)})}),{ViolationTypes:{},RewardTypes:{},DefaultStars:0});async function saveDefaultStars(){var e=parseInt(document.getElementById("defaultStarInput").value)||0;await rootRef.child("Settings/DefaultStars").set(e),alert("ÄÃ£ lÆ°u cáº¥u hÃ¬nh Ä‘iá»ƒm ban Ä‘áº§u!")}async function applyDefaultToAll(){var e=parseInt(document.getElementById("defaultStarInput").value)||0;confirm(`Cáº¢NH BÃO: Báº¡n muá»‘n Ã¡p dá»¥ng ÄIá»‚M BAN Äáº¦U lÃ  ${e} cho toÃ n bá»™ há»c sinh?

Há»‡ thá»‘ng sáº½ tÃ­nh láº¡i Ä‘iá»ƒm hiá»‡n táº¡i cá»§a há»c sinh theo cÃ´ng thá»©c:
Äiá»ƒm Hiá»‡n Táº¡i = ${e} + (Tá»•ng Äiá»ƒm Cá»™ng - Tá»•ng Äiá»ƒm Trá»« trong quÃ¡ khá»©)`)&&(await rootRef.child("Settings/DefaultStars").set(e),await performRecalculation(configData.DefaultStars=e))}async function addConfigType(e){var t="ViolationTypes"===e?"newV":"newR",n=document.getElementById(t+"Type").value.trim(),a=parseInt(document.getElementById(t+"Point").value)||0;return n?a<=0?alert("Äiá»ƒm pháº£i lá»›n hÆ¡n 0!"):(await rootRef.child("Settings/"+e).push({name:n,points:a}),document.getElementById(t+"Type").value="",void(document.getElementById(t+"Point").value="")):alert("Vui lÃ²ng nháº­p tÃªn!")}async function deleteConfigType(e,t){confirm("XÃ³a má»¥c nÃ y?")&&await rootRef.child(`Settings/${e}/`+t).remove()}function renderConfigList(a,e){let i=document.getElementById(e);i.innerHTML="";e=configData[a];e&&0!==Object.keys(e).length?Object.entries(e).forEach(([e,t])=>{var n=document.createElement("div");n.style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);",n.innerHTML=`
                    <div style="font-size: 0.85rem;">
                        <span style="font-weight:600;">${t.name}</span>
                        <span style="font-size:0.75rem; color:${"ViolationTypes"===a?"#f87171":"#34d399"}; margin-left:5px;">(${t.points} Ä‘iá»ƒm)</span>
                    </div>
                    <button class="btn-danger" style="padding: 2px 6px; font-size: 0.7rem; width: auto; margin-top:0;" onclick="deleteConfigType('${a}', '${e}')">Ã—</button>
                `,i.appendChild(n)}):i.innerHTML='<div style="text-align:center; color:#94a3b8; font-size:0.8rem;">ChÆ°a cÃ³ dá»¯ liá»‡u</div>'}async function recalculateAllStars(){confirm("Há»‡ thá»‘ng sáº½ Ä‘á»“ng bá»™ láº¡i sá»‘ sao cho TOÃ€N Bá»˜ há»c sinh dá»±a trÃªn cáº¥u hÃ¬nh Ä‘iá»ƒm ban Ä‘áº§u vÃ  lá»‹ch sá»­ vi pháº¡m/khen thÆ°á»Ÿng.\n\nTiáº¿p tá»¥c?")&&await performRecalculation(configData.DefaultStars||0)}async function deleteAllViolations(){if(confirm("Cá»°C Ká»² NGUY HIá»‚M: Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n xÃ³a TOÃ€N Bá»˜ lá»‹ch sá»­ vi pháº¡m vÃ  khen thÆ°á»Ÿng?\n\nHÃ nh Ä‘á»™ng nÃ y KHÃ”NG THá»‚ khÃ´i phá»¥c!")&&confirm("XÃ¡c nháº­n láº§n cuá»‘i: ToÃ n bá»™ lá»‹ch sá»­ sáº½ bá»‹ máº¥t. Äiá»ƒm cá»§a há»c sinh sáº½ Ä‘Æ°á»£c reset vá» má»©c Äiá»ƒm Ban Äáº§u.\n\nBáº¡n cÃ³ muá»‘n tiáº¿p tá»¥c?"))try{await rootRef.child("Violations").remove();let t={},n=configData.DefaultStars||0;allStudents.forEach(e=>{t[`Students/${e.id}/stars`]=n}),await rootRef.update(t),alert("ÄÃ£ xÃ³a toÃ n bá»™ lá»‹ch sá»­ vÃ  reset Ä‘iá»ƒm thÃ nh cÃ´ng!")}catch(e){console.error(e),alert("CÃ³ lá»—i xáº£y ra: "+e.message)}}async function performRecalculation(t){try{let a={},i=(Object.values(configData.ViolationTypes).forEach(e=>a[e.name.toLowerCase()]=e.points),{}),o=(Object.values(configData.RewardTypes).forEach(e=>i[e.name.toLowerCase()]=e.points),{});allStudents.forEach(e=>{o[e.id]=t}),allViolations.slice().reverse().forEach(n=>{if(n.studentId&&void 0!==o[n.studentId]){let t=0;n.totalPoints?t=n.violationType.includes("Khen thÆ°á»Ÿng")?n.totalPoints:-n.totalPoints:n.violationType.split(",").map(e=>e.trim()).forEach(e=>{e=e.toLowerCase();i[e]?t+=i[e]:n.violationType.includes("Khen thÆ°á»Ÿng")?t+=1:a[e]?t-=a[e]:--t}),o[n.studentId]+=t}});var e,n={};for(e in o)n[`Students/${e}/stars`]=o[e];await rootRef.update(n),alert("ÄÃ£ cáº­p nháº­t dá»¯ liá»‡u thÃ nh cÃ´ng!")}catch(e){console.error(e),alert("Lá»—i Ä‘á»“ng bá»™: "+e.message)}}async function deleteViolation(e){if(confirm("XÃ³a báº£n ghi nÃ y? Sá»‘ sao há»c sinh sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng hoÃ n tÃ¡c.")){let i=(await rootRef.child("Violations").child(e).once("value")).val();if(i){let a=0;if(i.totalPoints)a=i.violationType.includes("Khen thÆ°á»Ÿng")?-i.totalPoints:i.totalPoints;else{let t={},n=(Object.values(configData.ViolationTypes).forEach(e=>t[e.name.toLowerCase()]=e.points),{});Object.values(configData.RewardTypes).forEach(e=>n[e.name.toLowerCase()]=e.points),i.violationType.split(",").map(e=>e.trim()).forEach(e=>{e=e.toLowerCase();n[e]?a-=n[e]:i.violationType.includes("Khen thÆ°á»Ÿng")?--a:t[e]?a+=t[e]:a+=1})}i.studentId&&await rootRef.child("Students").child(i.studentId).transaction(e=>(e&&(e.stars=(e.stars||0)+a),e)),await rootRef.child("Violations").child(e).remove(),alert("ÄÃ£ xÃ³a vÃ  cáº­p nháº­t Ä‘iá»ƒm sao!")}}}async function deleteAdmin(e){confirm(`XÃ³a tÃ i khoáº£n ${e}?`)&&await rootRef.child("Admins").child(e).remove()}function showImg(e){document.getElementById("imgFull").src=e,document.getElementById("imageModal").style.display="flex"}function closeImg(){document.getElementById("imageModal").style.display="none"}function showDetail(e){document.getElementById("fullDetailText").textContent=e,document.getElementById("detailModal").style.display="flex"}function closeDetail(){document.getElementById("detailModal").style.display="none"}function logout(){sessionStorage.clear(),window.location.href="../index.html"}rootRef.child("Settings").on("value",e=>{e=e.val()||{};configData.ViolationTypes=e.ViolationTypes||{},configData.RewardTypes=e.RewardTypes||{},configData.DefaultStars=e.DefaultStars||0,document.getElementById("defaultStarInput").value=configData.DefaultStars,renderConfigList("ViolationTypes","violationTypeList"),renderConfigList("RewardTypes","rewardTypeList")});let allStudents=[],allViolations=[],currentStudentPage=1,currentViolationPage=1,pageSize=10;function initData(){rootRef.child("Students").on("value",e=>{allStudents=[],e.forEach(e=>{allStudents.push({id:e.key,...e.val()})}),renderStudentTable()}),rootRef.child("Violations").on("value",e=>{allViolations=[],e.forEach(e=>{var t=e.val();t.key=e.key,allViolations.push(t)}),allViolations.sort((e,t)=>t.timestamp-e.timestamp),renderViolationTable()})}function renderStudentTable(){let n=document.getElementById("studentManageBody"),t=(n.innerHTML="",(document.getElementById("searchStudent").value||"").toLowerCase());var e=allStudents.filter(e=>e.name.toLowerCase().includes(t)||e.class&&e.class.toLowerCase().includes(t)),a=(renderPaginationHTML("studentPagination",e.length,currentStudentPage,e=>{currentStudentPage=e,renderStudentTable()}),(currentStudentPage-1)*pageSize),i=a+pageSize;e.slice(a,i).forEach(e=>{var t=document.createElement("tr");t.innerHTML=`
                    <td>
                        <div class="student-info">
                            <img src="${e.photo}" class="student-img" onclick="showImg('${e.photo}')">
                            <div>
                                <div style="font-weight:600;">${e.name}</div>
                                <div style="font-size:0.75rem; color:#94a3b8;">MSHS: ${e.id}</div>
                                <div style="font-size:0.75rem; color:${e.stars<0?"#ef4444":"#10b981"}; font-weight:700;">${e.stars||0} â­</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-weight:600; color:#cbd5e1;">${e.class}</td>
                    <td style="text-align: right;">
                        <button class="btn" style="background: rgba(255,255,255,0.05); padding: 6px 10px; border-radius: 6px; font-size: 0.75rem;" onclick="openEditStudent('${e.id}')">âœï¸</button>
                        <button class="btn-danger" onclick="deleteStudent('${e.id}')">ğŸ—‘ï¸</button>
                    </td>
                `,n.appendChild(t)})}function renderViolationTable(){let a=document.getElementById("violationManageBody"),t=(a.innerHTML="",(document.getElementById("searchViolation").value||"").toLowerCase());var e=allViolations.filter(e=>e.violationType.toLowerCase().includes(t)||e.studentName&&e.studentName.toLowerCase().includes(t)),n=(renderPaginationHTML("violationPagination",e.length,currentViolationPage,e=>{currentViolationPage=e,renderViolationTable()}),(currentViolationPage-1)*pageSize),i=n+pageSize;e.slice(n,i).forEach(e=>{var t=document.createElement("tr"),n=e.violationType.includes("Khen thÆ°á»Ÿng");t.innerHTML=`
                    <td>
                        <div style="font-weight:600; font-size:0.9rem;">${e.studentName} <span style="font-weight:400; color:#94a3b8; font-size:0.75rem;">(${e.studentClass})</span></div>
                        <div style="font-size:0.7rem; color:#64748b;">${new Date(e.timestamp).toLocaleString("vi-VN")}</div>
                    </td>
                    <td>
                        <span class="violation-tag" style="${n?"background:rgba(16,185,129,0.1); color:#10b981; border-color:rgba(16,185,129,0.2);":""}">
                            ${e.violationType}
                        </span>
                        ${e.totalPoints?`<span style="font-size:0.7rem; font-weight:700; margin-left:5px; color:${n?"#10b981":"#ef4444"}">${n?"+":"-"}${e.totalPoints}</span>`:""}
                    </td>
                    <td style="text-align: right;">
                        <button class="btn-danger" onclick="deleteViolation('${e.key}')">HoÃ n tÃ¡c</button>
                    </td>
                `,a.appendChild(t)})}function renderPaginationHTML(e,t,n,a){var i=document.getElementById(e),e=(i.innerHTML="",Math.ceil(t/pageSize));if(!(e<=1)){let t=Math.max(1,n-2);var o=Math.min(e,t+4);for(let e=t=o-t<4?Math.max(1,o-4):t;e<=o;e++){var l=document.createElement("button");l.className="btn",l.style="width: 30px; height: 30px; padding: 0; display:flex; align-items:center; justify-content:center; "+(e===n?"background:var(--primary); color:white;":"background:rgba(255,255,255,0.05);"),l.textContent=e,l.onclick=()=>a(e),i.appendChild(l)}}}async function deleteStudent(e){if(confirm("XÃ³a há»c sinh nÃ y vÃ  toÃ n bá»™ lá»‹ch sá»­ vi pháº¡m liÃªn quan?")){var n=await rootRef.child("Violations").orderByChild("studentId").equalTo(e).once("value");let t={};t["Students/"+e]=null,n.forEach(e=>{t["Violations/"+e.key]=null}),await rootRef.update(t)}}function openEditStudent(n){var a=allStudents.find(e=>e.id===n);if(a){document.getElementById("editSid").value=n,document.getElementById("editIdVal").value=n,document.getElementById("editName").value=a.name;var e,i=document.getElementById("editClass");let t=!1;for(let e=0;e<i.options.length;e++)i.options[e].value===a.class&&(t=!0);t||((e=document.createElement("option")).value=a.class,e.textContent=a.class,i.appendChild(e)),i.value=a.class,document.getElementById("editStudentModal").style.display="flex"}}function exportViolationsExcel(){if(!allViolations||0===allViolations.length)return alert("KhÃ´ng cÃ³ dá»¯ liá»‡u vi pháº¡m Ä‘á»ƒ xuáº¥t!");var e=allViolations.map(e=>({"Thá»i gian":new Date(e.timestamp).toLocaleString("vi-VN"),"Há» vÃ  TÃªn":e.studentName,"Lá»›p":e.studentClass,"Ná»™i dung":e.violationType,"Biáº¿n Ä‘á»™ng Ä‘iá»ƒm":(e.violationType.includes("Khen thÆ°á»Ÿng")?"+":"-")+(e.totalPoints||0)})),e=XLSX.utils.json_to_sheet(e),t=(e["!cols"]=[{wch:20},{wch:20},{wch:10},{wch:40},{wch:15}],XLSX.utils.book_new());XLSX.utils.book_append_sheet(t,e,"Lá»‹ch sá»­ Vi pháº¡m"),XLSX.writeFile(t,`Danh_Sach_Vi_Pham_${(new Date).toLocaleDateString("vi-VN").replace(/\//g,"-")}.xlsx`)}function exportStudentsExcel(){if(!allStudents||0===allStudents.length)return alert("KhÃ´ng cÃ³ dá»¯ liá»‡u há»c sinh Ä‘á»ƒ xuáº¥t!");var e=allStudents.map(e=>({"MÃ£ há»c sinh":e.id,"Há» vÃ  TÃªn":e.name,"Lá»›p":e.class,"Äiá»ƒm thi Ä‘ua (Sao)":e.stars||0})),e=XLSX.utils.json_to_sheet(e),t=(e["!cols"]=[{wch:15},{wch:25},{wch:10},{wch:15}],XLSX.utils.book_new());XLSX.utils.book_append_sheet(t,e,"Danh sÃ¡ch Há»c sinh"),XLSX.writeFile(t,`Danh_Sach_Hoc_Sinh_${(new Date).toLocaleDateString("vi-VN").replace(/\//g,"-")}.xlsx`)}async function deleteClass(e){confirm(`XÃ³a lá»›p ${e}?`)&&await rootRef.child("Classes/"+e).remove()}function toggleGuide(){var e=document.getElementById("guideContent"),t=document.getElementById("guideIcon");"none"===e.style.display?(e.style.display="block",t.textContent="â–²"):(e.style.display="none",t.textContent="â–¼")}initData(),window.filterStudents=()=>{currentStudentPage=1,renderStudentTable()},window.filterViolations=()=>{currentViolationPage=1,renderViolationTable()},document.getElementById("editStudentForm").addEventListener("submit",async e=>{e.preventDefault();e=document.getElementById("editSid").value;let n=document.getElementById("editIdVal").value.trim();var a=document.getElementById("editName").value.trim(),i=document.getElementById("editClass").value;if(!(e&&n&&a&&i))return alert("Vui lÃ²ng nháº­p Ä‘á»§ thÃ´ng tin!");if(e===n)await rootRef.child("Students/"+e).update({name:a,class:i});else{if((await rootRef.child("Students/"+n).once("value")).exists())return alert("MÃ£ há»c sinh má»›i Ä‘Ã£ tá»“n táº¡i! Vui lÃ²ng chá»n mÃ£ khÃ¡c.");if(!confirm(`âš ï¸ Cáº¢NH BÃO THAY Äá»”I MÃƒ Sá»:

Báº¡n Ä‘ang Ä‘á»•i mÃ£ tá»« "${e}" -> "${n}".

Há»‡ thá»‘ng sáº½:
1. Táº¡o há»“ sÆ¡ vá»›i mÃ£ má»›i.
2. Chuyá»ƒn toÃ n bá»™ lá»‹ch sá»­ vi pháº¡m sang mÃ£ má»›i.
3. XÃ³a há»“ sÆ¡ cÅ©.

Báº¡n cÃ³ cháº¯c cháº¯n muá»‘n tiáº¿p tá»¥c?`))return;var o=(await rootRef.child("Students/"+e).once("value")).val();if(!o)return alert("Lá»—i: KhÃ´ng tÃ¬m tháº¥y dá»¯ liá»‡u há»c sinh cÅ©.");o={...o,name:a,class:i,id:n},a=(await rootRef.child("Students/"+n).set(o),await rootRef.child("Violations").orderByChild("studentId").equalTo(e).once("value"));let t={};a.forEach(e=>{t[`Violations/${e.key}/studentId`]=n}),0<Object.keys(t).length&&await rootRef.update(t),await rootRef.child("Students/"+e).remove()}alert("Cáº­p nháº­t thÃ´ng tin thÃ nh cÃ´ng!"),document.getElementById("editStudentModal").style.display="none"}),window.closeEditModal=()=>document.getElementById("editStudentModal").style.display="none",rootRef.child("Classes").on("value",e=>{let n=document.getElementById("classListArea"),a=document.getElementById("editClass");n&&(n.innerHTML=""),a&&(a.innerHTML='<option value="">-- Chá»n lá»›p --</option>'),e.forEach(e=>{var t;n&&((t=document.createElement("div")).style="background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:12px; font-size:0.8rem; display:flex; align-items:center; gap:5px;",t.innerHTML=e.key+` <span style="cursor:pointer; color:#ef4444; font-weight:bold;" onclick="deleteClass('${e.key}')">Ã—</span>`,n.appendChild(t)),a&&((t=document.createElement("option")).value=e.key,t.textContent=e.key,a.appendChild(t))})}),document.getElementById("createClassForm").addEventListener("submit",async e=>{e.preventDefault();e=document.getElementById("className").value.trim();e&&(await rootRef.child("Classes/"+e).set(!0),document.getElementById("className").value="")})</script></body></html>