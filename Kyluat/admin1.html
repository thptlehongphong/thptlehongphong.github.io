<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1100">
    <title>Admin 1 - Qu·∫£n L√Ω H·ªá Th·ªëng</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../student_data.js"></script>
    <script type="module" src="../firebase-backend.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background: #0f172a; color: white; min-height: 100vh; padding: 40px 5%; }

        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 20px; padding: 30px; margin-bottom: 30px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

        input, select {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--glass-border);
            background: #1e293b; color: #ffffff; outline: none;
        }
        
        select option {
            background-color: #0f172a;
            color: white;
        }

        .btn { padding: 12px 24px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-danger-outline { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-success { background: #10b981; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px 15px; color: #94a3b8; border-bottom: 1px solid var(--glass-border); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.03); vertical-align: middle; }
        
        .student-img { 
            width: 38px; height: 38px; border-radius: 10px; object-fit: cover; 
            border: 1px solid var(--glass-border); cursor: zoom-in; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        /* Modal Styles */
        .modal {
            display: none; position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85); z-index: 2000;
            justify-content: center; align-items: center; backdrop-filter: blur(10px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 32px;
            border-radius: 28px;
            max-width: 480px;
            width: 90%;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            animation: modalSlideUp 0.3s ease-out;
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom Confirm Modal Styles */
        .confirm-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 9999;
            justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }
        .confirm-modal-content {
            background: #1e293b; border: 1px solid var(--glass-border); padding: 30px;
            border-radius: 24px; max-width: 400px; width: 90%; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: modalPop 0.2s ease-out;
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .confirm-modal-btns { display: flex; gap: 12px; margin-top: 25px; }
        .confirm-modal-btns .btn { flex: 1; padding: 12px; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 15px; }
        .page-btn {
            padding: 8px 14px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: #94a3b8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.3s;
        }
        .page-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
            border-color: var(--primary);
            color: white;
        }
        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1 style="font-size: 2.5rem; letter-spacing: -1px;">Admin 1 <span style="color: var(--primary); font-size: 1.2rem; font-weight: 400;">/ Qu·∫£n tr·ªã h·ªá th·ªëng</span></h1>
                <p style="color: #94a3b8; margin-top: 5px;">Qu·∫£n l√Ω t√†i kho·∫£n, h·ªçc sinh v√† l·ªãch s·ª≠ vi ph·∫°m</p>
            </div>
            <button type="button" class="btn" style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white;" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
            <div class="card" style="margin-bottom: 0;">
                <h3 style="margin-bottom: 20px;">üë§ T·∫°o T√†i Kho·∫£n</h3>
                <form id="createAdminForm" onsubmit="return false;">
                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                        <div>
                            <input type="text" id="adminId" placeholder="ID" required>
                        </div>
                        <div>
                            <input type="password" id="adminPass" placeholder="M·∫≠t kh·∫©u" required>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <select id="adminRole" style="flex: 1;">
                            <option value="admin2">Admin 2 (Nh·∫≠p li·ªáu)</option>
                            <option value="admin3">Admin 3 (C·ªù ƒë·ªè)</option>
                            <option value="admin4">Admin 4 (Khen th∆∞·ªüng)</option>
                        </select>
                        <button type="button" class="btn btn-primary" style="width: auto;" onclick="addAdminAccount()">T·∫°o</button>
                    </div>
                </form>
                <div style="max-height: 150px; overflow-y: auto; margin-top: 15px; border-top: 1px solid var(--glass-border); padding-top: 10px;">
                    <table>
                        <thead>
                            <tr style="font-size: 0.7rem; color: #94a3b8;">
                                <th>ID</th>
                                <th>M·∫≠t kh·∫©u</th>
                                <th>Quy·ªÅn</th>
                                <th style="text-align: right;">X√≥a</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 0;">
                <h3 style="margin-bottom: 20px;">üè´ Qu·∫£n L√Ω L·ªõp H·ªçc</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="className" placeholder="T√™n l·ªõp (10A1...)">
                    <button type="button" class="btn btn-primary" style="width: auto;" onclick="addClass()">Th√™m</button>
                </div>
                <div id="classListArea" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 150px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 20px;">‚öôÔ∏è C·∫•u H√¨nh H·ªá Th·ªëng</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <div>
                    <h4 style="margin-bottom: 10px; color: var(--primary);">‚≠ê ƒêi·ªÉm Ban ƒê·∫ßu</h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="number" id="defaultStarInput" style="width: 100px;">
                        <button type="button" class="btn btn-primary" onclick="saveDefaultStars()">L∆∞u m·∫∑c ƒë·ªãnh</button>
                    </div>
                    <button type="button" class="btn btn-danger-outline" style="width: 100%; justify-content: flex-start; margin-bottom: 10px;" onclick="applyDefaultToAll()">‚ö†Ô∏è Reset ƒëi·ªÉm to√†n b·ªô h·ªçc sinh</button>
                    <button type="button" class="btn btn-danger-outline" style="width: 100%; justify-content: flex-start;" onclick="deleteAllViolations()">üóëÔ∏è X√≥a s·∫°ch l·ªãch s·ª≠ vi ph·∫°m</button>
                </div>
                <div>
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: var(--danger); margin-bottom: 10px;">üõë Lo·∫°i Vi Ph·∫°m</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newVType" placeholder="T√™n l·ªói">
                            <input type="number" id="newVPoint" placeholder="ƒêi·ªÉm" style="width: 80px;">
                            <button type="button" class="btn btn-success" onclick="addConfig('ViolationTypes')">+</button>
                        </div>
                        <div id="violationTypeList" style="max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 10px;"></div>
                    </div>
                    <div>
                        <h4 style="color: #10b981; margin-bottom: 10px;">‚ú® Lo·∫°i Khen Th∆∞·ªüng</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="newRType" placeholder="T√™n hƒë">
                            <input type="number" id="newRPoint" placeholder="ƒêi·ªÉm" style="width: 80px;">
                            <button type="button" class="btn btn-success" onclick="addConfig('RewardTypes')">+</button>
                        </div>
                        <div id="rewardTypeList" style="max-height: 120px; overflow-y: auto; background: rgba(0,0,0,0.1); padding: 10px; border-radius: 10px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üìë L·ªãch S·ª≠ Vi Ph·∫°m</h3>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" onclick="exportViolationsExcel()">üì• Excel</button>
                        <input type="text" id="searchViolation" placeholder="T√¨m ki·∫øm..." style="width: 120px;" oninput="filterViolations()">
                    </div>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <tbody id="violationManageBody"></tbody>
                    </table>
                </div>
                <div id="violationPagination" class="pagination" style="display: flex; justify-content: center; gap: 5px; margin-top: 15px;"></div>
            </div>

            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>üéì Danh S√°ch H·ªçc Sinh</h3>
                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="btn" onclick="exportStudentsExcel()">üì• Excel</button>
                        <input type="text" id="searchStudent" placeholder="T√¨m ki·∫øm..." style="width: 120px;" oninput="filterStudents()">
                    </div>
                </div>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table>
                        <thead>
                            <tr style="font-size: 0.75rem; color: #94a3b8;">
                                <th>H·ªçc sinh</th>
                                <th>L·ªõp</th>
                                <th style="text-align: right;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="studentManageBody"></tbody>
                    </table>
                </div>
                <div id="studentPagination" class="pagination" style="display: flex; justify-content: center; gap: 5px; margin-top: 15px;"></div>
            </div>
        </div>

        <!-- Section Documentation: C·∫©m Nang Qu·∫£n Tr·ªã Chuy√™n S√¢u -->
        <div class="card" style="margin-top: 20px; border: 1px solid rgba(99, 102, 241, 0.3); background: rgba(15, 23, 42, 0.4);">
            <div style="text-align: center; margin-bottom: 40px;">
                <h2 style="font-size: 2rem; color: #818cf8; margin-bottom: 10px;">üìñ C·∫®M NANG V·∫¨N H√ÄNH H·ªÜ TH·ªêNG QU·∫¢N L√ù R√àN LUY·ªÜN</h2>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px;">
                <!-- Column 1: Core Mechanics -->
                <div>
                    <section style="margin-bottom: 30px;">
                        <h3 style="color: white; border-left: 4px solid var(--primary); padding-left: 15px; margin-bottom: 20px; font-size: 1.2rem;">üîπ PH√ÇN C·∫§P V√Ä NHI·ªÜM V·ª§ QU·∫¢N TR·ªä</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="background: var(--primary); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.8rem; font-weight: bold;">1</span>
                                    <strong style="color: #818cf8;">Admin 1 - T·ªïng Qu·∫£n</strong>
                                </div>
                                <p style="font-size: 0.9rem; color: #cbd5e1; margin-left: 34px;">ƒê√¢y l√† t√†i kho·∫£n c·ªßa Ban Gi√°m Hi·ªáu ho·∫∑c T·ªï CNTT. Nhi·ªám v·ª• l√† thi·∫øt k·∫ø "lu·∫≠t ch∆°i": thi·∫øt l·∫≠p m·ª©c ƒëi·ªÉm ban ƒë·∫ßu, t·∫°o danh m·ª•c c√°c l·ªói vi ph·∫°m v√† khen th∆∞·ªüng k√®m ƒëi·ªÉm s·ªë t∆∞∆°ng ·ª©ng. Admin 1 n·∫Øm gi·ªØ ch√¨a kh√≥a d·ªØ li·ªáu, c√≥ quy·ªÅn xu·∫•t Excel ƒë·ªÉ b√°o c√°o trong c√°c k·ª≥ s∆° k·∫øt.</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="background: #10b981; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.8rem; font-weight: bold;">2</span>
                                    <strong style="color: #10b981;">Admin 2 - Nh·∫≠p Li·ªáu (Ng∆∞·ªùi x√¢y n·ªÅn m√≥ng)</strong>
                                </div>
                                <p style="font-size: 0.9rem; color: #cbd5e1; margin-left: 34px;">C√¥ng vi·ªác di·ªÖn ra ch·ªß y·∫øu ƒë·∫ßu nƒÉm h·ªçc: Ch·ª•p ·∫£nh tr·ª±c ti·∫øp ho·∫∑c t·∫£i l√™n ·∫£nh h·ªçc sinh k√®m th√¥ng tin c·ªßa h·ªçc sinh. M·ªói h·ªçc sinh s·∫Ω c√≥ 1 m√£ ƒë·ªãnh danh (ID) duy nh·∫•t trong su·ªët 1 nƒÉm h·ªçc. Kh√¥ng th·ªÉ thay ƒë·ªïi ID n√†y tr·ª´ khi ADMIN 1 xo√° h·ªçc sinh.</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="background: var(--danger); width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.8rem; font-weight: bold;">3</span>
                                    <strong style="color: #ef4444;">Admin 3 - C·ªù ƒê·ªè & Gi√°m Th·ªã (Th·ª±c thi)</strong>
                                </div>
                                <p style="font-size: 0.9rem; color: #cbd5e1; margin-left: 34px;">ƒê√¢y l√† c√¥ng c·ª• di ƒë·ªông chuy√™n d·ª•ng. ƒê·ªôi c·ªù ƒë·ªè c·∫ßm ƒëi·ªán tho·∫°i, ch·ªâ c·∫ßn nh·∫≠p ID c·ªßa h·ªçc sinh ho·∫∑c qu√©t m√£ QR tr√™n th·∫ª h·ªçc sinh, xe m√°y, xe ƒë·∫°p c√≥ g·∫Øn m√£ QR s·∫Ω t·ª± ƒë·ªông truy xu·∫•t ra th√¥ng tin c·ªßa h·ªçc sinh v√† ghi nh·∫≠n c√°c l·ªói vi ph·∫°m. To√†n b·ªô l·ªói vi ph·∫°m s·∫Ω ƒë∆∞·ª£c ghi nh·∫≠n l√™n "B·∫£ng vi ph·∫°m Live" tr√™n trang ch·ªß trong 1-2 gi√¢y, lo·∫°i b·ªè ho√†n to√†n vi·ªác s·ªï s√°ch th·ªß c√¥ng.</p>
                            </div>
                            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                    <span style="background: #f59e0b; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.8rem; font-weight: bold;">4</span>
                                    <strong style="color: #f59e0b;">Admin 4 (Khen th∆∞·ªüng)</strong>
                                </div>
                                <p style="font-size: 0.9rem; color: #cbd5e1; margin-left: 34px;">Admin 4 ch·ª©c nƒÉng t∆∞∆°ng t·ª± nh∆∞ ADMIN 3 nh∆∞ng l√† khen th∆∞·ªüng v√† + ƒëi·ªÉm cho h·ªçc sinh.</p>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Column 2: Workflow & Tips -->
                <div>
                    <section style="margin-bottom: 30px;">
                        <h3 style="color: white; border-left: 4px solid #818cf8; padding-left: 15px; margin-bottom: 20px; font-size: 1.2rem;">‚ö° QUY TR√åNH V·∫¨N H√ÄNH</h3>
                        <div style="background: rgba(99, 102, 241, 0.05); border: 1px dashed rgba(99, 102, 241, 0.3); padding: 20px; border-radius: 16px;">
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: white; margin-bottom: 8px; font-size: 1rem;">üèÅ B∆∞·ªõc 1: Kh·ªüi t·∫°o m·ªói h·ªçc k·ª≥</h4>
                                <ol style="padding-left: 20px; color: #cbd5e1; font-size: 0.9rem;">
                                    <li>Admin 1 s·ª≠ d·ª•ng t√≠nh nƒÉng <strong>"X√≥a s·∫°ch l·ªãch s·ª≠ vi ph·∫°m"</strong> ƒë·ªÉ d·ªçn d·∫πp d·ªØ li·ªáu c≈©.</li>
                                    <li>S·ª≠ d·ª•ng <strong>"Reset ƒëi·ªÉm to√†n b·ªô h·ªçc sinh"</strong> ƒë·ªÉ ƒë∆∞a c√°c em v·ªÅ v·∫°ch xu·∫•t ph√°t (VD: 100 sao).</li>
                                </ol>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <h4 style="color: white; margin-bottom: 8px; font-size: 1rem;">üìÖ B∆∞·ªõc 2: Duy tr√¨ h·∫±ng ng√†y</h4>
                                <ul style="padding-left: 20px; color: #cbd5e1; font-size: 0.9rem;">
                                    <li>ƒê·ªôi C·ªù ƒê·ªè tr·ª±c t·∫°i c·ªïng tr∆∞·ªùng v·ªõi t√†i kho·∫£n Admin 3.</li>
                                    <li>Gi√°o vi√™n b·ªô m√¥n khen th∆∞·ªüng t·∫°i l·ªõp v·ªõi t√†i kho·∫£n Admin 4.</li>
                                    <li>M·ªçi thay ƒë·ªïi s·∫Ω hi·ªán ngay tr√™n <strong>Live Dashboard</strong> ·ªü s·∫£nh tr∆∞·ªùng ho·∫∑c website c√¥ng c·ªông. T·∫•t c·∫£ ph·ª• huynh, h·ªçc sinh, gi√°o vi√™n ƒë·ªÅu c√≥ th·ªÉ xem ƒë∆∞·ª£c</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="color: white; margin-bottom: 8px; font-size: 1rem;">üìà B∆∞·ªõc 3: T·ªïng k·∫øt cu·ªëi tu·∫ßn</h4>
                                <p style="color: #cbd5e1; font-size: 0.9rem;">Admin 1 truy c·∫≠p m·ª•c <strong>"L·ªãch s·ª≠ vi ph·∫°m"</strong>, l·ªçc theo th·ªùi gian v√† b·∫•m <strong>"üì• Excel"</strong>. D·ªØ li·ªáu n√†y ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp s·∫µn, ch·ªâ c·∫ßn in ra ƒë·ªÉ ƒë·ªçc trong gi·ªù ch√†o c·ªù.</p>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 style="color: white; border-left: 4px solid #10b981; padding-left: 15px; margin-bottom: 15px; font-size: 1.2rem;">üí° M·∫∏O QU·∫¢N TR·ªä</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px; font-size: 0.9rem; color: #cbd5e1;">
                            <p>‚úÖ <strong>S·ª≠ d·ª•ng QR Code:</strong> In m√£ QR h·ªçc sinh (n·∫±m b√™n ngo√†i trang ch·ªß ph·∫ßn danh s√°ch to√†n tr∆∞·ªùng) g·∫Øn sau th·∫ª t√™n ho·∫∑c gh·∫ø ng·ªìi, xe ƒë·∫°p, xe m√°y ƒë·ªÉ vi·ªác ki·ªÉm tra di·ªÖn ra nhanh h∆°n.</p>
                            <p>‚úÖ <strong>T√≠nh nƒÉng Ho√†n t√°c (Undo):</strong> N·∫øu ghi nh·∫ßm l·ªói, h√£y v√†o ADMIN 1 v√† v√†o m·ª•c L·ªãch s·ª≠ v√† b·∫•m ‚Ü©Ô∏è ƒë·ªÉ x√≥a l·ªói v√† t·ª± ƒë·ªông ho√†n tr·∫£ ƒëi·ªÉm cho h·ªçc sinh ngay l·∫≠p t·ª©c.</p>
                            <p>‚úÖ <strong>ƒê·ªìng b·ªô Kh·ªëi l·ªõp:</strong> H·ªá th·ªëng t·ª± ƒë·ªông nh·∫≠n di·ªán kh·ªëi (6, 7, 8...) ƒë·ªÉ t·∫°o b·∫£ng x·∫øp h·∫°ng thi ƒëua gi·ªØa c√°c l·ªõp trong c√πng kh·ªëi.</p>
                            <p>‚úÖ <strong>B·∫£o m·∫≠t:</strong> N·∫øu nghi ng·ªù l·ªô m·∫≠t kh·∫©u, h√£y d√πng Admin 1 ƒë·ªÉ x√≥a t√†i kho·∫£n c≈© v√† c·∫•p l·∫°i t√†i kho·∫£n m·ªõi nhanh ch√≥ng.</p>
                        </div>
                    </section>
                </div>
            </div>

            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--glass-border); text-align: center;">
                <p style="font-size: 0.85rem; color: #64748b; font-style: italic;">H·ªá th·ªëng ƒë∆∞·ª£c ph√°t tri·ªÉn chuy√™n s√¢u cho c√°c tr∆∞·ªùng ph·ªï th√¥ng t·∫°i Vi·ªát Nam. M·ªçi th·∫Øc m·∫Øc k·ªπ thu·∫≠t vui l√≤ng li√™n h·ªá Admin 0.</p>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeImg()">
        <img id="imgFull" style="max-width: 90%; max-height: 90%; border-radius: 20px; border: 2px solid var(--primary);">
    </div>

    <!-- Custom Confirm Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <h3 style="margin-bottom: 15px; color: var(--danger);">‚ö†Ô∏è X√°c Nh·∫≠n</h3>
            <p id="confirmMsg" style="color: #cbd5e1; line-height: 1.5; font-size: 0.95rem;"></p>
            <div class="confirm-modal-btns">
                <button type="button" class="btn btn-primary" id="btnConfirmYes">ƒê·ªìng √Ω</button>
                <button type="button" class="btn" style="background: #475569; color: white;" onclick="closeConfirm()">Tho√°t</button>
            </div>
        </div>
    </div>

    <div id="editStudentModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 style="margin-bottom: 20px;">S·ª≠a Th√¥ng Tin H·ªçc Sinh</h3>
            <input type="hidden" id="editSid">
            <div style="margin-bottom: 15px;">
                <label style="font-size: 0.8rem; color: #94a3b8;">H·ªç t√™n</label>
                <input type="text" id="editName">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="font-size: 0.8rem; color: #94a3b8;">L·ªõp</label>
                <select id="editClass"></select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="btn btn-primary" onclick="saveStudentEdit()">L∆∞u</button>
                <button type="button" class="btn" style="background: #475569; color: white;" onclick="closeEditModal()">H·ªßy</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "";
        const role = sessionStorage.getItem('kyluat_role');
        if (role !== 'admin1' && role !== 'admin0') window.location.href = '../index.html';

        let allStudents = [], allViolations = [], configs = { ViolationTypes: {}, RewardTypes: {}, DefaultStars: 0 };
        let studentPage = 1, violationPage = 1;
        const pageSize = 10;
        let confirmCallback = null;

        function showConfirm(msg, onConfirm) {
            document.getElementById('confirmMsg').innerText = msg;
            document.getElementById('confirmModal').style.display = 'flex';
            confirmCallback = onConfirm;
        }

        function closeConfirm() {
            document.getElementById('confirmModal').style.display = 'none';
            confirmCallback = null;
        }

        document.getElementById('btnConfirmYes').onclick = function() {
            if (confirmCallback) confirmCallback();
            closeConfirm();
        };

        async function init() {
            await Promise.all([fetchConfigs(), fetchAdmins(), fetchStudents(), fetchHistory(), fetchClasses()]);
        }
        if (window.firebaseBackendReady) {
            init();
        } else {
            window.addEventListener('firebaseBackendReady', init);
        }

        async function fetchConfigs() {
            try {
                const res = await fetch(`${API_BASE}/api/settings`);
                const data = await res.json();
                configs = {
                    ViolationTypes: JSON.parse(data.violationtypes || '{}'),
                    RewardTypes: JSON.parse(data.rewardtypes || '{}'),
                    DefaultStars: parseInt(data.default_stars || 0)
                };
                document.getElementById('defaultStarInput').value = configs.DefaultStars;
                renderConfigs('ViolationTypes', 'violationTypeList');
                renderConfigs('RewardTypes', 'rewardTypeList');
                
                // --- LOCK CHECK ---
                const today = new Date().toISOString().split('T')[0];
                const isExpired = data.expiry_date && today > data.expiry_date;
                const perms = JSON.parse(data.permissions || '{"admin1":true,"admin2":true,"admin3":true,"admin4":true}');
                const currentRole = sessionStorage.getItem('kyluat_role');
                const isRoleBlocked = perms[currentRole] === false;

                if ((isExpired || isRoleBlocked) && currentRole !== 'admin0') {
                    window.location.href = '../index.html';
                }
            } catch (e) { console.error(e); }
        }

        async function fetchAdmins() {
            try {
                const res = await fetch(`${API_BASE}/api/admins`);
                const admins = await res.json();
                const tbody = document.getElementById('adminTableBody');
                tbody.innerHTML = '';
                admins.forEach(a => {
                    if (a.role === 'admin0' || a.role === 'admin1') return;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-weight: 600; font-size: 0.85rem;">${a.username}</td>
                        <td style="color: #94a3b8; font-size: 0.8rem;">${a.password}</td>
                        <td style="color: #818cf8; font-weight: 600; font-size: 0.8rem;">${a.role}</td>
                        <td style="text-align: right;"><button type="button" class="btn" style="padding: 4px 8px; font-size: 0.7rem; color: #ef4444;" onclick="deleteAdmin('${a.username}')">X√≥a</button></td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) { console.error(e); }
        }

        async function fetchStudents() {
            try {
                const cachedData = localStorage.getItem('fb_mock_students_data');
                if (cachedData) {
                    try { 
                        allStudents = JSON.parse(cachedData); 
                        renderStudents(); 
                    } catch(e) {}
                }
                const res = await fetch(`${API_BASE}/api/students`);
                if (res.ok) {
                    const freshData = await res.json();
                    if (JSON.stringify(freshData) !== JSON.stringify(allStudents)) {
                        allStudents = freshData;
                        renderStudents();
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function fetchHistory() {
            try {
                const cachedData = localStorage.getItem('fb_mock_history_data');
                if (cachedData) {
                    try { 
                        allViolations = JSON.parse(cachedData); 
                        renderViolations(); 
                    } catch(e) {}
                }
                const res = await fetch(`${API_BASE}/api/history`);
                if (res.ok) {
                    const freshData = await res.json();
                    if (JSON.stringify(freshData) !== JSON.stringify(allViolations)) {
                        allViolations = freshData;
                        renderViolations();
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function fetchClasses() {
            try {
                const res = await fetch(`${API_BASE}/api/classes`);
                const classes = await res.json();
                const area = document.getElementById('classListArea');
                const sel = document.getElementById('editClass');
                area.innerHTML = ''; sel.innerHTML = '<option value="">-- Ch·ªçn l·ªõp --</option>';
                classes.forEach(c => {
                    const tag = document.createElement('div');
                    tag.style = "background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;";
                    tag.innerHTML = `${c.name} <span style="cursor: pointer; color: #ef4444; font-weight: bold;" onclick="deleteClass('${c.name}')">√ó</span>`;
                    area.appendChild(tag);
                    const opt = document.createElement('option');
                    opt.value = c.name; opt.textContent = c.name;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error(e); }
        }

        function renderStudents() {
            const tbody = document.getElementById('studentManageBody');
            tbody.innerHTML = '';
            const q = document.getElementById('searchStudent').value.toLowerCase();
            const filtered = allStudents.filter(s => s.name.toLowerCase().includes(q) || (s.class_name && s.class_name.toLowerCase().includes(q)) || s.id.toLowerCase().includes(q));
            
            renderPagination('studentPagination', filtered.length, studentPage, p => { studentPage = p; renderStudents(); });
            const data = filtered.slice((studentPage - 1) * pageSize, studentPage * pageSize);
            
            data.forEach(s => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="/api/students/${s.id}/photo" class="student-img" onerror="this.src='../logo.png'" onclick="showImg(this.src)">
                            <div>
                                <div style="font-weight: 700; font-size: 0.85rem;">${s.name}</div>
                                <div style="font-size: 0.7rem; color: #94a3b8;">ID: ${s.id} | ${s.stars} ‚≠ê</div>
                            </div>
                        </div>
                    </td>
                    <td style="font-size: 0.85rem; font-weight: 600;">L·ªõp ${s.class_name}</td>
                    <td style="text-align: right; white-space: nowrap;">
                        <button type="button" class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: rgba(255,255,255,0.05); color: white;" onclick="openEditStudent('${s.id}')">‚úèÔ∏è S·ª≠a</button>
                        <button type="button" class="btn" style="padding: 4px 8px; font-size: 0.75rem; background: rgba(239,68,68,0.1); color: #ef4444;" onclick="deleteStudent('${s.id}')">üóëÔ∏è X√≥a</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderViolations() {
            const tbody = document.getElementById('violationManageBody');
            tbody.innerHTML = '';
            const q = document.getElementById('searchViolation').value.toLowerCase();
            
            const filtered = allViolations.filter(v => {
                const sName = (v.student_name || "N/A").toLowerCase();
                const tName = (v.type_name || "").toLowerCase();
                const sId = (v.student_id || "").toLowerCase();
                return sName.includes(q) || tName.includes(q) || sId.includes(q);
            });
            
            renderPagination('violationPagination', filtered.length, violationPage, p => { violationPage = p; renderViolations(); });
            const data = filtered.slice((violationPage - 1) * pageSize, violationPage * pageSize);

            data.forEach(v => {
                const s = allStudents.find(x => x.id === v.student_id);
                const isMerit = v.points_change > 0;
                
                // Backup info if Left Join data is null
                const displayName = v.student_name || "H·ªçc sinh ƒë√£ b·ªã x√≥a";
                const displayClass = v.class_name ? `L·ªõp ${v.class_name}` : "N/A";
                const displayPhoto = s ? s.photo : "";

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="/api/students/${v.student_id}/photo" class="student-img" onerror="this.src='../logo.png'" onclick="showImg(this.src)">
                            <div>
                                <div style="font-weight: 700; font-size: 0.85rem;">${displayName}</div>
                                <div style="font-size: 0.7rem; color: #94a3b8;">${displayClass} | ID: ${v.student_id || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="font-size: 0.85rem; font-weight: 600; color: ${isMerit ? '#10b981' : '#ef4444'};">${v.type_name}</div>
                        <div style="font-size: 0.65rem; color: #64748b;">${new Date(v.timestamp).toLocaleString('vi-VN')}</div>
                    </td>
                    <td style="text-align: right;">
                        <button type="button" class="btn" style="padding: 5px 10px; font-size: 0.7rem; background: rgba(99,102,241,0.1); color: #818cf8; border: 1px solid rgba(99,102,241,0.2);" onclick="undoViolation('${v.id}')">‚Ü©Ô∏è Ho√†n t√°c</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderPagination(elId, totalCount, current, onPageChange) {
            const el = document.getElementById(elId);
            el.innerHTML = '';
            const totalPages = Math.ceil(totalCount / pageSize);
            if (totalPages <= 1) return;

            const createBtn = (page, text, active = false, disabled = false) => {
                const btn = document.createElement('button');
                btn.className = `page-btn ${active ? 'active' : ''}`;
                btn.innerHTML = text;
                btn.disabled = disabled;
                if (!disabled) {
                    btn.onclick = (e) => { 
                        e.stopPropagation();
                        onPageChange(page); 
                        el.closest('.card').scrollIntoView({ behavior: 'smooth' }); 
                    };
                }
                return btn;
            };

            // Previous Button
            el.appendChild(createBtn(current - 1, '‚Äπ Tr∆∞·ªõc', false, current === 1));

            // Logic for smart page numbers
            let pages = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) pages.push(i);
            } else {
                pages.push(1);
                if (current > 4) pages.push('...');
                
                let start = Math.max(2, current - 1);
                let end = Math.min(totalPages - 1, current + 1);
                
                if (current <= 4) {
                     start = 2;
                     end = 4;
                } else if (current >= totalPages - 3) {
                     start = totalPages - 3;
                     end = totalPages - 1;
                }

                for (let i = start; i <= end; i++) {
                    if (pages.indexOf(i) === -1) pages.push(i);
                }

                if (current < totalPages - 3) pages.push('...');
                if (pages.indexOf(totalPages) === -1) pages.push(totalPages);
            }

            pages.forEach(p => {
                if (p === '...') {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.style.padding = '0 10px';
                    span.style.color = '#94a3b8';
                    el.appendChild(span);
                } else {
                    el.appendChild(createBtn(p, p, p === current));
                }
            });

            // Next Button
            el.appendChild(createBtn(current + 1, 'Sau ‚Ä∫', false, current === totalPages));
        }

        function renderConfigs(node, id) {
            const el = document.getElementById(id), list = configs[node];
            el.innerHTML = '';
            Object.entries(list).forEach(([k, v]) => {
                const item = document.createElement('div');
                item.style = "display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem;";
                item.innerHTML = `<span>${v.name} (${v.points > 0 ? '+' : ''}${v.points})</span><button type="button" style="background: none; border: none; color: #ef4444; font-weight: bold; cursor: pointer;" onclick="deleteConfig('${node}', '${k}')">√ó</button>`;
                el.appendChild(item);
            });
        }

        // Actions
        async function addAdminAccount() {
            const username = document.getElementById('adminId').value.trim().toUpperCase();
            const password = document.getElementById('adminPass').value.trim();
            const role = document.getElementById('adminRole').value;
            if (!username || !password) return;
            const res = await fetch(`${API_BASE}/api/admins`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, password, role }) });
            if (res.ok) { fetchAdmins(); document.getElementById('createAdminForm').reset(); }
        }

        async function deleteAdmin(u) { 
            showConfirm(`X√°c nh·∫≠n: X√≥a t√†i kho·∫£n ${u}?`, async () => {
                await fetch(`${API_BASE}/api/admins/${u}`, { method: 'DELETE' }); 
                fetchAdmins(); 
            });
        }

        async function saveDefaultStars() {
            const val = parseInt(document.getElementById('defaultStarInput').value) || 0;
            showConfirm(`B·∫°n c√≥ ch·∫Øc mu·ªën l∆∞u m·ª©c ƒëi·ªÉm ban ƒë·∫ßu l√† ${val} sao?`, async () => {
                await fetch(`${API_BASE}/api/settings/default_stars`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ default_stars: val }) });
                fetchConfigs();
            });
        }

        async function applyDefaultToAll() {
            const val = configs.DefaultStars;
            showConfirm(`C·∫¢NH B√ÅO: H√†nh ƒë·ªông n√†y s·∫Ω RESET to√†n b·ªô h·ªçc sinh v·ªÅ m·ª©c ${val} sao. Ti·∫øp t·ª•c?`, async () => {
                await fetch(`${API_BASE}/api/students/recalculate_all`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ default_stars: val }) });
                init();
            });
        }

        async function deleteAllViolations() {
            showConfirm('C·∫¢NH B√ÅO C·ª∞C ƒê·ªò: B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA S·∫†CH to√†n b·ªô l·ªãch s·ª≠ vi ph·∫°m kh√¥ng?', async () => {
                await fetch(`${API_BASE}/api/history/reset_all`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ default_stars: configs.DefaultStars }) });
                init();
            });
        }

        async function addConfig(node) {
            const prefix = node === 'ViolationTypes' ? 'newV' : 'newR';
            const name = document.getElementById(`${prefix}Type`).value.trim();
            let points = parseInt(document.getElementById(`${prefix}Point`).value) || 0;
            if (!name || points === 0) return;

            // ƒê·∫£m b·∫£o Vi ph·∫°m lu√¥n l√† s·ªë √¢m (-), Khen th∆∞·ªüng lu√¥n l√† s·ªë d∆∞∆°ng (+)
            if (node === 'ViolationTypes') {
                points = -Math.abs(points);
            } else {
                points = Math.abs(points);
            }

            await fetch(`${API_BASE}/api/settings/${node.toLowerCase()}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, points }) });
            document.getElementById(`${prefix}Type`).value = ''; document.getElementById(`${prefix}Point`).value = ''; fetchConfigs();
        }

        async function deleteConfig(node, k) { 
            showConfirm(`X√≥a lo·∫°i ${node === 'ViolationTypes' ? 'vi ph·∫°m' : 'khen th∆∞·ªüng'} n√†y?`, async () => {
                await fetch(`${API_BASE}/api/settings/${node.toLowerCase()}/${k}`, { method: 'DELETE' }); 
                fetchConfigs(); 
            });
        }

        async function deleteStudent(id) {
            showConfirm('X√°c nh·∫≠n: X√ìA h·ªçc sinh n√†y v√† to√†n b·ªô l·ªãch s·ª≠ vi ph·∫°m?', async () => {
                const res = await fetch(`${API_BASE}/api/students/${id}`, { method: 'DELETE' });
                if (res.ok) { fetchStudents(); }
            });
        }

        async function undoViolation(id) { 
            showConfirm('H√†nh ƒë·ªông n√†y s·∫Ω x√≥a b·∫£n ghi v√† ho√†n l·∫°i ƒëi·ªÉm cho h·ªçc sinh. Ti·∫øp t·ª•c?', async () => {
                await fetch(`${API_BASE}/api/history/${id}`, { method: 'DELETE' }); 
                init(); 
            });
        }

        async function addClass() {
            const name = document.getElementById('className').value.trim();
            if (!name) return;
            await fetch(`${API_BASE}/api/classes`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
            document.getElementById('className').value = ''; fetchClasses();
        }

        async function deleteClass(n) { 
            showConfirm(`X√≥a l·ªõp ${n}?`, async () => {
                await fetch(`${API_BASE}/api/classes/${n}`, { method: 'DELETE' }); 
                fetchClasses(); 
            });
        }

        function openEditStudent(id) {
            const s = allStudents.find(x => x.id === id);
            if (!s) return;
            document.getElementById('editSid').value = id;
            document.getElementById('editName').value = s.name;
            document.getElementById('editClass').value = s.class_name;
            document.getElementById('editStudentModal').style.display = 'flex';
        }

        async function saveStudentEdit() {
            const id = document.getElementById('editSid').value;
            const name = document.getElementById('editName').value;
            const class_name = document.getElementById('editClass').value;
            await fetch(`${API_BASE}/api/students`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ id, name, class_name, is_update: true }) 
            });
            closeEditModal(); fetchStudents();
        }

        function closeEditModal() { document.getElementById('editStudentModal').style.display = 'none'; }
        function logout() { sessionStorage.clear(); window.location.href = '../index.html'; }
        function showImg(s) { if (!s) return; document.getElementById('imgFull').src = s; document.getElementById('imageModal').style.display = 'flex'; }
        function closeImg() { document.getElementById('imageModal').style.display = 'none'; }
        
        function filterStudents() { studentPage = 1; renderStudents(); }
        function filterViolations() { violationPage = 1; renderViolations(); }

        function exportStudentsExcel() {
            const ws = XLSX.utils.json_to_sheet(allStudents.map(s => ({ "MSHS": s.id, "H·ªç t√™n": s.name, "L·ªõp": s.class_name, "S·ªë sao": s.stars })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Students"); XLSX.writeFile(wb, "HocSinh.xlsx");
        }

        function exportViolationsExcel() {
            const ws = XLSX.utils.json_to_sheet(allViolations.map(v => ({ "Th·ªùi gian": new Date(v.timestamp).toLocaleString(), "H·ªçc sinh": v.student_name, "L·ªõp": v.class_name, "N·ªôi dung": v.type_name, "ƒêi·ªÉm": v.points_change })));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "History"); XLSX.writeFile(wb, "LichSu.xlsx");
        }
        window.addEventListener('socket_data_changed', init);
        setInterval(() => {
            fetchConfigs();
            fetchAdmins();
            fetchStudents();
            fetchHistory();
        }, 30000);
    </script>
</body>
</html>
