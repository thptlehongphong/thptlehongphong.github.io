<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=1100"><title>Admin 4 - C·ªông ƒêi·ªÉm R√®n Luy·ªán</title><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet"><script src="https://unpkg.com/html5-qrcode"></script><script src="../student_data.js"></script><script type="module" src="../firebase-backend.js"></script><style>:root{--primary:#6366f1;--success:#10b981;--glass:rgba(255, 255, 255, 0.05);--glass-border:rgba(255, 255, 255, 0.1)}*{margin:0;padding:0;box-sizing:border-box;font-family:Outfit,sans-serif}body{background:#0f172a;color:#fff;min-height:100vh;padding:20px 5%}.container{max-width:600px;margin:0 auto}.card{background:var(--glass);border:1px solid var(--glass-border);border-radius:24px;padding:25px;margin-bottom:20px}.search-box{display:flex;gap:10px;margin-bottom:20px}input[type=text]{flex:1;padding:14px;border-radius:12px;border:1px solid var(--glass-border);background:#1e293b;color:#fff;outline:0}.btn{padding:12px 20px;border-radius:12px;border:none;font-weight:600;cursor:pointer;transition:.3s}.btn-primary{background:var(--primary);color:#fff}.btn-success{background:var(--success);color:#fff;width:100%;margin-top:15px}.student-result{display:none;animation:fadeIn .5s}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.student-profile{display:flex;align-items:center;gap:20px;margin-bottom:25px}.profile-img{width:100px;height:100px;border-radius:15px;object-fit:cover;border:2px solid var(--success);cursor:zoom-in}.star-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(245,158,11,.2);color:#f59e0b;padding:5px 12px;border-radius:20px;font-weight:700;margin-top:10px}textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--glass-border);background:#1e293b;color:#fff;outline:0;margin-top:15px;min-height:100px}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:2000;justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal-content{max-width:90%;max-height:90%;border-radius:20px;border:2px solid var(--primary)}.notify-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,.9);z-index:10000;justify-content:center;align-items:center;backdrop-filter:blur(8px)}.notify-content{background:#1e293b;border:1px solid var(--glass-border);padding:30px;border-radius:24px;max-width:400px;width:90%;text-align:center;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);animation:modalPop .2s ease-out}@keyframes modalPop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}.notify-icon{font-size:40px;margin-bottom:15px;display:block}.notify-title{font-size:1.25rem;font-weight:700;margin-bottom:10px}.notify-msg{color:#cbd5e1;line-height:1.5;margin-bottom:25px;font-size:.95rem}.notify-error .notify-title{color:#ef4444}.notify-success .notify-title{color:#10b981}</style></head><body><div class="container"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3>Admin 4 - Khen Th∆∞·ªüng</h3><button style="background:0 0;border:none;color:#fff;cursor:pointer" onclick="logout()">Tho√°t</button></div><div class="card"><div class="search-box"><input type="text" id="searchId" placeholder="Nh·∫≠p MSHS ƒë·ªÉ khen th∆∞·ªüng..."> <button class="btn btn-primary" onclick="searchStudent()">T√¨m</button> <button class="btn" style="background:#818cf8;color:#fff;display:inline-flex;align-items:center;gap:5px" onclick="toggleScanner()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg> Qu√©t QR</button></div><div id="reader" style="width:100%;margin-bottom:20px;border-radius:12px;overflow:hidden;display:none"></div><div id="studentResult" class="student-result"><div class="student-profile"><img id="resImg" class="profile-img" src="" alt="" onclick="showImg(this.src)"><div><h2 id="resName"></h2><p id="resInfo" style="color:#94a3b8;font-size:.9rem"></p><div class="star-badge"><span id="resStars">0</span> ‚≠ê</div></div></div><div style="border-top:1px solid var(--glass-border);padding-top:20px"><p style="margin-bottom:15px;font-weight:600">Ch·ªçn l√Ω do khen th∆∞·ªüng:</p><div id="rewardOptionsContainer" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:15px"></div><textarea id="rewardNote" placeholder="Ghi ch√∫ chi ti·∫øt th√™m (n·∫øu c√≥)..." style="margin-top:15px;min-height:80px"></textarea> <button class="btn btn-success" onclick="submitReward()">X√°c Nh·∫≠n TƒÉng Sao</button></div></div><div id="noMatch" style="display:none;text-align:center;color:#ef4444;padding:20px">Kh√¥ng t√¨m th·∫•y h·ªçc sinh v·ªõi m√£ s·ªë n√†y!</div></div></div><div id="imageModal" class="modal" onclick="closeImg()"><img class="modal-content" id="imgFull"></div><div id="notifyModal" class="notify-modal"><div class="notify-content" id="notifyContent"><span id="notifyIcon" class="notify-icon"></span><h3 id="notifyTitle" class="notify-title"></h3><p id="notifyMsg" class="notify-msg"></p><button type="button" class="btn btn-primary" onclick="closeNotify()">ƒê·ªìng √Ω</button></div></div><script>let API_BASE="",currentRole=sessionStorage.getItem("kyluat_role"),rewardTypesConf=("admin4"!==currentRole&&"admin0"!==currentRole&&(window.location.href="../index.html"),{});async function checkSystemStatus(){try{var e=await(await fetch(API_BASE+"/api/settings")).json(),t=(new Date).toISOString().split("T")[0],n=e.expiry_date&&t>e.expiry_date,o=!1===JSON.parse(e.permissions||'{"admin1":true,"admin2":true,"admin3":true,"admin4":true}')[currentRole];(n||o)&&"admin0"!==currentRole&&(showNotify("Th√¥ng b√°o h·ªá th·ªëng",o?"Quy·ªÅn truy c·∫≠p c·ªßa b·∫°n ƒë√£ b·ªã t·∫°m kh√≥a!":"H·ªá th·ªëng ƒë√£ h·∫øt th·ªùi h·∫°n s·ª≠ d·ª•ng!",!0),setTimeout(()=>window.location.href="../index.html",3e3)),rewardTypesConf=JSON.parse(e.rewardtypes||"{}"),renderRewardOptions()}catch(e){console.error(e)}}function startApp(){checkSystemStatus(),setInterval(checkSystemStatus,3e4)}function renderRewardOptions(){let n=document.getElementById("rewardOptionsContainer");n.innerHTML="",0===Object.keys(rewardTypesConf).length?n.innerHTML='<p style="color:#94a3b8; grid-column:span 2;">Ch∆∞a c√≥ danh m·ª•c khen th∆∞·ªüng n√†o.</p>':Object.entries(rewardTypesConf).forEach(([,e])=>{var t=document.createElement("div");t.style="background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;",t.onclick=function(){var e=this.querySelector("input");e.checked=!e.checked,this.style.background=e.checked?"#ffffff":"rgba(255,255,255,0.03)",this.style.color=e.checked?"#0f172a":"white",this.style.fontWeight=e.checked?"700":"normal"},t.className="r-item",t.dataset.points=e.points,t.innerHTML=`
                    <input type="checkbox" value="${e.name}" style="pointer-events:none;">
                    <span>${e.name} <small style="color:#10b981">(+${e.points})</small></span>
                `,n.appendChild(t)})}function showImg(e){e&&(document.getElementById("imgFull").src=e,document.getElementById("imageModal").style.display="flex")}function closeImg(){document.getElementById("imageModal").style.display="none"}function showNotify(e,t,n=!1){var o=document.getElementById("notifyModal"),a=document.getElementById("notifyContent"),r=document.getElementById("notifyIcon"),i=document.getElementById("notifyTitle"),s=document.getElementById("notifyMsg");a.className="notify-content "+(n?"notify-error":"notify-success"),r.innerText=n?"‚ö†Ô∏è":"‚úÖ",i.innerText=e,s.innerText=t,o.style.display="flex"}function closeNotify(){document.getElementById("notifyModal").style.display="none"}window.firebaseBackendReady?startApp():window.addEventListener("firebaseBackendReady",startApp);let currentStudent=null,html5QrCode=null;function toggleScanner(){var e=document.getElementById("reader");"none"===e.style.display?(e.style.display="block",startScanner()):(stopScanner(),e.style.display="none")}async function startScanner(){html5QrCode=new Html5Qrcode("reader");try{await html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},async e=>{document.getElementById("searchId").value=e.trim().toUpperCase(),await searchStudent(),showNotify("QR Code","ƒê√£ nh·∫≠n di·ªán m√£: "+e),toggleScanner()})}catch(e){showNotify("L·ªói Camera","Kh√¥ng th·ªÉ truy c·∫≠p camera!",!0),document.getElementById("reader").style.display="none"}}async function stopScanner(){if(html5QrCode)try{await html5QrCode.stop(),html5QrCode=null}catch(e){}}function renderStudentDataAdmin4(e){currentStudent=e,document.getElementById("resImg").src=`/api/students/${e.id}/photo`,document.getElementById("resImg").onerror=function(){this.src="/logo.png"},document.getElementById("resName").textContent=e.name,document.getElementById("resInfo").textContent=`L·ªõp: ${e.class_name||e.class} | ID: `+e.id,document.getElementById("resStars").textContent=e.stars||0,document.getElementById("studentResult").style.display="block",document.getElementById("noMatch").style.display="none"}async function searchStudent(){let t=document.getElementById("searchId").value.trim().toUpperCase();if(t)try{var e=localStorage.getItem("fb_mock_students_data");if(e)try{var n=JSON.parse(e).find(e=>e.id===t);n&&renderStudentDataAdmin4(n)}catch(e){}var o,a,r=await fetch(API_BASE+"/api/students/"+t);r.ok?((o=await r.json()).photo||"undefined"==typeof STATIC_STUDENTS||(a=STATIC_STUDENTS.find(e=>e.id===t))&&(o.photo=a.photo),renderStudentDataAdmin4(o)):(currentStudent=null,document.getElementById("studentResult").style.display="none",document.getElementById("noMatch").style.display="block")}catch(e){showNotify("L·ªói","L·ªói t√¨m ki·∫øm h·ªçc sinh!",!0)}}async function submitReward(){if(currentStudent){var e=document.querySelectorAll(".r-item input:checked");let n=[],o=0;if(e.forEach(e=>{var t=e.closest(".r-item");n.push(e.value),o+=parseInt(t.dataset.points)||1}),0===n.length)return showNotify("Thi·∫øu th√¥ng tin","Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m·ª•c khen th∆∞·ªüng!",!0);e=document.getElementById("rewardNote").value.trim(),e="üëç Khen th∆∞·ªüng: "+n.join(", ")+(e?` (Chi ti·∫øt: ${e})`:""),e={student_id:currentStudent.id,type_name:e,points_change:o,is_merit:!0,created_by:sessionStorage.getItem("kyluat_id")};try{(await fetch(API_BASE+"/api/history",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok?(showNotify("Th√†nh c√¥ng",`ƒê√£ t·∫∑ng ${o} sao cho h·ªçc sinh th√†nh c√¥ng!`),setTimeout(()=>location.reload(),2e3)):showNotify("L·ªói","L·ªói khi l∆∞u khen th∆∞·ªüng l√™n h·ªá th·ªëng!",!0)}catch(e){showNotify("L·ªói k·∫øt n·ªëi","L·ªói k·∫øt n·ªëi m√°y ch·ªß!",!0)}}}function logout(){sessionStorage.clear(),window.location.href="../index.html"}</script></body></html>