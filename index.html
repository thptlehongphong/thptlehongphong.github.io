<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1100">
    <title>Theo d√µi r√®n luy·ªán</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WGFH09SJ3J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WGFH09SJ3J');
</script>
    <style>
        /* ... existing styles ... */
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: white;
            min-height: 100vh;
        }

        .navbar {
            padding: 20px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #818cf8, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-container {
            padding: 40px 5%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }



        .card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
        }

        .login-section h2 {
            margin-bottom: 24px;
            font-size: 1.8rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 16px;
            background: #1e293b; /* C·∫£i thi·ªán ƒë·ªô t∆∞∆°ng ph·∫£n: n·ªÅn ƒë·∫≠m h∆°n */
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: #ffffff; /* Ch·ªØ tr·∫Øng r√µ n√©t */
            outline: none;
            transition: 0.3s;
            appearance: none; /* Lo·∫°i b·ªè style m·∫∑c ƒë·ªãnh c·ªßa browser ƒë·ªÉ shadow ƒë·∫πp h∆°n */
            -webkit-appearance: none;
        }

        .input-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
        }

        .input-group select option {
            background-color: #0f172a;
            color: white;
        }

        .input-group input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .violation-list h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .live-tag {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--danger);
            border-radius: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            text-align: left;
            padding: 15px;
            color: #94a3b8;
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--glass-border);
            cursor: zoom-in;
            transition: 0.2s;
        }

        .student-img:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .violation-tag, .status-merit {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 4px;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }

        .violation-tag {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-merit {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .btn-more {
            color: var(--primary);
            font-size: 0.75rem;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 5px;
            font-weight: 600;
        }

        /* Modal Preview */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 20px;
            border: 2px solid var(--primary);
        }

        /* Premium Detail Modal */
        #detailModal {
            backdrop-filter: blur(10px);
            background: rgba(15, 23, 42, 0.8);
        }

        #detailModal .modal-content-text {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 32px;
            border-radius: 28px;
            max-width: 480px;
            width: 90%;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #detailModal h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #fullDetailText {
            line-height: 1.7;
            color: #cbd5e1;
            font-size: 1.05rem;
            text-align: left;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 24px;
            white-space: pre-wrap; /* Gi·ªØ ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng n·∫øu c√≥ */
            word-break: break-word;
        }

        #detailModal .btn-close {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 0;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
        }

        #detailModal .btn-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.5);
        }

        .nav-login {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-login input {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            width: 120px;
            outline: none;
        }

        .nav-login input:focus { border-color: var(--primary); }

        .rank-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.3s;
        }
        .rank-card:hover { transform: translateY(-3px); border-color: var(--primary); background: rgba(255,255,255,0.06); }
        
        .rank-number {
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.8rem;
            background: var(--glass-border);
        }
        .top-1 .rank-number { background: #ffd700; color: #000; }
        .top-2 .rank-number { background: #c0c0c0; color: #000; }
        .top-3 .rank-number { background: #cd7f32; color: #000; }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 25px;
        }
        .page-btn {
            padding: 8px 14px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: #94a3b8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.3s;
        }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .class-rank-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .danger-text { color: var(--danger); font-weight: 700; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">THPT L√ä H·ªíNG PHONG</div>
        <div id="navLoginArea" class="nav-login">
            <input type="text" id="loginId" placeholder="ID">
            <input type="password" id="loginPass" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-primary" style="width: auto; padding: 8px 15px; font-size: 0.8rem;" onclick="handleLogin()">V√†o Qu·∫£n Tr·ªã</button>
        </div>
        <div id="userInfo" style="display: none;"></div>
    </nav>

    <div class="main-container">
        <!-- Top Section: Today Stats -->
        <div class="stats-bar" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="card" style="text-align: center; padding: 20px;">
                <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px;">Vi ph·∫°m h√¥m nay</p>
                <h2 id="todayCount" style="color: var(--danger); font-size: 2rem;">0</h2>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px;">Khen th∆∞·ªüng h√¥m nay</p>
                <h2 id="todayMerit" style="color: #10b981; font-size: 2rem;">0</h2>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px;">S·ªë l∆∞·ª£ng h·ªçc sinh to√†n tr∆∞·ªùng</p>
                <h2 id="studentCount" style="color: var(--primary); font-size: 2rem;">0</h2>
            </div>
        </div>

        <!-- Section 1: History (Violations) -->
        <div class="card" style="margin-bottom: 40px; min-height: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;">
                <h2 style="font-size: 1.5rem;">üìÖ B·∫£ng Theo Vi ph·∫°m - Khen th∆∞·ªüng <span class="live-tag">Live</span></h2>
                <div style="display: flex; gap: 15px;">
                    <input type="text" id="filterName" placeholder="T√¨m t√™n/l·ªõp..." style="width: 200px; padding: 10px; border-radius: 12px; background: #1e293b; border: 1px solid var(--glass-border); color: white;" oninput="applyFilters()">
                    <select id="filterType" style="padding: 10px; border-radius: 12px; background: #1e293b; border: 1px solid var(--glass-border); color: white;" onchange="applyFilters()">
                        <option value="">T·∫•t c·∫£ lo·∫°i h√¨nh</option>
                    </select>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>H·ªçc Sinh</th>
                            <th>L·ªõp</th>
                            <th>N·ªôi dung l·ªói / Khen th∆∞·ªüng</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="violationTableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="violationPagination"></div>
        </div>

        <!-- Section 2: Student Leaderboard (Searchable) -->
        <div class="card" style="margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;">
                <h2 style="font-size: 1.5rem;">üëë B·∫£ng X·∫øp H·∫°ng H·ªçc Sinh To√†n Tr∆∞·ªùng</h2>
                <div style="display: flex; gap: 15px;">
                    <select id="sortRankOrder" style="padding: 10px; border-radius: 12px; background: #1e293b; border: 1px solid var(--glass-border); color: white;" onchange="renderStudentLeaderboard()">
                        <option value="desc">‚≠ê Th√†nh t√≠ch t·ªët nh·∫•t</option>
                        <option value="asc">‚ö†Ô∏è C·∫ßn c·ªë g·∫Øng (T·ª´ th·∫•p l√™n)</option>
                    </select>
                    <input type="text" id="searchRankStudent" placeholder="T√¨m t√™n/l·ªõp..." style="width: 250px; padding: 10px; border-radius: 12px; background: #1e293b; border: 1px solid var(--glass-border); color: white;" oninput="renderStudentLeaderboard()">
                </div>
            </div>
            <div class="leaderboard-list" id="studentLeaderboardGrid" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Content will be rendered here -->
            </div>
            <div class="pagination" id="studentRankPagination"></div>
        </div>

        <!-- Section 3: Class Leaderboard -->
        <div class="card">
            <h2 style="font-size: 1.5rem; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;">üìä Thi ƒêua Gi·ªØa C√°c Kh·ªëi L·ªõp</h2>
            <div class="leaderboard-list" id="classLeaderboardGrid" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Content will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeImg()">
        <img class="modal-content" id="imgFull">
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal" onclick="closeDetail()">
        <div class="modal-content-text" onclick="event.stopPropagation()">
            <h3><span>üìë</span> N·ªôi Dung Chi Ti·∫øt</h3>
            <p id="fullDetailText"></p>
            <button class="btn-close" onclick="closeDetail()">ƒê√≥ng c·ª≠a s·ªï</button>
        </div>
    </div>

    <script src="Kyluat/firebase.config.js"></script>
    <script>
        const tableBody = document.getElementById('violationTableBody');
        const studentRankGrid = document.getElementById('studentLeaderboardGrid');
        const classRankGrid = document.getElementById('classLeaderboardGrid');

        // Admin 0 (Super Admin) - C·ªë ƒë·ªãnh ƒë·ªÉ qu·∫£n tr·ªã g·ªëc
        const ADMIN_0_ID = "ADMIN";
        const ADMIN_0_PASS = "tranhuyhoang";

        let allViolations = [];
        let filteredViolations = [];
        let allStudents = [];
        let violationPage = 1;
        let studentRankPage = 1;
        const pageSize = 5;

        let systemConfig = { status: 'active', expiryDate: '', message: '' };
        let admin1List = {};

        // Check system status first
        function checkSystemStatus() {
            rootRef.child('Settings').on('value', snap => {
                const data = snap.val() || {};
                systemConfig = data.Config || systemConfig;
                // Update Admin List logic
                admin1List = data.Admin1List || {};

                // Update Filter Options Dynamically
                populateFilterOptions(data.ViolationTypes || {}, data.RewardTypes || {});

                const today = new Date().toISOString().split('T')[0];
                const isExpired = systemConfig.expiryDate && today > systemConfig.expiryDate;
                const isLocked = systemConfig.status === 'locked';

                if (isExpired || isLocked) {
                    // N·∫øu l√† admin0 ƒëang login trong session th√¨ v·∫´n cho xem
                    if (sessionStorage.getItem('kyluat_role') !== 'admin0') {
                        const msg = systemConfig.message || (isExpired ? "H·ªá th·ªëng ƒë√£ h·∫øt th·ªùi h·∫°n s·ª≠ d·ª•ng!" : "H·ªá th·ªëng hi·ªán ƒëang b·ªã kh√≥a!");
                        document.body.innerHTML = `
                            <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#0f172a; color:white; font-family:'Outfit', sans-serif; text-align:center; padding:20px;">
                                <h1 style="color:#ef4444; font-size:4rem; margin-bottom:20px;">üõë</h1>
                                <h2 style="margin-bottom:10px;">TH√îNG B√ÅO T·ª™ QU·∫¢N TR·ªä VI√äN</h2>
                                <p style="color:#94a3b8; font-size:1.1rem; max-width:500px;">${msg}</p>
                                <button onclick="location.reload()" style="margin-top:30px; padding:12px 24px; border-radius:12px; border:none; background:#6366f1; color:white; cursor:pointer;">Th·ª≠ l·∫°i</button>
                            </div>
                        `;
                    }
                }
            });
        }
        
        function populateFilterOptions(vTypes, rTypes) {
            const select = document.getElementById('filterType');
            // Keep the first default option
            select.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i h√¨nh</option>';
            
            // Add Violation Types (Grouped if possible, but simple list for now)
            if (Object.keys(vTypes).length > 0) {
                const grp = document.createElement('optgroup');
                grp.label = "‚ö†Ô∏è L·ªói Vi Ph·∫°m";
                Object.values(vTypes).forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.name;
                    opt.textContent = v.name;
                    grp.appendChild(opt);
                });
                select.appendChild(grp);
            }

            // Add Reward Types
            if (Object.keys(rTypes).length > 0) {
                const grp = document.createElement('optgroup');
                grp.label = "‚ú® Khen Th∆∞·ªüng";
                Object.values(rTypes).forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.name;
                    opt.textContent = r.name;
                    grp.appendChild(opt);
                });
                const generalReward = document.createElement('option');
                generalReward.value = "Khen th∆∞·ªüng";
                generalReward.textContent = "Khen th∆∞·ªüng (Chung)";
                grp.appendChild(generalReward);
                select.appendChild(grp);
            }
        }
        checkSystemStatus();

        async function handleLogin() {
            const idInput = document.getElementById('loginId').value.trim();
            const id = idInput.toUpperCase();
            const pass = document.getElementById('loginPass').value.trim();

            if (!id || !pass) return;

            // 1. Check Admin 0 (Highest priority, works even if locked)
            if (id === ADMIN_0_ID && pass === ADMIN_0_PASS) {
                sessionStorage.setItem('kyluat_role', 'admin0');
                sessionStorage.setItem('kyluat_id', id);
                window.location.href = 'Kyluat/admin0.html';
                return;
            }

            // Check if system is restricted for others
            const today = new Date().toISOString().split('T')[0];
            const isRestricted = (systemConfig.expiryDate && today > systemConfig.expiryDate) || systemConfig.status === 'locked';
            if (isRestricted) {
                alert(systemConfig.message || "H·ªá th·ªëng ƒëang b·ªã t·∫°m kh√≥a ho·∫∑c h·∫øt h·∫°n. Vui l√≤ng li√™n h·ªá Admin 0.");
                return;
            }

            // 2. Check Admin 1 List (Fetched from Firebase Settings/Admin1List)
            if (admin1List && admin1List[id] && admin1List[id].pass === pass) {
                sessionStorage.setItem('kyluat_role', 'admin1');
                sessionStorage.setItem('kyluat_id', id);
                window.location.href = 'Kyluat/admin1.html';
                return;
            }

            // 3. Check other Admins (Admins node - for Admin 2, 3, 4)
            const snapshot = await rootRef.child('Admins').child(id).once('value');
            const data = snapshot.val();

            if (data && data.pass === pass) {
                sessionStorage.setItem('kyluat_role', data.role);
                sessionStorage.setItem('kyluat_id', id);
                window.location.href = `Kyluat/admin${data.role.replace('admin', '')}.html`;
            } else {
                alert('ID ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
            }
        }

        function initData() {
            // Fetch Students first
            rootRef.child('Students').on('value', snap => {
                allStudents = [];
                snap.forEach(s => {
                    allStudents.push({ id: s.key, ...s.val() });
                });
                document.getElementById('studentCount').textContent = allStudents.length;
                renderStudentLeaderboard();
                renderClassLeaderboard();
                if (allViolations.length > 0) renderTable();
            });

            // Fetch Violations
            rootRef.child('Violations').on('value', snap => {
                allViolations = [];
                snap.forEach(v => {
                    allViolations.push(v.val());
                });
                allViolations.sort((a, b) => b.timestamp - a.timestamp);
                
                // Stats
                const today = new Date().toDateString();
                const todayData = allViolations.filter(v => new Date(v.timestamp).toDateString() === today);
                document.getElementById('todayCount').textContent = todayData.filter(v => !v.violationType.includes('Khen th∆∞·ªüng')).length;
                document.getElementById('todayMerit').textContent = todayData.filter(v => v.violationType.includes('Khen th∆∞·ªüng')).length;
                
                applyFilters();
            });
        }

        function applyFilters() {
            const nameQ = document.getElementById('filterName').value.toLowerCase();
            const typeQ = document.getElementById('filterType').value;

            filteredViolations = allViolations.filter(v => {
                const matchesName = v.studentName.toLowerCase().includes(nameQ) || 
                                   v.studentClass.toLowerCase().includes(nameQ) || 
                                   (v.studentId && v.studentId.toLowerCase().includes(nameQ));
                const matchesType = typeQ === "" ? true : v.violationType.includes(typeQ);
                return matchesName && matchesType;
            });

            violationPage = 1;
            renderTable();
        }

        function renderTable() {
            tableBody.innerHTML = '';
            const start = (violationPage - 1) * pageSize;
            const end = start + pageSize;
            const data = filteredViolations.slice(start, end);

            data.forEach(item => {
                const dt = new Date(item.timestamp);
                const isMerit = item.violationType.includes('Khen th∆∞·ªüng');
                const isLong = item.violationType.length > 25;
                const displayText = isLong ? item.violationType.substring(0, 25) + '...' : item.violationType;
                
                // Get real-time info from allStudents for latest class and stars
                const student = allStudents.find(s => s.id === item.studentId);
                const currentClass = student ? student.class : item.studentClass;
                const stars = student ? (student.stars || 0) : 0;
                const starColor = stars <= -10 ? 'danger-text' : (stars >= 10 ? '#10b981' : '#f59e0b');

                const row = document.createElement('tr');
                row.style.animation = "fadeInUp 0.5s ease forwards";
                row.innerHTML = `
                    <td>
                        <div class="student-info">
                            <div style="position: relative;">
                                <img src="${item.studentPhoto}" class="student-img" onclick="showImg('${item.studentPhoto}')">
                                ${isMerit ? '<div style="position:absolute; bottom:-3px; right:-3px; background:#10b981; border-radius:50%; width:14px; height:14px; border:2px solid #0f172a;"></div>' : ''}
                            </div>
                            <div>
                                <p style="font-weight:700; font-size:0.9rem; color:#f8fafc;">${item.studentName}</p>
                                <p style="font-size:0.7rem; color:#64748b; letter-spacing:0.5px; font-weight:600;">ID: ${item.studentId || 'N/A'}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="display:flex; flex-direction:column; gap:4px;">
                            <span style="font-size:0.85rem; font-weight:700; color:#e2e8f0;">L·ªõp ${currentClass}</span>
                            <span style="font-size:0.75rem; color:${starColor}; font-weight:800; display:flex; align-items:center; gap:4px;">
                                ${stars} <span style="font-size:0.6rem;">‚≠ê</span>
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="violation-cell" style="display:flex; align-items:center; gap:8px;">
                            <span class="${isMerit ? 'status-merit' : 'violation-tag'}" style="margin-bottom:0; font-weight:600; padding:6px 12px;">
                                ${isMerit ? '‚ú® ' : '‚ö†Ô∏è '}${displayText}
                            </span>
                            ${isLong ? `<span class="btn-more" style="white-space:nowrap;" onclick="showDetail('${item.violationType.replace(/'/g, "\\'")}')">Chi ti·∫øt</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="text-align:right;">
                            <div style="font-weight:700; font-size:0.85rem; color:#f1f5f9;">${dt.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})}</div>
                            <div style="color:#64748b; font-size:0.7rem; font-weight:600;">${dt.toLocaleDateString('vi-VN')}</div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            renderPagination('violationPagination', filteredViolations.length, violationPage, (p) => { violationPage = p; renderTable(); });
        }

        function renderStudentLeaderboard() {
            const query = document.getElementById('searchRankStudent').value.toLowerCase();
            const sortOrder = document.getElementById('sortRankOrder').value; // 'asc' or 'desc'
            
            let list = [...allStudents];
            
            // Sort logic
            if (sortOrder === 'desc') {
                list.sort((a, b) => (b.stars || 0) - (a.stars || 0));
            } else {
                list.sort((a, b) => (a.stars || 0) - (b.stars || 0));
            }
            
            if (query) {
                list = list.filter(s => s.name.toLowerCase().includes(query) || (s.class && s.class.toLowerCase().includes(query)));
            }

            studentRankGrid.innerHTML = '';
            const start = (studentRankPage - 1) * pageSize;
            const end = start + pageSize;
            const pagedList = list.slice(start, end);

            pagedList.forEach((s, idx) => {
                const rank = start + idx + 1;
                const card = document.createElement('div');
                const highlight = (sortOrder === 'desc' && rank <= 3) ? 'top-' + rank : '';
                card.className = `rank-card ${highlight}`;
                // Set fixed height or layout if needed for list style
                card.style = "width: 100%; justify-content: space-between;"; 
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                        <div class="rank-number">${rank}</div>
                        <img src="${s.photo}" style="width:40px; height:40px; border-radius:10px; object-fit:cover; cursor:zoom-in;" onclick="showImg('${s.photo}')">
                        <div style="min-width:0;">
                            <div style="font-weight:700; font-size:1rem;">${s.name}</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">MSHS: ${s.id} | L·ªõp ${s.class || 'N/A'}</div>
                        </div>
                    </div>
                    <div style="font-weight:800; color:#f59e0b; font-size:1.1rem; min-width: 60px; text-align: right;">${s.stars || 0} ‚≠ê</div>
                `;
                studentRankGrid.appendChild(card);
            });
            renderPagination('studentRankPagination', list.length, studentRankPage, (p) => { studentRankPage = p; renderStudentLeaderboard(); });
        }

        function renderClassLeaderboard() {
            classRankGrid.innerHTML = '';
            const classes = {};
            const classCounts = {}; // Track number of students per class

            // Calculate Sum and Count
            allStudents.forEach(s => {
                const cls = s.class;
                if (!cls) return;
                classes[cls] = (classes[cls] || 0) + (s.stars || 0);
                classCounts[cls] = (classCounts[cls] || 0) + 1;
            });

            // Calculate Averages and convert to array for sorting
            const classAvg = [];
            for (const cls in classes) {
                const avg = classes[cls] / classCounts[cls];
                classAvg.push({ name: cls, avg: avg, total: classes[cls] });
            }

            // Sort by Average descending
            classAvg.sort((a, b) => b.avg - a.avg);

            classAvg.slice(0, 5).forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'class-rank-card';
                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div class="rank-number" style="background:rgba(255,255,255,0.1)">${idx + 1}</div>
                        <div style="font-size:1.1rem; font-weight:700;">L·ªõp ${item.name}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.7rem; color:#94a3b8;">ƒêi·ªÉm trung b√¨nh</div>
                        <div style="font-size:1.2rem; font-weight:800; color:var(--primary);">${item.avg.toFixed(2)} ‚≠ê</div>
                    </div>
                `;
                classRankGrid.appendChild(card);
            });
        }

        function renderPagination(elId, totalCount, current, onPageChange) {
            const el = document.getElementById(elId);
            el.innerHTML = '';
            const totalPages = Math.ceil(totalCount / pageSize);
            if (totalPages <= 1) return;

            // Show max 5 page buttons
            let start = Math.max(1, current - 2);
            let end = Math.min(totalPages, start + 4);
            if (end - start < 4) start = Math.max(1, end - 4);

            for (let i = start; i <= end; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === current ? 'active' : ''}`;
                btn.textContent = i;
                btn.onclick = () => {
                    onPageChange(i);
                    // Scroll to top of section
                    el.closest('.card').scrollIntoView({ behavior: 'smooth' });
                };
                el.appendChild(btn);
            }
        }

        function showDetail(text) {
            const modal = document.getElementById('detailModal');
            document.getElementById('fullDetailText').textContent = text;
            modal.style.display = 'flex';
        }
        function closeDetail() { document.getElementById('detailModal').style.display = 'none'; }
        
        function showImg(src) {
            const modal = document.getElementById('imageModal');
            document.getElementById('imgFull').src = src;
            modal.style.display = 'flex';
        }
        function closeImg() { document.getElementById('imageModal').style.display = 'none'; }

        initData();
    </script>
</body>
</html>
