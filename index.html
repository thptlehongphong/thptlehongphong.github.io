<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1100">
    <title>Theo d√µi r√®n luy·ªán</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script type="module" src="./firebase-backend.js"></script>
    <script src="student_data.js"></script>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/png" href="./logo.png">
    <link rel="shortcut icon" type="image/png" href="./logo.png">
    <link rel="apple-touch-icon" href="./logo.png">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-V3BHSCKTST"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-V3BHSCKTST');
</script>
    <style>
        /* ... existing styles ... */
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #0f172a;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: white;
            min-height: 100vh;
        }

        .navbar {
            padding: 20px 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(to right, #818cf8, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-container {
            padding: 40px 5%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 30px;
        }



        .card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
        }

        .login-section h2 {
            margin-bottom: 24px;
            font-size: 1.8rem;
        }

        .layout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .promo-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.9));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .promo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border-color: rgba(99, 102, 241, 0.4);
        }
        .promo-card.featured {
            border: 1px solid rgba(139, 92, 246, 0.4);
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.15);
            background: linear-gradient(145deg, rgba(46, 35, 76, 0.8), rgba(15, 23, 42, 0.9));
        }
        .promo-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, #818cf8, #f472b6);
        }
        .promo-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .promo-desc { font-size: 0.85rem; color: #94a3b8; margin-bottom: 20px; line-height: 1.6; flex-grow: 1; }
        .promo-btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 12px; border-radius: 12px; font-weight: 600; font-size: 0.9rem;
            color: white; text-decoration: none; transition: 0.3s;
            border: 1px solid transparent;
            margin-top: auto;
        }
        .btn-gradient { background: linear-gradient(135deg, #6366f1, #a855f7); }
        .btn-gradient:hover { background: linear-gradient(135deg, #4f46e5, #9333ea); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3); }
        .btn-outline-glass { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.1); }
        .btn-outline-glass:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 16px;
            background: #1e293b; /* C·∫£i thi·ªán ƒë·ªô t∆∞∆°ng ph·∫£n: n·ªÅn ƒë·∫≠m h∆°n */
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: #ffffff; /* Ch·ªØ tr·∫Øng r√µ n√©t */
            outline: none;
            transition: 0.3s;
            appearance: none; /* Lo·∫°i b·ªè style m·∫∑c ƒë·ªãnh c·ªßa browser ƒë·ªÉ shadow ƒë·∫πp h∆°n */
            -webkit-appearance: none;
        }

        .input-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 20px;
        }

        .input-group select option {
            background-color: #0f172a;
            color: white;
        }

        .input-group input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .violation-list h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .live-tag {
            font-size: 0.75rem;
            padding: 4px 8px;
            background: var(--danger);
            border-radius: 20px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th {
            text-align: left;
            padding: 15px;
            color: #94a3b8;
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-img {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--glass-border);
            cursor: zoom-in;
            transition: 0.2s;
        }

        .student-img:hover {
            border-color: var(--primary);
            transform: scale(1.1);
        }

        .violation-tag, .status-merit {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 4px;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }

        .violation-tag {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-merit {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .btn-more {
            color: var(--primary);
            font-size: 0.75rem;
            cursor: pointer;
            text-decoration: underline;
            margin-left: 5px;
            font-weight: 600;
        }

        /* Modal Preview */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            border-radius: 20px;
            border: 2px solid var(--primary);
        }

        /* Premium Detail Modal */
        #detailModal {
            backdrop-filter: blur(10px);
            background: rgba(15, 23, 42, 0.8);
        }

        #detailModal .modal-content-text {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 32px;
            border-radius: 28px;
            max-width: 480px;
            width: 90%;
            max-height: 70vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
            animation: modalSlideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #detailModal h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #6366f1;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #fullDetailText {
            line-height: 1.7;
            color: #cbd5e1;
            font-size: 1.05rem;
            text-align: left;
            overflow-y: auto;
            padding-right: 8px;
            margin-bottom: 24px;
            white-space: pre-wrap; /* Gi·ªØ ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng n·∫øu c√≥ */
            word-break: break-word;
        }

        #detailModal .btn-close {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 0;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: 0.3s;
        }

        #detailModal .btn-close:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.5);
        }

        .nav-login {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-login input {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--glass-border);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            width: 120px;
            outline: none;
        }

        .nav-login input:focus { border-color: var(--primary); }

        .rank-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: 0.3s;
        }
        .rank-card:hover { transform: translateY(-3px); border-color: var(--primary); background: rgba(255,255,255,0.06); }
        
        .rank-number {
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.8rem;
            background: var(--glass-border);
        }
        .top-1 .rank-number { background: #ffd700; color: #000; }
        .top-2 .rank-number { background: #c0c0c0; color: #000; }
        .top-3 .rank-number { background: #cd7f32; color: #000; }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 25px;
        }
        .page-btn {
            padding: 8px 14px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            color: #94a3b8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.3s;
        }
        .page-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
            border-color: var(--primary);
            color: white;
        }
        .page-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .class-rank-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(236, 72, 153, 0.1) 100%);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .danger-text { color: var(--danger); font-weight: 700; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* Custom Notification Modal */
        .notify-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.9); z-index: 10000;
            justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }
        .notify-content {
            background: #1e293b; border: 1px solid var(--glass-border); padding: 30px;
            border-radius: 24px; max-width: 400px; width: 90%; text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            animation: modalPop 0.2s ease-out;
        }
        @keyframes modalPop { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .notify-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .notify-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 10px; }
        .notify-msg { color: #cbd5e1; line-height: 1.5; margin-bottom: 25px; font-size: 0.95rem; }
        .notify-error .notify-title { color: #ef4444; }
        .notify-success .notify-title { color: #10b981; }
        /* Floating Button & Menu */
        .fixed-widget {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 15px;
        }

        .widget-btn {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .widget-btn:hover {
            transform: scale(1.1) rotate(15deg);
        }

        .widget-menu {
            position: absolute;
            bottom: 75px;
            right: 0;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 12px;
            min-width: 240px;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .widget-menu.active {
            display: flex;
        }

        .widget-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: #e2e8f0;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: 0.2s;
        }

        .widget-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(-5px);
        }

        .widget-item span {
            display: inline-block;
        }

        @media (max-width: 768px) {
            .fixed-widget { bottom: 20px; right: 20px; }
            .widget-btn { width: 50px; height: 50px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo" style="display: flex; align-items: center; gap: 10px;">
            <img src="./logo.png" alt="Logo" style="height: 35px; width: auto; border-radius: 8px;">
            THPT L√ä H·ªíNG PHONG
        </div>
        <div id="navLoginArea" class="nav-login">
            <input type="text" id="loginId" placeholder="ID">
            <input type="password" id="loginPass" placeholder="M·∫≠t kh·∫©u">
            <button class="btn-primary" style="width: auto; padding: 8px 15px; font-size: 0.8rem;" onclick="handleLogin()">V√†o Qu·∫£n Tr·ªã</button>
        </div>
        <div id="userInfo" style="display: none;"></div>
    </nav>

    <div class="main-container">
        <!-- Top Section: Today Stats -->
        <div class="stats-bar" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            <div class="card" style="text-align: center; padding: 20px;">
                <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px;">Vi ph·∫°m h√¥m nay</p>
                <h2 id="todayCount" style="color: var(--danger); font-size: 2rem;">0</h2>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px;">Khen th∆∞·ªüng h√¥m nay</p>
                <h2 id="todayMerit" style="color: #10b981; font-size: 2rem;">0</h2>
            </div>
            <div class="card" style="text-align: center; padding: 20px;">
                <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 5px;">S·ªë l∆∞·ª£ng h·ªçc sinh to√†n tr∆∞·ªùng</p>
                <h2 id="studentCount" style="color: var(--primary); font-size: 2rem;">0</h2>
            </div>
        </div>

        <!-- Section 1: History (Violations) -->
                <div class="card" style="margin-bottom: 40px; min-height: 600px;">
            <div style="display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px; gap: 15px;">
                <h2 style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px; margin: 0;">üìÖ B·∫£ng Theo Vi ph·∫°m <span class="live-tag" style="font-size: 0.65rem; padding: 2px 6px;">Live</span></h2>
                
                <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                    <div id="customDateRange" style="display: none; gap: 5px; align-items: center;">
                        <input type="date" id="filterStartDate" style="padding: 6px; border-radius: 8px; background: #1e293b; border: 1px solid var(--glass-border); color: white; font-size: 0.8rem;" onchange="applyFilters()">
                        <span style="color: #64748b; font-size: 0.75rem;">~</span>
                        <input type="date" id="filterEndDate" style="padding: 6px; border-radius: 8px; background: #1e293b; border: 1px solid var(--glass-border); color: white; font-size: 0.8rem;" onchange="applyFilters()">
                    </div>
                    <select id="filterTime" style="padding: 6px 10px; border-radius: 8px; background: #1e293b; border: 1px solid var(--glass-border); color: white; font-size: 0.8rem;" onchange="handleTimeChange()">
                        <option value="all">Th·ªùi gian</option>
                        <option value="today">H√¥m nay</option>
                        <option value="week">Tu·∫ßn n√†y</option>
                        <option value="month">Th√°ng n√†y</option>
                        <option value="custom">T√πy ch·ªânh...</option>
                    </select>
                    <select id="filterType" style="padding: 6px 10px; border-radius: 8px; background: #1e293b; border: 1px solid var(--glass-border); color: white; font-size: 0.8rem;" onchange="applyFilters()">
                        <option value="">Lo·∫°i h√¨nh</option>
                    </select>
                    <input type="text" id="filterName" placeholder="T√¨m t√™n/l·ªõp..." style="width: 130px; padding: 6px 10px; border-radius: 8px; background: #1e293b; border: 1px solid var(--glass-border); color: white; font-size: 0.8rem;" oninput="applyFilters()">
                    <button class="btn" style="background: #10b981; color: white; padding: 4px 10px; border-radius: 8px; font-weight: 600; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; width: auto; height: auto;" onclick="exportFilteredToExcel()">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        Excel
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>H·ªçc Sinh</th>
                            <th>L·ªõp</th>
                            <th>N·ªôi dung l·ªói / Khen th∆∞·ªüng</th>
                            <th>Th·ªùi gian</th>
                        </tr>
                    </thead>
                    <tbody id="violationTableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="violationPagination"></div>
        </div>

        <!-- Section 2: Student Leaderboard (Searchable) -->
        <div class="card" style="margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;">
                <h2 style="font-size: 1.5rem;">üëë B·∫£ng X·∫øp H·∫°ng H·ªçc Sinh To√†n Tr∆∞·ªùng</h2>
                <div style="display: flex; gap: 15px;">
                    <select id="sortRankOrder" style="padding: 10px; border-radius: 12px; background: #1e293b; border: 1px solid var(--glass-border); color: white;" onchange="renderStudentLeaderboard()">
                        <option value="desc">‚≠ê Th√†nh t√≠ch t·ªët nh·∫•t</option>
                        <option value="asc">‚ö†Ô∏è C·∫ßn c·ªë g·∫Øng (T·ª´ th·∫•p l√™n)</option>
                    </select>
                    <input type="text" id="searchRankStudent" placeholder="T√¨m t√™n/l·ªõp..." style="width: 250px; padding: 10px; border-radius: 12px; background: #1e293b; border: 1px solid var(--glass-border); color: white;" oninput="renderStudentLeaderboard()">
                </div>
            </div>
            <div class="leaderboard-list" id="studentLeaderboardGrid" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Content will be rendered here -->
            </div>
            <div class="pagination" id="studentRankPagination"></div>
        </div>

        <!-- Section 3: Class Leaderboard -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 15px;">
                <h2 style="font-size: 1.5rem; margin: 0;">üìä Thi ƒêua Gi·ªØa C√°c Kh·ªëi L·ªõp</h2>
                <select id="filterClassGrade" style="padding: 10px; border-radius: 12px; background: #1e293b; border: 1px solid var(--glass-border); color: white; font-size: 0.9rem;" onchange="renderClassLeaderboard()">
                    <option value="">T·∫•t c·∫£ kh·ªëi</option>
                </select>
            </div>
            <div class="leaderboard-list" id="classLeaderboardGrid" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Content will be rendered here -->
            </div>
            <div class="pagination" id="classRankPagination"></div>
        </div>

        <!-- Promotions Horizontal Section -->
        <h2 style="font-size: 1.5rem; margin: 40px 0 20px 0; display: flex; align-items: center; gap: 10px;">üåü G√≥c Th√¥ng Tin & Ti·ªán √çch</h2>
        <div class="layout-grid" style="align-items: stretch;">
            <div class="promo-card featured">
                <div class="promo-title">üß† Tham V·∫•n T√¢m L√Ω & H∆∞·ªõng Nghi·ªáp</div>
                <div class="promo-desc">Ch∆∞∆°ng tr√¨nh t∆∞ v·∫•n t√¢m l√Ω h·ªçc ƒë∆∞·ªùng chuy√™n s√¢u v√† ƒë·ªãnh h∆∞·ªõng ngh·ªÅ nghi·ªáp s·ªõm, gi√∫p h·ªçc sinh gi·∫£i t·ªèa √°p l·ª±c v√† ph·ª• huynh th·∫•u hi·ªÉu con c√°i.</div>
                <a href="#" class="promo-btn btn-gradient">ƒê·∫∑t L·ªãch T∆∞ V·∫•n</a>
            </div>
            
            <div class="promo-card" style="border-top-color: #f43f5e;">
                <style>.layout-grid .promo-card:nth-child(2)::before { background: linear-gradient(90deg, #f43f5e, #fb7185); }</style>
                <div class="promo-title">üé® Workshop S√°ng T·∫°o & Tr·∫£i Nghi·ªám</div>
                <div class="promo-desc">Chu·ªói s·ª± ki·ªán gi√°o d·ª•c k·ªπ nƒÉng cu·ªëi tu·∫ßn: Di·ªÖn thuy·∫øt tr∆∞·ªõc ƒë√°m ƒë√¥ng (TEDx Format), tranh bi·ªán (Debate), r√®n luy·ªán t∆∞ duy ph·∫£n bi·ªán.</div>
                <a href="#" class="promo-btn btn-outline-glass">SƒÉn V√© Tham Gia</a>
            </div>

            <div class="promo-card" style="border-top-color: #f59e0b;">
                 <style>.layout-grid .promo-card:nth-child(3)::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }</style>
                <div class="promo-title">ü§ù G√¢y Qu·ªπ H·ªçc B·ªïng & Ph·ª•c V·ª• C·ªông ƒê·ªìng</div>
                <div class="promo-desc">Ch∆∞∆°ng tr√¨nh thi·ªán nguy·ªán "M√°i ·∫§m T√¨nh Th∆∞∆°ng": K√™u g·ªçi t√†i tr·ª£ s√°ch v·ªü, nhu y·∫øu ph·∫©m cho h·ªçc sinh v√πng s√¢u v√πng xa do ƒêo√†n Tr∆∞·ªùng t·ªï ch·ª©c.</div>
                <a href="#" class="promo-btn btn-outline-glass">Chung Tay ƒê√≥ng G√≥p</a>
            </div>
        </div>

        <!-- Demo Notice Disclaimer -->
        <div style="margin-top: 50px; margin-bottom: 20px; padding: 25px; text-align: center; background: rgba(255, 255, 255, 0.03); border: 1px dashed rgba(255, 255, 255, 0.2); border-radius: 15px; backdrop-filter: blur(10px);">
            <p style="color: #cbd5e1; font-size: 0.95rem; line-height: 1.8; margin: 0;">
                <span style="display: inline-block; background: rgba(245, 158, 11, 0.2); color: #fbd38d; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85rem; margin-bottom: 10px;">üåü TH√îNG B√ÅO B·∫¢N TH·ª¨ NGHI·ªÜM</span><br>
                ƒê√¢y l√† b·∫£n <strong>Demo</strong>, b·∫°n c√≥ th·ªÉ d√πng th·ª≠ tr·∫£i nghi·ªám c√°c t√≠nh nƒÉng tho·∫£i m√°i. Tuy nhi√™n, h·ªá th·ªëng s·∫Ω b·ªã h·∫°n ch·∫ø m·ªôt ph·∫ßn v·ªÅ kh·∫£ nƒÉng l∆∞u tr·ªØ d·ªØ li·ªáu.<br>
                T√†i kho·∫£n Admin d√πng th·ª≠ - ID: <strong style="color: white; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 6px; letter-spacing: 1px;">0</strong> | Pass: <strong style="color: white; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 6px; letter-spacing: 1px;">0</strong><br>
                <em style="color: #94a3b8; font-size: 0.85rem;">(B√™n trong t√†i kho·∫£n Admin ƒë√£ c√≥ s·∫µn m·ª•c H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng chi ti·∫øt)</em>
            </p>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeImg()">
        <img class="modal-content" id="imgFull">
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal" onclick="closeDetail()">
        <div class="modal-content-text" onclick="event.stopPropagation()">
            <h3><span>üìë</span> N·ªôi Dung Chi Ti·∫øt</h3>
            <p id="fullDetailText"></p>
            <button class="btn-close" onclick="closeDetail()">ƒê√≥ng c·ª≠a s·ªï</button>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div id="qrModal" class="modal" onclick="closeQR()">
        <div class="modal-content" style="text-align: center; max-width: 350px;" onclick="event.stopPropagation()">
            <h3 id="qrTitle" style="margin-bottom: 20px; font-size: 1.2rem;">M√£ QR H·ªçc Sinh</h3>
            <div id="qrcode" style="background: white; padding: 20px; border-radius: 15px; display: inline-block; margin-bottom: 20px;"></div>
            <p id="qrStudentInfo" style="margin-bottom: 20px; font-size: 0.9rem; color: #94a3b8;"></p>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex:1;" onclick="downloadQR()">üì• T·∫£i v·ªÅ</button>
                <button class="btn" style="background: #475569; color: white; flex:1;" onclick="closeQR()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notifyModal" class="notify-modal">
        <div class="notify-content" id="notifyContent">
            <span id="notifyIcon" class="notify-icon"></span>
            <h3 id="notifyTitle" class="notify-title"></h3>
            <p id="notifyMsg" class="notify-msg"></p>
            <button type="button" class="btn btn-primary" onclick="closeNotify()">ƒê·ªìng √Ω</button>
        </div>
    </div>

    <script>
        const API_BASE = ""; // Relative path as it's hosted on the same VPS
        const tableBody = document.getElementById('violationTableBody');
        const studentRankGrid = document.getElementById('studentLeaderboardGrid');
        const classRankGrid = document.getElementById('classLeaderboardGrid');

        let allViolations = [];
        let filteredViolations = [];
        let allStudents = [];
        let violationPage = 1;
        let studentRankPage = 1;
        let classRankPage = 1;
        const pageSize = 5;

        let systemConfig = { status: 'active', expiryDate: '', message: '' };

        async function checkSystemStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/settings`);
                const settings = await response.json();
                
                systemConfig = {
                    status: settings.system_status || 'active',
                    expiryDate: settings.expiry_date || '',
                    message: settings.system_message || ''
                };

                // Update Filter Options
                const vTypes = JSON.parse(settings.violationtypes || '{}');
                const rTypes = JSON.parse(settings.rewardtypes || '{}');
                populateFilterOptions(vTypes, rTypes);

                const today = new Date().toISOString().split('T')[0];
                const isExpired = systemConfig.expiryDate && today > systemConfig.expiryDate;
                const perms = JSON.parse(settings.permissions || '{"admin1":true,"admin2":true,"admin3":true,"admin4":true}');
                const currentRole = sessionStorage.getItem('kyluat_role');
                const isRoleBlocked = currentRole && perms[currentRole] === false;

                if ((isExpired || isRoleBlocked) && currentRole !== 'admin0') {
                    const msg = isRoleBlocked ? "Quy·ªÅn truy c·∫≠p c·ªßa b·∫°n ƒë√£ b·ªã t·∫°m kh√≥a!" : (systemConfig.message || "H·ªá th·ªëng ƒë√£ h·∫øt th·ªùi h·∫°n s·ª≠ d·ª•ng!");
                    document.body.innerHTML = `
                        <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#0f172a; color:white; font-family:'Outfit', sans-serif; text-align:center; padding:20px;">
                            <h1 style="color:#ef4444; font-size:4rem; margin-bottom:20px;">üõë</h1>
                            <h2 style="margin-bottom:10px;">TH√îNG B√ÅO T·ª™ QU·∫¢N TR·ªä VI√äN</h2>
                            <p style="color:#94a3b8; font-size:1.1rem; max-width:500px;">${msg}</p>
                            <button onclick="sessionStorage.clear(); location.reload();" style="margin-top:30px; padding:12px 24px; border-radius:12px; border:none; background:#6366f1; color:white; cursor:pointer;">Th·ª≠ l·∫°i</button>
                        </div>
                    `;
                }
            } catch (err) {
                console.error("Failed to fetch settings", err);
            }
        }

        let socket;
        
        function populateFilterOptions(vTypes, rTypes) {
            const select = document.getElementById('filterType');
            select.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i h√¨nh</option>';
            
            if (Object.keys(vTypes).length > 0) {
                const grp = document.createElement('optgroup');
                grp.label = "‚ö†Ô∏è L·ªói Vi Ph·∫°m";
                Object.values(vTypes).forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.name;
                    opt.textContent = v.name;
                    grp.appendChild(opt);
                });
                select.appendChild(grp);
            }

            if (Object.keys(rTypes).length > 0) {
                const grp = document.createElement('optgroup');
                grp.label = "‚ú® Khen Th∆∞·ªüng";
                Object.values(rTypes).forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.name;
                    opt.textContent = r.name;
                    grp.appendChild(opt);
                });
                const generalReward = document.createElement('option');
                generalReward.value = "Khen th∆∞·ªüng";
                generalReward.textContent = "Khen th∆∞·ªüng (Chung)";
                grp.appendChild(generalReward);
                select.appendChild(grp);
            }
        }

        async function handleLogin() {
            const username = document.getElementById('loginId').value.trim();
            const password = document.getElementById('loginPass').value.trim();

            if (!username || !password) return;

            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    sessionStorage.setItem('kyluat_role', data.role);
                    sessionStorage.setItem('kyluat_id', data.username);
                    sessionStorage.setItem('kyluat_token', data.token);
                    
                    const roleNum = data.role.replace('admin', '');
                    window.location.href = `Kyluat/admin${roleNum}.html`;
                } else {
                    const err = await response.json();
                    showNotify("T·ª´ ch·ªëi truy c·∫≠p", err.error || 'Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!', true);
                }
            } catch (err) {
                showNotify("L·ªói k·∫øt n·ªëi", 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!', true);
            }
        }

        async function initData() {
            // STEP 1: Quick Load from Local Storage Cache & Static Data
            let hasCache = false;
            
            // Render from Static First
            if (typeof STATIC_STUDENTS !== 'undefined') {
                allStudents = [...STATIC_STUDENTS];
                updateDisplay();
            }

            // Render from Cache Second (Usually overrides static)
            const cachedStudents = localStorage.getItem('fb_mock_students_data');
            const cachedHistory = localStorage.getItem('fb_mock_history_data');
            
            if (cachedStudents && cachedHistory) {
                try {
                    const parsedStudents = JSON.parse(cachedStudents);
                    allStudents = parsedStudents.map(val => {
                        return {
                            id: val.id,
                            name: val.name,
                            class: val.class_name,
                            stars: val.stars,
                            photo: `./api/students/${val.id}/photo`
                        };
                    });
                    
                    allViolations = JSON.parse(cachedHistory).map(v => ({
                        studentId: v.student_id,
                        studentName: v.student_name,
                        studentClass: v.class_name,
                        violationType: v.type_name,
                        timestamp: new Date(v.timestamp).getTime(),
                        is_merit: v.is_merit
                    }));

                    updateCountersAndDisplay();
                    hasCache = true;
                } catch(e) { console.warn("Cache parse error", e); }
            }

            // STEP 2: Background Fetch checking for new versions
            try {
                // We fetch /api/students and /api/history. The backend mock will handle "Not Modified" logic
                // and return cached payload instantly if unchanged, or fetch whole thing if changed.
                const [studentsRes, historyRes] = await Promise.all([
                    fetch(`${API_BASE}/api/students`),
                    fetch(`${API_BASE}/api/history`)
                ]);

                if (studentsRes.ok) {
                    const apiStudents = await studentsRes.json();
                    let studentsChanged = JSON.stringify(apiStudents) !== cachedStudents;
                    
                    if (studentsChanged || !hasCache) {
                        allStudents = apiStudents.map(val => ({
                            id: val.id, name: val.name, class: val.class_name, stars: val.stars,
                            photo: `./api/students/${val.id}/photo` 
                        }));
                    }
                }

                if (historyRes.ok) {
                    const apiHistory = await historyRes.json();
                    let historyChanged = JSON.stringify(apiHistory) !== cachedHistory;
                    
                    if (historyChanged || !hasCache) {
                        allViolations = apiHistory.map(v => ({
                            studentId: v.student_id, studentName: v.student_name, studentClass: v.class_name,
                            violationType: v.type_name, timestamp: new Date(v.timestamp).getTime(), is_merit: v.is_merit
                        }));
                    }
                }
                
                // Re-render only if something actually changed over network
                updateCountersAndDisplay();

            } catch (err) {
                console.error("Sync failed", err);
            }
        }

        function updateCountersAndDisplay() {
             const today = new Date().toDateString();
             const todayData = allViolations.filter(v => new Date(v.timestamp).toDateString() === today);
             document.getElementById('todayCount').textContent = todayData.filter(v => !v.is_merit).length;
             document.getElementById('todayMerit').textContent = todayData.filter(v => v.is_merit).length;
             
             updateDisplay();
             applyFilters();
        }

        function updateDisplay() {
            document.getElementById('studentCount').textContent = allStudents.length;
            populateGradeFilter();
            renderStudentLeaderboard();
            renderClassLeaderboard();
            renderTable();
        }

        function populateGradeFilter() {
            const select = document.getElementById('filterClassGrade');
            const currentVal = select.value;
            const grades = new Set();
            
            allStudents.forEach(s => {
                if (s.class) {
                    // L·∫•y c√°c ch·ªØ s·ªë ·ªü ƒë·∫ßu t√™n l·ªõp (VD: "10A1" -> "10", "6A" -> "6")
                    const match = s.class.match(/^\d+/);
                    if (match) grades.add(match[0]);
                }
            });

            const sortedGrades = Array.from(grades).sort((a, b) => parseInt(a) - parseInt(b));
            
            let html = '<option value="">T·∫•t c·∫£ kh·ªëi</option>';
            sortedGrades.forEach(g => {
                html += `<option value="${g}" ${currentVal === g ? 'selected' : ''}>Kh·ªëi ${g}</option>`;
            });
            select.innerHTML = html;
        }

        function handleTimeChange() {
            const timeQ = document.getElementById('filterTime').value;
            const customRange = document.getElementById('customDateRange');
            if (timeQ === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
                applyFilters();
            }
        }

        function applyFilters() {
            const nameQ = document.getElementById('filterName').value.toLowerCase();
            const typeQ = document.getElementById('filterType').value;
            const timeQ = document.getElementById('filterTime').value;

            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const startOfWeek = new Date(now);
            const day = now.getDay();
            const diff = now.getDate() - day + (day === 0 ? -6 : 1); 
            startOfWeek.setDate(diff);
            startOfWeek.setHours(0,0,0,0);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            let customStart = null;
            let customEnd = null;
            if (timeQ === 'custom') {
                const sStr = document.getElementById('filterStartDate').value;
                const eStr = document.getElementById('filterEndDate').value;
                if (sStr) { customStart = new Date(sStr); customStart.setHours(0,0,0,0); }
                if (eStr) { customEnd = new Date(eStr); customEnd.setHours(23,59,59,999); }
            }

            filteredViolations = allViolations.filter(v => {
                const student = allStudents.find(s => s.id === v.studentId);
                if (!student) return false;

                const matchesName = student.name.toLowerCase().includes(nameQ) || 
                                   student.class.toLowerCase().includes(nameQ) || 
                                   v.studentId.toLowerCase().includes(nameQ);
                const matchesType = typeQ === "" ? true : v.violationType.includes(typeQ);
                
                const vDate = new Date(v.timestamp);
                let matchesTime = true;
                if (timeQ === 'today') matchesTime = vDate >= startOfToday;
                else if (timeQ === 'week') matchesTime = vDate >= startOfWeek;
                else if (timeQ === 'month') matchesTime = vDate >= startOfMonth;
                else if (timeQ === 'custom') {
                    if (customStart && vDate < customStart) matchesTime = false;
                    if (customEnd && vDate > customEnd) matchesTime = false;
                }

                return matchesName && matchesType && matchesTime;
            });

            violationPage = 1;
            renderTable();
        }

        function exportFilteredToExcel() {
            if (filteredViolations.length === 0) {
                showNotify("Th√¥ng b√°o", "Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!", true);
                return;
            }

            const excelData = filteredViolations.map(item => {
                const student = allStudents.find(s => s.id === item.studentId);
                const dt = new Date(item.timestamp);
                return {
                    "Th·ªùi gian": dt.toLocaleString('vi-VN'),
                    "M√£ H·ªçc Sinh": item.studentId,
                    "H·ªç T√™n": student ? student.name : "N/A",
                    "L·ªõp": student ? student.class : "N/A",
                    "Lo·∫°i H√¨nh": item.is_merit ? "Khen th∆∞·ªüng" : "Vi ph·∫°m",
                    "N·ªôi dung": item.violationType,
                    "Ng∆∞·ªùi ghi nh·∫≠n": item.adminId || "H·ªá th·ªëng"
                };
            });

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "D·ªØ li·ªáu l·ªçc");
            
            const fileName = `Bao_cao_thi_dua_${new Date().getTime()}.xlsx`;
            XLSX.writeFile(wb, fileName);
            showNotify("Th√†nh c√¥ng", `ƒê√£ xu·∫•t ${filteredViolations.length} d√≤ng d·ªØ li·ªáu ra Excel.`);
        }

        function renderTable() {
            tableBody.innerHTML = '';
            
            if (filteredViolations.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 30px; color: #94a3b8;">Hi·ªán t·∫°i ch∆∞a c√≥ d·ªØ li·ªáu vi ph·∫°m/khen th∆∞·ªüng n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</td></tr>`;
                document.getElementById('violationPagination').innerHTML = '';
                return;
            }

            const start = (violationPage - 1) * pageSize;
            const end = start + pageSize;
            const data = filteredViolations.slice(start, end);

            data.forEach(item => {
                const dt = new Date(item.timestamp);
                const isMerit = item.is_merit;
                const isLong = item.violationType.length > 25;
                const displayText = isLong ? item.violationType.substring(0, 25) + '...' : item.violationType;
                
                const student = allStudents.find(s => s.id === item.studentId);
                const currentName = student ? student.name : (item.studentName || "H·ªçc sinh ƒë√£ b·ªã x√≥a/·∫©n");
                const currentClass = student ? student.class : (item.studentClass || "N/A");
                const currentPhoto = student ? student.photo : "";
                const stars = student ? (student.stars || 0) : 0;
                const starColor = stars <= -10 ? 'danger-text' : (stars >= 10 ? '#10b981' : '#f59e0b');

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="student-info">
                            <img src="${currentPhoto}" class="student-img" loading="lazy" onclick="showImg('${currentPhoto}')" onerror="if(this.src.indexOf('logo.png')==-1){this.src='./logo.png';}else{this.src='';this.style.display='none';}">
                            <div>
                                <p style="font-weight:700; font-size:0.9rem;">${currentName}</p>
                                <p style="font-size:0.7rem; color:#64748b;">ID: ${item.studentId}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:700;">L·ªõp ${currentClass}</span>
                            <span style="font-size:0.75rem; color:${starColor}; font-weight:800;">${stars} ‚≠ê</span>
                        </div>
                    </td>
                    <td>
                        <div class="violation-cell">
                            <span class="${isMerit ? 'status-merit' : 'violation-tag'}">
                                ${isMerit ? '‚ú® ' : '‚ö†Ô∏è '}${displayText}
                            </span>
                            ${isLong ? `<span class="btn-more" onclick="showDetail('${item.violationType.replace(/'/g, "\\'")}')">Chi ti·∫øt</span>` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="text-align:right;">
                            <div style="font-weight:700;">${dt.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})}</div>
                            <div style="color:#64748b; font-size:0.7rem;">${dt.toLocaleDateString('vi-VN')}</div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            renderPagination('violationPagination', filteredViolations.length, violationPage, (p) => { violationPage = p; renderTable(); });
        }

        function renderStudentLeaderboard() {
            const query = document.getElementById('searchRankStudent').value.toLowerCase();
            const sortOrder = document.getElementById('sortRankOrder').value;
            
            let list = [...allStudents];
            list.sort((a, b) => sortOrder === 'desc' ? (b.stars - a.stars) : (a.stars - b.stars));
            
            if (query) {
                list = list.filter(s => s.name.toLowerCase().includes(query) || (s.class && s.class.toLowerCase().includes(query)));
            }

            studentRankGrid.innerHTML = '';
            
            if (list.length === 0) {
                studentRankGrid.innerHTML = `<div style="text-align: center; padding: 30px; color: #94a3b8; width: 100%;">Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o ph√π h·ª£p.</div>`;
                document.getElementById('studentRankPagination').innerHTML = '';
                return;
            }

            const start = (studentRankPage - 1) * pageSize;
            const end = start + pageSize;
            const pagedList = list.slice(start, end);

            pagedList.forEach((s, idx) => {
                const rank = start + idx + 1;
                const card = document.createElement('div');
                card.className = `rank-card ${(sortOrder === 'desc' && rank <= 3) ? 'top-' + rank : ''}`;
                card.style = "width: 100%; justify-content: space-between;"; 
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="rank-number">${rank}</div>
                        <img src="${s.photo}" loading="lazy" style="width:40px; height:40px; border-radius:10px; object-fit:cover;" onclick="showImg('${s.photo}')" onerror="if(this.src.indexOf('logo.png')==-1){this.src='./logo.png';}else{this.src='';this.style.display='none';}">
                        <div>
                            <div style="font-weight:700; display: flex; align-items: center; gap: 8px;">
                                ${s.name} 
                                <span style="cursor: pointer; opacity: 0.7; transition: 0.3s; display: inline-flex;" title="Xem m√£ QR" onclick="showQR('${s.id}', '${s.name}')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                                </span>
                            </div>
                            <div style="font-size: 0.75rem; color:#64748b; font-weight:400;">(ID: ${s.id})</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">L·ªõp ${s.class}</div>
                        </div>
                    </div>
                    <div style="font-weight:800; color:#f59e0b;">${s.stars || 0} ‚≠ê</div>
                `;
                studentRankGrid.appendChild(card);
            });
            renderPagination('studentRankPagination', list.length, studentRankPage, (p) => { studentRankPage = p; renderStudentLeaderboard(); });
        }

        function renderClassLeaderboard() {
            const gradeQ = document.getElementById('filterClassGrade').value;
            const classes = {};
            const classCounts = {};
            
            allStudents.forEach(s => {
                const cls = s.class;
                if (!cls) return;
                
                // Filter by grade if selected
                if (gradeQ && !cls.startsWith(gradeQ)) return;

                classes[cls] = (classes[cls] || 0) + (s.stars || 0);
                classCounts[cls] = (classCounts[cls] || 0) + 1;
            });
            
            const classAvgList = Object.keys(classes).map(name => ({
                name, avg: classes[name] / classCounts[name]
            })).sort((a, b) => b.avg - a.avg);

            classRankGrid.innerHTML = '';
            
            if (classAvgList.length === 0) {
                classRankGrid.innerHTML = `<div style="text-align: center; padding: 30px; color: #94a3b8; width: 100%;">Kh√¥ng c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng l·ªõp.</div>`;
                document.getElementById('classRankPagination').innerHTML = '';
                return;
            }

            const start = (classRankPage - 1) * pageSize;
            const end = start + pageSize;
            const pagedList = classAvgList.slice(start, end);

            pagedList.forEach((item, idx) => {
                const rank = start + idx + 1;
                const card = document.createElement('div');
                card.className = 'class-rank-card';
                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div class="rank-number">${rank}</div>
                        <div style="font-weight:700;">L·ªõp ${item.name}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.7rem; color:#94a3b8;">Trung b√¨nh</div>
                        <div style="font-weight:800; color:var(--primary);">${item.avg.toFixed(2)} ‚≠ê</div>
                    </div>
                `;
                classRankGrid.appendChild(card);
            });
            renderPagination('classRankPagination', classAvgList.length, classRankPage, (p) => { classRankPage = p; renderClassLeaderboard(); });
        }

        function renderPagination(elId, totalCount, current, onPageChange) {
            const el = document.getElementById(elId);
            el.innerHTML = '';
            const totalPages = Math.ceil(totalCount / pageSize);
            if (totalPages <= 1) return;

            const createBtn = (page, text, active = false, disabled = false) => {
                const btn = document.createElement('button');
                btn.className = `page-btn ${active ? 'active' : ''}`;
                btn.innerHTML = text;
                btn.disabled = disabled;
                if (!disabled) {
                    btn.onclick = () => { 
                        onPageChange(page); 
                        el.closest('.card').scrollIntoView({ behavior: 'smooth' }); 
                    };
                }
                return btn;
            };

            // Previous Button
            el.appendChild(createBtn(current - 1, '‚Äπ Tr∆∞·ªõc', false, current === 1));

            // Logic for smart page numbers
            let pages = [];
            if (totalPages <= 7) {
                for (let i = 1; i <= totalPages; i++) pages.push(i);
            } else {
                pages.push(1);
                if (current > 4) pages.push('...');
                
                let start = Math.max(2, current - 1);
                let end = Math.min(totalPages - 1, current + 1);
                
                if (current <= 4) {
                     start = 2;
                     end = 4;
                } else if (current >= totalPages - 3) {
                     start = totalPages - 3;
                     end = totalPages - 1;
                }

                for (let i = start; i <= end; i++) {
                    if (pages.indexOf(i) === -1) pages.push(i);
                }

                if (current < totalPages - 3) pages.push('...');
                if (pages.indexOf(totalPages) === -1) pages.push(totalPages);
            }

            pages.forEach(p => {
                if (p === '...') {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.style.padding = '0 10px';
                    span.style.color = '#94a3b8';
                    el.appendChild(span);
                } else {
                    el.appendChild(createBtn(p, p, p === current));
                }
            });

            // Next Button
            el.appendChild(createBtn(current + 1, 'Sau ‚Ä∫', false, current === totalPages));
        }

        function showDetail(text) {
            document.getElementById('fullDetailText').textContent = text;
            document.getElementById('detailModal').style.display = 'flex';
        }
        function closeDetail() { document.getElementById('detailModal').style.display = 'none'; }
        function showImg(src) {
            if(!src) return;
            document.getElementById('imgFull').src = src;
            document.getElementById('imageModal').style.display = 'flex';
        }
        function closeImg() { document.getElementById('imageModal').style.display = 'none'; }

        // QR Code Logic
        let currentQRId = '';
        let currentQRName = '';

        function showQR(id, name) {
            currentQRId = id;
            currentQRName = name;
            document.getElementById('qrTitle').innerText = `M√£ QR: ${name}`;
            document.getElementById('qrStudentInfo').innerText = `S·ª≠ d·ª•ng m√£ n√†y ƒë·ªÉ qu√©t ƒë·ªãnh danh (ID: ${id})`;
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: id,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            document.getElementById('qrModal').style.display = 'flex';
        }

        function closeQR() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) return;
            const link = document.createElement('a');
            link.download = `QR_${currentQRId}_${currentQRName}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        }

        function showNotify(title, message, isError = false) {
            const modal = document.getElementById('notifyModal');
            const content = document.getElementById('notifyContent');
            const icon = document.getElementById('notifyIcon');
            const titleEl = document.getElementById('notifyTitle');
            const msgEl = document.getElementById('notifyMsg');
            content.className = 'notify-content ' + (isError ? 'notify-error' : 'notify-success');
            icon.innerText = isError ? '‚ö†Ô∏è' : '‚úÖ';
            titleEl.innerText = title;
            msgEl.innerText = message;
            modal.style.display = 'flex';
        }
        function closeNotify() { document.getElementById('notifyModal').style.display = 'none'; }

        function toggleQuickMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('quickMenu');
            menu.classList.toggle('active');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('quickMenu');
            const btn = document.getElementById('widgetBtn');
            if (menu && menu.classList.contains('active') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        function startApp() {
            socket = window.io();
            socket.on('data_changed', () => {
                console.log('Real-time update: Data changed on server. Refreshing...');
                initData();
                checkSystemStatus();
            });
            initData();
            checkSystemStatus();
            setInterval(initData, 30000); // Pulse check every 30s
            setInterval(checkSystemStatus, 60000); // Check lock/expiry every 1m
        }
        
        if (window.firebaseBackendReady) {
            startApp();
        } else {
            window.addEventListener('firebaseBackendReady', startApp);
        }
    </script>
    <!-- Floating Widget -->
    <div class="fixed-widget">
        <div class="widget-menu" id="quickMenu">
            <a href="https://www.facebook.com/profile.php?id=61574230036666" target="_blank" class="widget-item">
                <span>üè´ Facebook Tr∆∞·ªùng</span>
            </a>
            <a href="https://www.facebook.com/profile.php?id=100063627265958" target="_blank" class="widget-item">
                <span>üö© Facebook ƒêo√†n tr∆∞·ªùng</span>
            </a>
            <a href="http://thptso3laocai.laocai.edu.vn" target="_blank" class="widget-item">
                <span>üåê Website Tr∆∞·ªùng</span>
            </a>
        </div>
        <button class="widget-btn" onclick="toggleQuickMenu(event)" id="widgetBtn" title="Li√™n k·∫øt nhanh">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
        </button>
    </div>
</body>
</html>
