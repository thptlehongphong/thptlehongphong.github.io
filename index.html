<!DOCTYPE html><html lang="vi"><head><meta charset="UTF-8"><meta name="viewport" content="width=1100"><title>Theo d√µi r√®n luy·ªán</title><link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet"><script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script><script type="module" src="./firebase-backend.js"></script><script src="student_data.js"></script><meta name="robots" content="noindex, nofollow"><link rel="icon" type="image/png" href="./logo.png"><link rel="shortcut icon" type="image/png" href="./logo.png"><link rel="apple-touch-icon" href="./logo.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-V3BHSCKTST"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-V3BHSCKTST")</script><style>:root{--primary:#6366f1;--secondary:#ec4899;--warning:#f59e0b;--danger:#ef4444;--bg:#0f172a;--glass:rgba(255, 255, 255, 0.05);--glass-border:rgba(255, 255, 255, 0.1)}*{margin:0;padding:0;box-sizing:border-box;font-family:Outfit,sans-serif}body{background:radial-gradient(circle at top right,#1e1b4b,#0f172a);color:#fff;min-height:100vh}.navbar{padding:20px 5%;display:flex;justify-content:space-between;align-items:center;backdrop-filter:blur(10px);border-bottom:1px solid var(--glass-border);position:sticky;top:0;z-index:100}.logo{font-size:1.5rem;font-weight:700;background:linear-gradient(to right,#818cf8,#f472b6);-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}.main-container{padding:40px 5%;max-width:1200px;margin:0 auto}.grid{display:grid;grid-template-columns:1fr 2fr;gap:30px}.card{background:var(--glass);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:24px;padding:30px}.login-section h2{margin-bottom:24px;font-size:1.8rem}.layout-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:40px}.promo-card{background:linear-gradient(145deg,rgba(30,41,59,.8),rgba(15,23,42,.9));border:1px solid rgba(255,255,255,.08);border-radius:20px;padding:25px;position:relative;overflow:hidden;transition:.3s;display:flex;flex-direction:column;height:100%}.promo-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.4);border-color:rgba(99,102,241,.4)}.promo-card.featured{border:1px solid rgba(139,92,246,.4);box-shadow:0 0 20px rgba(139,92,246,.15);background:linear-gradient(145deg,rgba(46,35,76,.8),rgba(15,23,42,.9))}.promo-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:linear-gradient(90deg,#818cf8,#f472b6)}.promo-title{font-size:1.1rem;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:8px}.promo-desc{font-size:.85rem;color:#94a3b8;margin-bottom:20px;line-height:1.6;flex-grow:1}.promo-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:12px;border-radius:12px;font-weight:600;font-size:.9rem;color:#fff;text-decoration:none;transition:.3s;border:1px solid transparent;margin-top:auto}.btn-gradient{background:linear-gradient(135deg,#6366f1,#a855f7)}.btn-gradient:hover{background:linear-gradient(135deg,#4f46e5,#9333ea);box-shadow:0 5px 15px rgba(99,102,241,.3)}.btn-outline-glass{background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.1)}.btn-outline-glass:hover{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2)}.input-group{margin-bottom:20px}.input-group label{display:block;margin-bottom:8px;color:#94a3b8;font-size:.9rem}.input-group input,.input-group select{width:100%;padding:12px 16px;background:#1e293b;border:1px solid var(--glass-border);border-radius:12px;color:#fff;outline:0;transition:.3s;appearance:none;-webkit-appearance:none}.input-group select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;background-size:20px}.input-group select option{background-color:#0f172a;color:#fff}.input-group input:focus{border-color:var(--primary);background:rgba(255,255,255,.08)}.btn{width:100%;padding:14px;border-radius:12px;border:none;font-weight:600;cursor:pointer;transition:.3s;font-size:1rem}.btn-primary{background:var(--primary);color:#fff;box-shadow:0 4px 15px rgba(99,102,241,.3)}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(99,102,241,.4)}.violation-list h2{margin-bottom:20px;display:flex;align-items:center;justify-content:space-between}.live-tag{font-size:.75rem;padding:4px 8px;background:var(--danger);border-radius:20px;animation:pulse 1.5s infinite}@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}.table-container{overflow-x:auto}table{width:100%;border-collapse:collapse;margin-top:10px}th{text-align:left;padding:15px;color:#94a3b8;border-bottom:1px solid var(--glass-border)}td{padding:15px;border-bottom:1px solid rgba(255,255,255,.03)}.student-info{display:flex;align-items:center;gap:12px}.student-img{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid var(--glass-border);cursor:zoom-in;transition:.2s}.student-img:hover{border-color:var(--primary);transform:scale(1.1)}.status-merit,.violation-tag{padding:4px 10px;border-radius:6px;font-size:.8rem;display:inline-block;margin-bottom:4px;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;vertical-align:middle}.violation-tag{background:rgba(239,68,68,.1);color:var(--danger);border:1px solid rgba(239,68,68,.2)}.status-merit{background:rgba(16,185,129,.1);color:#10b981;border:1px solid rgba(16,185,129,.2)}.btn-more{color:var(--primary);font-size:.75rem;cursor:pointer;text-decoration:underline;margin-left:5px;font-weight:600}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;justify-content:center;align-items:center;backdrop-filter:blur(5px)}.modal-content{max-width:90%;max-height:90%;border-radius:20px;border:2px solid var(--primary)}#detailModal{backdrop-filter:blur(10px);background:rgba(15,23,42,.8)}#detailModal .modal-content-text{background:linear-gradient(135deg,#1e293b 0,#0f172a 100%);padding:32px;border-radius:28px;max-width:480px;width:90%;max-height:70vh;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(255,255,255,.1);box-shadow:0 25px 50px -12px rgba(0,0,0,.7);animation:modalSlideUp .4s cubic-bezier(.4,0,.2,1)}@keyframes modalSlideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}#detailModal h3{font-size:1.25rem;font-weight:700;color:#6366f1;margin-bottom:20px;display:flex;align-items:center;gap:10px}#fullDetailText{line-height:1.7;color:#cbd5e1;font-size:1.05rem;text-align:left;overflow-y:auto;padding-right:8px;margin-bottom:24px;white-space:pre-wrap;word-break:break-word}#detailModal .btn-close{background:var(--primary);color:#fff;border:none;padding:12px 0;border-radius:14px;font-weight:600;cursor:pointer;width:100%;transition:.3s}#detailModal .btn-close:hover{transform:translateY(-2px);box-shadow:0 10px 20px -5px rgba(99,102,241,.5)}.nav-login{display:flex;gap:10px;align-items:center}.nav-login input{background:rgba(255,255,255,.05);border:1px solid var(--glass-border);color:#fff;padding:8px 12px;border-radius:8px;font-size:.8rem;width:120px;outline:0}.nav-login input:focus{border-color:var(--primary)}.rank-card{background:rgba(255,255,255,.03);border:1px solid var(--glass-border);border-radius:16px;padding:15px;display:flex;align-items:center;gap:12px;transition:.3s}.rank-card:hover{transform:translateY(-3px);border-color:var(--primary);background:rgba(255,255,255,.06)}.rank-number{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;background:var(--glass-border)}.top-1 .rank-number{background:gold;color:#000}.top-2 .rank-number{background:silver;color:#000}.top-3 .rank-number{background:#cd7f32;color:#000}.pagination{display:flex;justify-content:center;gap:8px;margin-top:25px}.page-btn{padding:8px 14px;background:var(--glass);border:1px solid var(--glass-border);color:#94a3b8;border-radius:8px;cursor:pointer;font-size:.85rem;transition:.3s}.page-btn:hover:not(:disabled){background:rgba(255,255,255,.1);border-color:var(--primary);color:#fff}.page-btn:disabled{opacity:.3;cursor:not-allowed}.page-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}.class-rank-card{background:linear-gradient(135deg,rgba(99,102,241,.1) 0,rgba(236,72,153,.1) 100%);border:1px solid var(--glass-border);padding:20px;border-radius:20px;display:flex;justify-content:space-between;align-items:center}.danger-text{color:var(--danger);font-weight:700;animation:pulse-red 1.5s infinite}@keyframes pulse-red{0%{opacity:1}50%{opacity:.6}100%{opacity:1}}.notify-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(15,23,42,.9);z-index:10000;justify-content:center;align-items:center;backdrop-filter:blur(8px)}.notify-content{background:#1e293b;border:1px solid var(--glass-border);padding:30px;border-radius:24px;max-width:400px;width:90%;text-align:center;box-shadow:0 25px 50px -12px rgba(0,0,0,.5);animation:modalPop .2s ease-out}@keyframes modalPop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}.notify-icon{font-size:40px;margin-bottom:15px;display:block}.notify-title{font-size:1.25rem;font-weight:700;margin-bottom:10px}.notify-msg{color:#cbd5e1;line-height:1.5;margin-bottom:25px;font-size:.95rem}.notify-error .notify-title{color:#ef4444}.notify-success .notify-title{color:#10b981}.fixed-widget{position:fixed;bottom:30px;right:30px;z-index:1000;display:flex;flex-direction:column;align-items:flex-end;gap:15px}.widget-btn{width:55px;height:55px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--secondary));border:none;color:#fff;cursor:pointer;box-shadow:0 8px 32px rgba(99,102,241,.4);display:flex;align-items:center;justify-content:center;transition:.4s cubic-bezier(.175,.885,.32,1.275)}.widget-btn:hover{transform:scale(1.1) rotate(15deg)}.widget-menu{position:absolute;bottom:75px;right:0;background:rgba(30,41,59,.8);backdrop-filter:blur(20px);border:1px solid var(--glass-border);border-radius:20px;padding:12px;min-width:240px;display:none;flex-direction:column;gap:8px;box-shadow:0 15px 45px rgba(0,0,0,.3);animation:slideUp .3s ease-out}@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.widget-menu.active{display:flex}.widget-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:12px;color:#e2e8f0;text-decoration:none;font-size:.9rem;font-weight:500;transition:.2s}.widget-item:hover{background:rgba(255,255,255,.1);color:#fff;transform:translateX(-5px)}.widget-item span{display:inline-block}@media (max-width:768px){.fixed-widget{bottom:20px;right:20px}.widget-btn{width:50px;height:50px}}</style></head><body><nav class="navbar"><div class="logo" style="display:flex;align-items:center;gap:10px"><img src="./logo.png" alt="Logo" style="height:35px;width:auto;border-radius:8px"> THPT L√ä H·ªíNG PHONG</div><div id="navLoginArea" class="nav-login"><input type="text" id="loginId" placeholder="ID"> <input type="password" id="loginPass" placeholder="M·∫≠t kh·∫©u"> <button class="btn-primary" style="width:auto;padding:8px 15px;font-size:.8rem" onclick="handleLogin()">V√†o Qu·∫£n Tr·ªã</button></div><div id="userInfo" style="display:none"></div></nav><div class="main-container"><div class="stats-bar" style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px"><div class="card" style="text-align:center;padding:20px"><p style="color:#94a3b8;font-size:.8rem;margin-bottom:5px">Vi ph·∫°m h√¥m nay</p><h2 id="todayCount" style="color:var(--danger);font-size:2rem">0</h2></div><div class="card" style="text-align:center;padding:20px"><p style="color:#94a3b8;font-size:.8rem;margin-bottom:5px">Khen th∆∞·ªüng h√¥m nay</p><h2 id="todayMerit" style="color:#10b981;font-size:2rem">0</h2></div><div class="card" style="text-align:center;padding:20px"><p style="color:#94a3b8;font-size:.8rem;margin-bottom:5px">S·ªë l∆∞·ª£ng h·ªçc sinh to√†n tr∆∞·ªùng</p><h2 id="studentCount" style="color:var(--primary);font-size:2rem">0</h2></div></div><div class="card" style="margin-bottom:40px;min-height:600px"><div style="display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:25px;border-bottom:1px solid var(--glass-border);padding-bottom:15px;gap:15px"><h2 style="font-size:1.2rem;display:flex;align-items:center;gap:10px;margin:0">üìÖ B·∫£ng Theo Vi ph·∫°m <span class="live-tag" style="font-size:.65rem;padding:2px 6px">Live</span></h2><div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center"><div id="customDateRange" style="display:none;gap:5px;align-items:center"><input type="date" id="filterStartDate" style="padding:6px;border-radius:8px;background:#1e293b;border:1px solid var(--glass-border);color:#fff;font-size:.8rem" onchange="applyFilters()"> <span style="color:#64748b;font-size:.75rem">~</span> <input type="date" id="filterEndDate" style="padding:6px;border-radius:8px;background:#1e293b;border:1px solid var(--glass-border);color:#fff;font-size:.8rem" onchange="applyFilters()"></div><select id="filterTime" style="padding:6px 10px;border-radius:8px;background:#1e293b;border:1px solid var(--glass-border);color:#fff;font-size:.8rem" onchange="handleTimeChange()"><option value="all">Th·ªùi gian</option><option value="today">H√¥m nay</option><option value="week">Tu·∫ßn n√†y</option><option value="month">Th√°ng n√†y</option><option value="custom">T√πy ch·ªânh...</option></select> <select id="filterType" style="padding:6px 10px;border-radius:8px;background:#1e293b;border:1px solid var(--glass-border);color:#fff;font-size:.8rem" onchange="applyFilters()"><option value="">Lo·∫°i h√¨nh</option></select> <input type="text" id="filterName" placeholder="T√¨m t√™n/l·ªõp..." style="width:130px;padding:6px 10px;border-radius:8px;background:#1e293b;border:1px solid var(--glass-border);color:#fff;font-size:.8rem" oninput="applyFilters()"> <button class="btn" style="background:#10b981;color:#fff;padding:4px 10px;border-radius:8px;font-weight:600;font-size:.75rem;display:flex;align-items:center;gap:4px;width:auto;height:auto" onclick="exportFilteredToExcel()"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Excel</button></div></div><div class="table-container"><table><thead><tr><th>H·ªçc Sinh</th><th>L·ªõp</th><th>N·ªôi dung l·ªói / Khen th∆∞·ªüng</th><th>Th·ªùi gian</th></tr></thead><tbody id="violationTableBody"></tbody></table></div><div class="pagination" id="violationPagination"></div></div><div class="card" style="margin-bottom:40px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;border-bottom:1px solid var(--glass-border);padding-bottom:15px"><h2 style="font-size:1.5rem">üëë B·∫£ng X·∫øp H·∫°ng H·ªçc Sinh To√†n Tr∆∞·ªùng</h2><div style="display:flex;gap:15px"><select id="sortRankOrder" style="padding:10px;border-radius:12px;background:#1e293b;border:1px solid var(--glass-border);color:#fff" onchange="renderStudentLeaderboard()"><option value="desc">‚≠ê Th√†nh t√≠ch t·ªët nh·∫•t</option><option value="asc">‚ö†Ô∏è C·∫ßn c·ªë g·∫Øng (T·ª´ th·∫•p l√™n)</option></select> <input type="text" id="searchRankStudent" placeholder="T√¨m t√™n/l·ªõp..." style="width:250px;padding:10px;border-radius:12px;background:#1e293b;border:1px solid var(--glass-border);color:#fff" oninput="renderStudentLeaderboard()"></div></div><div class="leaderboard-list" id="studentLeaderboardGrid" style="display:flex;flex-direction:column;gap:10px"></div><div class="pagination" id="studentRankPagination"></div></div><div class="card"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;border-bottom:1px solid var(--glass-border);padding-bottom:15px"><h2 style="font-size:1.5rem;margin:0">üìä Thi ƒêua Gi·ªØa C√°c Kh·ªëi L·ªõp</h2><select id="filterClassGrade" style="padding:10px;border-radius:12px;background:#1e293b;border:1px solid var(--glass-border);color:#fff;font-size:.9rem" onchange="renderClassLeaderboard()"><option value="">T·∫•t c·∫£ kh·ªëi</option></select></div><div class="leaderboard-list" id="classLeaderboardGrid" style="display:flex;flex-direction:column;gap:10px"></div><div class="pagination" id="classRankPagination"></div></div><h2 style="font-size:1.5rem;margin:40px 0 20px 0;display:flex;align-items:center;gap:10px">üåü G√≥c Th√¥ng Tin & Ti·ªán √çch</h2><div class="layout-grid" style="align-items:stretch"><div class="promo-card featured"><div class="promo-title">üß† Tham V·∫•n T√¢m L√Ω & H∆∞·ªõng Nghi·ªáp</div><div class="promo-desc">Ch∆∞∆°ng tr√¨nh t∆∞ v·∫•n t√¢m l√Ω h·ªçc ƒë∆∞·ªùng chuy√™n s√¢u v√† ƒë·ªãnh h∆∞·ªõng ngh·ªÅ nghi·ªáp s·ªõm, gi√∫p h·ªçc sinh gi·∫£i t·ªèa √°p l·ª±c v√† ph·ª• huynh th·∫•u hi·ªÉu con c√°i.</div><a href="#" class="promo-btn btn-gradient">ƒê·∫∑t L·ªãch T∆∞ V·∫•n</a></div><div class="promo-card" style="border-top-color:#f43f5e"><style>.layout-grid .promo-card:nth-child(2)::before{background:linear-gradient(90deg,#f43f5e,#fb7185)}</style><div class="promo-title">üé® Workshop S√°ng T·∫°o & Tr·∫£i Nghi·ªám</div><div class="promo-desc">Chu·ªói s·ª± ki·ªán gi√°o d·ª•c k·ªπ nƒÉng cu·ªëi tu·∫ßn: Di·ªÖn thuy·∫øt tr∆∞·ªõc ƒë√°m ƒë√¥ng (TEDx Format), tranh bi·ªán (Debate), r√®n luy·ªán t∆∞ duy ph·∫£n bi·ªán.</div><a href="#" class="promo-btn btn-outline-glass">SƒÉn V√© Tham Gia</a></div><div class="promo-card" style="border-top-color:#f59e0b"><style>.layout-grid .promo-card:nth-child(3)::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}</style><div class="promo-title">ü§ù G√¢y Qu·ªπ H·ªçc B·ªïng & Ph·ª•c V·ª• C·ªông ƒê·ªìng</div><div class="promo-desc">Ch∆∞∆°ng tr√¨nh thi·ªán nguy·ªán "M√°i ·∫§m T√¨nh Th∆∞∆°ng": K√™u g·ªçi t√†i tr·ª£ s√°ch v·ªü, nhu y·∫øu ph·∫©m cho h·ªçc sinh v√πng s√¢u v√πng xa do ƒêo√†n Tr∆∞·ªùng t·ªï ch·ª©c.</div><a href="#" class="promo-btn btn-outline-glass">Chung Tay ƒê√≥ng G√≥p</a></div></div><div style="margin-top:50px;margin-bottom:20px;padding:25px;text-align:center;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.2);border-radius:15px;backdrop-filter:blur(10px)"><p style="color:#cbd5e1;font-size:.95rem;line-height:1.8;margin:0"><span style="display:inline-block;background:rgba(245,158,11,.2);color:#fbd38d;padding:4px 12px;border-radius:20px;font-weight:700;font-size:.85rem;margin-bottom:10px">üåü TH√îNG B√ÅO B·∫¢N TH·ª¨ NGHI·ªÜM</span><br>ƒê√¢y l√† b·∫£n <strong>Demo</strong>, b·∫°n c√≥ th·ªÉ d√πng th·ª≠ tr·∫£i nghi·ªám c√°c t√≠nh nƒÉng tho·∫£i m√°i. Tuy nhi√™n, h·ªá th·ªëng s·∫Ω b·ªã h·∫°n ch·∫ø m·ªôt ph·∫ßn v·ªÅ kh·∫£ nƒÉng l∆∞u tr·ªØ d·ªØ li·ªáu.<br>T√†i kho·∫£n Admin d√πng th·ª≠ - ID: <strong style="color:#fff;background:rgba(255,255,255,.1);padding:2px 8px;border-radius:6px;letter-spacing:1px">0</strong> | Pass: <strong style="color:#fff;background:rgba(255,255,255,.1);padding:2px 8px;border-radius:6px;letter-spacing:1px">0</strong><br><em style="color:#94a3b8;font-size:.85rem">(B√™n trong t√†i kho·∫£n Admin ƒë√£ c√≥ s·∫µn m·ª•c H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng chi ti·∫øt)</em></p></div></div><div id="imageModal" class="modal" onclick="closeImg()"><img class="modal-content" id="imgFull"></div><div id="detailModal" class="modal" onclick="closeDetail()"><div class="modal-content-text" onclick="event.stopPropagation()"><h3><span>üìë</span> N·ªôi Dung Chi Ti·∫øt</h3><p id="fullDetailText"></p><button class="btn-close" onclick="closeDetail()">ƒê√≥ng c·ª≠a s·ªï</button></div></div><div id="qrModal" class="modal" onclick="closeQR()"><div class="modal-content" style="text-align:center;max-width:350px" onclick="event.stopPropagation()"><h3 id="qrTitle" style="margin-bottom:20px;font-size:1.2rem">M√£ QR H·ªçc Sinh</h3><div id="qrcode" style="background:#fff;padding:20px;border-radius:15px;display:inline-block;margin-bottom:20px"></div><p id="qrStudentInfo" style="margin-bottom:20px;font-size:.9rem;color:#94a3b8"></p><div style="display:flex;gap:10px"><button class="btn btn-primary" style="flex:1" onclick="downloadQR()">üì• T·∫£i v·ªÅ</button> <button class="btn" style="background:#475569;color:#fff;flex:1" onclick="closeQR()">ƒê√≥ng</button></div></div></div><div id="notifyModal" class="notify-modal"><div class="notify-content" id="notifyContent"><span id="notifyIcon" class="notify-icon"></span><h3 id="notifyTitle" class="notify-title"></h3><p id="notifyMsg" class="notify-msg"></p><button type="button" class="btn btn-primary" onclick="closeNotify()">ƒê·ªìng √Ω</button></div></div><script>let API_BASE="",tableBody=document.getElementById("violationTableBody"),studentRankGrid=document.getElementById("studentLeaderboardGrid"),classRankGrid=document.getElementById("classLeaderboardGrid"),allViolations=[],filteredViolations=[],allStudents=[],violationPage=1,studentRankPage=1,classRankPage=1,pageSize=5,systemConfig={status:"active",expiryDate:"",message:""};async function checkSystemStatus(){try{var e,t=await(await fetch(API_BASE+"/api/settings")).json(),n=(systemConfig={status:t.system_status||"active",expiryDate:t.expiry_date||"",message:t.system_message||""},JSON.parse(t.violationtypes||"{}")),a=(populateFilterOptions(n,JSON.parse(t.rewardtypes||"{}")),(new Date).toISOString().split("T")[0]),i=systemConfig.expiryDate&&a>systemConfig.expiryDate,o=JSON.parse(t.permissions||'{"admin1":true,"admin2":true,"admin3":true,"admin4":true}'),s=sessionStorage.getItem("kyluat_role"),l=s&&!1===o[s];(i||l)&&"admin0"!==s&&(e=l?"Quy·ªÅn truy c·∫≠p c·ªßa b·∫°n ƒë√£ b·ªã t·∫°m kh√≥a!":systemConfig.message||"H·ªá th·ªëng ƒë√£ h·∫øt th·ªùi h·∫°n s·ª≠ d·ª•ng!",document.body.innerHTML=`
                        <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#0f172a; color:white; font-family:'Outfit', sans-serif; text-align:center; padding:20px;">
                            <h1 style="color:#ef4444; font-size:4rem; margin-bottom:20px;">üõë</h1>
                            <h2 style="margin-bottom:10px;">TH√îNG B√ÅO T·ª™ QU·∫¢N TR·ªä VI√äN</h2>
                            <p style="color:#94a3b8; font-size:1.1rem; max-width:500px;">${e}</p>
                            <button onclick="sessionStorage.clear(); location.reload();" style="margin-top:30px; padding:12px 24px; border-radius:12px; border:none; background:#6366f1; color:white; cursor:pointer;">Th·ª≠ l·∫°i</button>
                        </div>
                    `)}catch(e){console.error("Failed to fetch settings",e)}}let socket;function populateFilterOptions(e,t){var a=document.getElementById("filterType");if(a.innerHTML='<option value="">T·∫•t c·∫£ lo·∫°i h√¨nh</option>',0<Object.keys(e).length){let n=document.createElement("optgroup");n.label="‚ö†Ô∏è L·ªói Vi Ph·∫°m",Object.values(e).forEach(e=>{var t=document.createElement("option");t.value=e.name,t.textContent=e.name,n.appendChild(t)}),a.appendChild(n)}if(0<Object.keys(t).length){let n=document.createElement("optgroup");n.label="‚ú® Khen Th∆∞·ªüng",Object.values(t).forEach(e=>{var t=document.createElement("option");t.value=e.name,t.textContent=e.name,n.appendChild(t)});e=document.createElement("option");e.value="Khen th∆∞·ªüng",e.textContent="Khen th∆∞·ªüng (Chung)",n.appendChild(e),a.appendChild(n)}}async function handleLogin(){var e=document.getElementById("loginId").value.trim(),t=document.getElementById("loginPass").value.trim();if(e&&t)try{var n,a,i=await fetch(API_BASE+"/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,password:t})});i.ok?(n=await i.json(),sessionStorage.setItem("kyluat_role",n.role),sessionStorage.setItem("kyluat_id",n.username),sessionStorage.setItem("kyluat_token",n.token),a=n.role.replace("admin",""),window.location.href=`Kyluat/admin${a}.html`):showNotify("T·ª´ ch·ªëi truy c·∫≠p",(await i.json()).error||"Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!",!0)}catch(e){showNotify("L·ªói k·∫øt n·ªëi","Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß!",!0)}}async function initData(){let e=!1;"undefined"!=typeof STATIC_STUDENTS&&(allStudents=[...STATIC_STUDENTS],updateDisplay());var t=localStorage.getItem("fb_mock_students_data"),n=localStorage.getItem("fb_mock_history_data");if(t&&n)try{var a=JSON.parse(t);allStudents=a.map(e=>({id:e.id,name:e.name,class:e.class_name,stars:e.stars,photo:`./api/students/${e.id}/photo`})),allViolations=JSON.parse(n).map(e=>({studentId:e.student_id,studentName:e.student_name,studentClass:e.class_name,violationType:e.type_name,timestamp:new Date(e.timestamp).getTime(),is_merit:e.is_merit})),updateCountersAndDisplay(),e=!0}catch(e){console.warn("Cache parse error",e)}try{var i,o,[s,l]=await Promise.all([fetch(API_BASE+"/api/students"),fetch(API_BASE+"/api/history")]);s.ok&&(i=await s.json(),JSON.stringify(i)===t&&e||(allStudents=i.map(e=>({id:e.id,name:e.name,class:e.class_name,stars:e.stars,photo:`./api/students/${e.id}/photo`})))),l.ok&&(o=await l.json(),JSON.stringify(o)===n&&e||(allViolations=o.map(e=>({studentId:e.student_id,studentName:e.student_name,studentClass:e.class_name,violationType:e.type_name,timestamp:new Date(e.timestamp).getTime(),is_merit:e.is_merit})))),updateCountersAndDisplay()}catch(e){console.error("Sync failed",e)}}function updateCountersAndDisplay(){let t=(new Date).toDateString();var e=allViolations.filter(e=>new Date(e.timestamp).toDateString()===t);document.getElementById("todayCount").textContent=e.filter(e=>!e.is_merit).length,document.getElementById("todayMerit").textContent=e.filter(e=>e.is_merit).length,updateDisplay(),applyFilters()}function updateDisplay(){document.getElementById("studentCount").textContent=allStudents.length,populateGradeFilter(),renderStudentLeaderboard(),renderClassLeaderboard(),renderTable()}function populateGradeFilter(){var e=document.getElementById("filterClassGrade");let t=e.value,n=new Set;allStudents.forEach(e=>{e.class&&(e=e.class.match(/^\d+/))&&n.add(e[0])});var a=Array.from(n).sort((e,t)=>parseInt(e)-parseInt(t));let i='<option value="">T·∫•t c·∫£ kh·ªëi</option>';a.forEach(e=>{i+=`<option value="${e}" ${t===e?"selected":""}>Kh·ªëi ${e}</option>`}),e.innerHTML=i}function handleTimeChange(){var e=document.getElementById("filterTime").value,t=document.getElementById("customDateRange");"custom"===e?t.style.display="flex":(t.style.display="none",applyFilters())}function applyFilters(){let o=document.getElementById("filterName").value.toLowerCase(),s=document.getElementById("filterType").value,l=document.getElementById("filterTime").value;var e=new Date;let d=new Date(e.getFullYear(),e.getMonth(),e.getDate()),r=new Date(e);var t=e.getDay(),t=e.getDate()-t+(0===t?-6:1);r.setDate(t),r.setHours(0,0,0,0);let c=new Date(e.getFullYear(),e.getMonth(),1),m=null,u=null;"custom"===l&&(t=document.getElementById("filterStartDate").value,e=document.getElementById("filterEndDate").value,t&&(m=new Date(t)).setHours(0,0,0,0),e)&&(u=new Date(e)).setHours(23,59,59,999),filteredViolations=allViolations.filter(t=>{var e=allStudents.find(e=>e.id===t.studentId);if(!e)return!1;var e=e.name.toLowerCase().includes(o)||e.class.toLowerCase().includes(o)||t.studentId.toLowerCase().includes(o),n=""===s||t.violationType.includes(s),a=new Date(t.timestamp);let i=!0;return"today"===l?i=a>=d:"week"===l?i=a>=r:"month"===l?i=a>=c:"custom"===l&&(m&&a<m&&(i=!1),u)&&a>u&&(i=!1),e&&n&&i}),violationPage=1,renderTable()}function exportFilteredToExcel(){var e,t;0===filteredViolations.length?showNotify("Th√¥ng b√°o","Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!",!0):(t=filteredViolations.map(t=>{var e=allStudents.find(e=>e.id===t.studentId);return{"Th·ªùi gian":new Date(t.timestamp).toLocaleString("vi-VN"),"M√£ H·ªçc Sinh":t.studentId,"H·ªç T√™n":e?e.name:"N/A","L·ªõp":e?e.class:"N/A","Lo·∫°i H√¨nh":t.is_merit?"Khen th∆∞·ªüng":"Vi ph·∫°m","N·ªôi dung":t.violationType,"Ng∆∞·ªùi ghi nh·∫≠n":t.adminId||"H·ªá th·ªëng"}}),t=XLSX.utils.json_to_sheet(t),e=XLSX.utils.book_new(),XLSX.utils.book_append_sheet(e,t,"D·ªØ li·ªáu l·ªçc"),t=`Bao_cao_thi_dua_${(new Date).getTime()}.xlsx`,XLSX.writeFile(e,t),showNotify("Th√†nh c√¥ng",`ƒê√£ xu·∫•t ${filteredViolations.length} d√≤ng d·ªØ li·ªáu ra Excel.`))}function renderTable(){var e,t;tableBody.innerHTML="",0===filteredViolations.length?(tableBody.innerHTML='<tr><td colspan="4" style="text-align: center; padding: 30px; color: #94a3b8;">Hi·ªán t·∫°i ch∆∞a c√≥ d·ªØ li·ªáu vi ph·∫°m/khen th∆∞·ªüng n√†o ph√π h·ª£p v·ªõi b·ªô l·ªçc.</td></tr>',document.getElementById("violationPagination").innerHTML=""):(t=(e=(violationPage-1)*pageSize)+pageSize,filteredViolations.slice(e,t).forEach(t=>{var e=new Date(t.timestamp),n=t.is_merit,a=25<t.violationType.length,i=a?t.violationType.substring(0,25)+"...":t.violationType,o=allStudents.find(e=>e.id===t.studentId),s=o?o.name:t.studentName||"H·ªçc sinh ƒë√£ b·ªã x√≥a/·∫©n",l=o?o.class:t.studentClass||"N/A",d=o?o.photo:"",o=o&&o.stars||0,r=o<=-10?"danger-text":10<=o?"#10b981":"#f59e0b",c=document.createElement("tr");c.innerHTML=`
                    <td>
                        <div class="student-info">
                            <img src="${d}" class="student-img" loading="lazy" onclick="showImg('${d}')" onerror="if(this.src.indexOf('logo.png')==-1){this.src='./logo.png';}else{this.src='';this.style.display='none';}">
                            <div>
                                <p style="font-weight:700; font-size:0.9rem;">${s}</p>
                                <p style="font-size:0.7rem; color:#64748b;">ID: ${t.studentId}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="display:flex; flex-direction:column;">
                            <span style="font-weight:700;">L·ªõp ${l}</span>
                            <span style="font-size:0.75rem; color:${r}; font-weight:800;">${o} ‚≠ê</span>
                        </div>
                    </td>
                    <td>
                        <div class="violation-cell">
                            <span class="${n?"status-merit":"violation-tag"}">
                                ${n?"‚ú® ":"‚ö†Ô∏è "}${i}
                            </span>
                            ${a?`<span class="btn-more" onclick="showDetail('${t.violationType.replace(/'/g,"\\'")}')">Chi ti·∫øt</span>`:""}
                        </div>
                    </td>
                    <td>
                        <div style="text-align:right;">
                            <div style="font-weight:700;">${e.toLocaleTimeString("vi-VN",{hour:"2-digit",minute:"2-digit"})}</div>
                            <div style="color:#64748b; font-size:0.7rem;">${e.toLocaleDateString("vi-VN")}</div>
                        </div>
                    </td>
                `,tableBody.appendChild(c)}),renderPagination("violationPagination",filteredViolations.length,violationPage,e=>{violationPage=e,renderTable()}))}function renderStudentLeaderboard(){let t=document.getElementById("searchRankStudent").value.toLowerCase(),i=document.getElementById("sortRankOrder").value,e=[...allStudents];if(e.sort((e,t)=>"desc"===i?t.stars-e.stars:e.stars-t.stars),t&&(e=e.filter(e=>e.name.toLowerCase().includes(t)||e.class&&e.class.toLowerCase().includes(t))),studentRankGrid.innerHTML="",0===e.length)studentRankGrid.innerHTML='<div style="text-align: center; padding: 30px; color: #94a3b8; width: 100%;">Kh√¥ng t√¨m th·∫•y h·ªçc sinh n√†o ph√π h·ª£p.</div>',document.getElementById("studentRankPagination").innerHTML="";else{let a=(studentRankPage-1)*pageSize;var n=a+pageSize;e.slice(a,n).forEach((e,t)=>{var t=a+t+1,n=document.createElement("div");n.className="rank-card "+("desc"===i&&t<=3?"top-"+t:""),n.style="width: 100%; justify-content: space-between;",n.innerHTML=`
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="rank-number">${t}</div>
                        <img src="${e.photo}" loading="lazy" style="width:40px; height:40px; border-radius:10px; object-fit:cover;" onclick="showImg('${e.photo}')" onerror="if(this.src.indexOf('logo.png')==-1){this.src='./logo.png';}else{this.src='';this.style.display='none';}">
                        <div>
                            <div style="font-weight:700; display: flex; align-items: center; gap: 8px;">
                                ${e.name} 
                                <span style="cursor: pointer; opacity: 0.7; transition: 0.3s; display: inline-flex;" title="Xem m√£ QR" onclick="showQR('${e.id}', '${e.name}')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                                </span>
                            </div>
                            <div style="font-size: 0.75rem; color:#64748b; font-weight:400;">(ID: ${e.id})</div>
                            <div style="font-size:0.8rem; color:#94a3b8;">L·ªõp ${e.class}</div>
                        </div>
                    </div>
                    <div style="font-weight:800; color:#f59e0b;">${e.stars||0} ‚≠ê</div>
                `,studentRankGrid.appendChild(n)}),renderPagination("studentRankPagination",e.length,studentRankPage,e=>{studentRankPage=e,renderStudentLeaderboard()})}}function renderClassLeaderboard(){let n=document.getElementById("filterClassGrade").value,a={},i={};allStudents.forEach(e=>{var t=e.class;!t||n&&!t.startsWith(n)||(a[t]=(a[t]||0)+(e.stars||0),i[t]=(i[t]||0)+1)});var e=Object.keys(a).map(e=>({name:e,avg:a[e]/i[e]})).sort((e,t)=>t.avg-e.avg);if(classRankGrid.innerHTML="",0===e.length)classRankGrid.innerHTML='<div style="text-align: center; padding: 30px; color: #94a3b8; width: 100%;">Kh√¥ng c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng l·ªõp.</div>',document.getElementById("classRankPagination").innerHTML="";else{let a=(classRankPage-1)*pageSize;var t=a+pageSize;e.slice(a,t).forEach((e,t)=>{var t=a+t+1,n=document.createElement("div");n.className="class-rank-card",n.innerHTML=`
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div class="rank-number">${t}</div>
                        <div style="font-weight:700;">L·ªõp ${e.name}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.7rem; color:#94a3b8;">Trung b√¨nh</div>
                        <div style="font-weight:800; color:var(--primary);">${e.avg.toFixed(2)} ‚≠ê</div>
                    </div>
                `,classRankGrid.appendChild(n)}),renderPagination("classRankPagination",e.length,classRankPage,e=>{classRankPage=e,renderClassLeaderboard()})}}function renderPagination(e,t,a,o){let s=document.getElementById(e);s.innerHTML="";var i=Math.ceil(t/pageSize);if(!(i<=1)){let n=(e,t,n=!1,a=!1)=>{var i=document.createElement("button");return i.className="page-btn "+(n?"active":""),i.innerHTML=t,(i.disabled=a)||(i.onclick=()=>{o(e),s.closest(".card").scrollIntoView({behavior:"smooth"})}),i};s.appendChild(n(a-1,"‚Äπ Tr∆∞·ªõc",!1,1===a));var l=[];if(i<=7)for(let e=1;e<=i;e++)l.push(e);else{l.push(1),4<a&&l.push("...");let t=Math.max(2,a-1),n=Math.min(i-1,a+1);a<=4?(t=2,n=4):i-3<=a&&(t=i-3,n=i-1);for(let e=t;e<=n;e++)-1===l.indexOf(e)&&l.push(e);a<i-3&&l.push("..."),-1===l.indexOf(i)&&l.push(i)}l.forEach(e=>{var t;"..."===e?((t=document.createElement("span")).textContent="...",t.style.padding="0 10px",t.style.color="#94a3b8",s.appendChild(t)):s.appendChild(n(e,e,e===a))}),s.appendChild(n(a+1,"Sau ‚Ä∫",!1,a===i))}}function showDetail(e){document.getElementById("fullDetailText").textContent=e,document.getElementById("detailModal").style.display="flex"}function closeDetail(){document.getElementById("detailModal").style.display="none"}function showImg(e){e&&(document.getElementById("imgFull").src=e,document.getElementById("imageModal").style.display="flex")}function closeImg(){document.getElementById("imageModal").style.display="none"}let currentQRId="",currentQRName="";function showQR(e,t){currentQRId=e,currentQRName=t,document.getElementById("qrTitle").innerText="M√£ QR: "+t,document.getElementById("qrStudentInfo").innerText=`S·ª≠ d·ª•ng m√£ n√†y ƒë·ªÉ qu√©t ƒë·ªãnh danh (ID: ${e})`;t=document.getElementById("qrcode");t.innerHTML="",new QRCode(t,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H}),document.getElementById("qrModal").style.display="flex"}function closeQR(){document.getElementById("qrModal").style.display="none"}function downloadQR(){var e,t=document.querySelector("#qrcode canvas");t&&((e=document.createElement("a")).download=`QR_${currentQRId}_${currentQRName}.png`,e.href=t.toDataURL("image/png"),e.click())}function showNotify(e,t,n=!1){var a=document.getElementById("notifyModal"),i=document.getElementById("notifyContent"),o=document.getElementById("notifyIcon"),s=document.getElementById("notifyTitle"),l=document.getElementById("notifyMsg");i.className="notify-content "+(n?"notify-error":"notify-success"),o.innerText=n?"‚ö†Ô∏è":"‚úÖ",s.innerText=e,l.innerText=t,a.style.display="flex"}function closeNotify(){document.getElementById("notifyModal").style.display="none"}function toggleQuickMenu(e){e.stopPropagation(),document.getElementById("quickMenu").classList.toggle("active")}function startApp(){(socket=window.io()).on("data_changed",()=>{console.log("Real-time update: Data changed on server. Refreshing..."),initData(),checkSystemStatus()}),initData(),checkSystemStatus(),setInterval(initData,3e4),setInterval(checkSystemStatus,6e4)}document.addEventListener("click",e=>{var t=document.getElementById("quickMenu"),n=document.getElementById("widgetBtn");t&&t.classList.contains("active")&&!t.contains(e.target)&&!n.contains(e.target)&&t.classList.remove("active")}),window.firebaseBackendReady?startApp():window.addEventListener("firebaseBackendReady",startApp)</script><div class="fixed-widget"><div class="widget-menu" id="quickMenu"><a href="https://www.facebook.com/profile.php?id=61574230036666" target="_blank" class="widget-item"><span>üè´ Facebook Tr∆∞·ªùng</span> </a><a href="https://www.facebook.com/profile.php?id=100063627265958" target="_blank" class="widget-item"><span>üö© Facebook ƒêo√†n tr∆∞·ªùng</span> </a><a href="http://thptso3laocai.laocai.edu.vn" target="_blank" class="widget-item"><span>üåê Website Tr∆∞·ªùng</span></a></div><button class="widget-btn" onclick="toggleQuickMenu(event)" id="widgetBtn" title="Li√™n k·∫øt nhanh"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg></button></div></body></html>